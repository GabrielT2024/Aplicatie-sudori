<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestiune Sudori ‚Äì ASME Sec IX / ISCIR CR9-CR7</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#f4f6fb;
      --card:#ffffff;
      --card-border:#d8e0f2;
      --muted:#65708b;
      --text:#1f2a3d;
      --accent:#3a7afe;
      --accent-strong:#255ee9;
      --ok:#1a9b6f;
      --warn:#d28a00;
      --bad:#d94a4a;
      --table-alt:#f7f9ff;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(180deg,#f8faff,#eef3fb 40%,var(--bg));
      color:var(--text);
      min-height:100vh;
    }
    body.auth-locked{ overflow:hidden; }
    .app-shell{
      display:flex;
      min-height:100vh;
      width:100%;
    }
    .sidebar{
      width:240px;
      background:linear-gradient(180deg,#4f5f7f 0%,#394763 55%,#2c364d 100%);
      color:#f4f8ff;
      display:flex;
      flex-direction:column;
      padding:28px 16px;
      gap:16px;
      box-shadow:inset -1px 0 0 rgba(255,255,255,.08);
    }
    .sidebar-header{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .sidebar-title{
      font-size:18px;
      font-weight:700;
      letter-spacing:.4px;
    }
    .sidebar-subtitle{
      font-size:12px;
      opacity:.8;
    }
    .sidebar-nav{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:16px;
    }
    .nav-button{
      appearance:none;
      border:none;
      border-radius:18px;
      padding:16px 12px;
      background:rgba(255,255,255,.06);
      color:inherit;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-weight:600;
      cursor:pointer;
      transition:background .2s, transform .2s, box-shadow .2s;
      text-align:center;
      min-height:84px;
    }
    .nav-button .icon{
      font-size:28px;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      background:rgba(0,0,0,.08);
      box-shadow:inset 0 2px 4px rgba(0,0,0,.18);
    }
    .nav-button span:last-child{
      font-size:12px;
      line-height:1.3;
      letter-spacing:.3px;
    }
    .nav-button:hover{
      background:rgba(255,255,255,.16);
      transform:translateY(-1px);
      box-shadow:0 8px 18px rgba(0,0,0,.22);
    }
    .nav-button.active{
      background:rgba(255,255,255,.28);
      color:#fff;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.35), 0 10px 22px rgba(15,35,68,.32);
    }
    .nav-button.active .icon{
      background:rgba(255,255,255,.22);
      box-shadow:inset 0 2px 4px rgba(255,255,255,.45);
    }
    .sidebar-footer{
      margin-top:auto;
      font-size:11px;
      opacity:.7;
      line-height:1.4;
    }
    .workspace{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }
    .topbar{ 
      padding:18px 24px;
      border-bottom:1px solid var(--card-border);
      background:rgba(255,255,255,.9);
      backdrop-filter:saturate(140%) blur(8px);
      display:flex;
      gap:18px;
      align-items:center;
      z-index:10;
      box-shadow:0 6px 18px rgba(32,56,104,.08);
      position:sticky;
      top:0;
    }
    .topbar h1{ font-size:18px; margin:0; letter-spacing:.3px; color:var(--text); }
    .topbar-brand{ display:flex; align-items:center; gap:14px; }
    .company-logo{
      max-width:140px;
      max-height:80px;
      width:auto;
      height:auto;
      border-radius:16px;
      object-fit:contain;
      border:1px solid rgba(37,94,233,.18);
      background:#fff;
      padding:6px;
      display:none;
    }
    .company-logo.visible{ display:block; }
    .topbar .pill{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      background:#e7ecfb;
      color:#255ee9;
      border:1px solid #c9d5f7;
    }
    .topbar .title-stack{ display:flex; flex-direction:column; gap:6px; }
    .topbar-actions{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .company-select{ display:flex; flex-direction:column; gap:4px; font-size:12px; color:var(--muted); }
    .company-select select{ min-width:200px; }
    main{ flex:1; padding:24px 32px 32px; }
    .content-inner{ width:100%; display:flex; flex-direction:column; gap:28px; }
    .view{ display:none; }
    .view.active{ display:block; }
    .hidden{ display:none !important; }

    .selection-hub{ display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:18px; }
    .selection-card{ border:1px solid rgba(255,255,255,.18); border-radius:18px; padding:24px; background:linear-gradient(145deg, rgba(255,255,255,.75), rgba(231,237,255,.85)); box-shadow:0 14px 28px rgba(35,56,104,.12); display:flex; flex-direction:column; align-items:flex-start; gap:12px; cursor:pointer; transition:transform .2s, box-shadow .2s; position:relative; overflow:hidden; }
    .selection-card::after{ content:''; position:absolute; inset:0; pointer-events:none; border-radius:inherit; background:linear-gradient(160deg, rgba(58,122,254,.18), transparent 55%); opacity:0; transition:opacity .2s; }
    .selection-card:hover{ transform:translateY(-4px); box-shadow:0 18px 36px rgba(35,56,104,.16); }
    .selection-card:hover::after{ opacity:1; }
    .selection-card .icon{ width:56px; height:56px; border-radius:16px; background:rgba(58,122,254,.12); display:flex; align-items:center; justify-content:center; font-size:26px; color:#255ee9; box-shadow:inset 0 2px 6px rgba(37,94,233,.18); }
    .selection-card h3{ margin:0; font-size:18px; letter-spacing:.2px; }
    .selection-card p{ margin:0; font-size:13px; color:#6f7c99; }

    .subview-header{ display:flex; align-items:center; gap:12px; margin-bottom:18px; flex-wrap:wrap; }
    .subview-header h2{ margin:0; flex:1; font-size:20px; letter-spacing:.2px; }
    .back-link{ appearance:none; border:none; background:none; color:#3a7afe; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; font-size:13px; padding:6px 10px; border-radius:12px; transition:background .2s; }
    .back-link:hover{ background:rgba(58,122,254,.12); }

    .welder-table-tools{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:16px; }
    .welder-table-tools .search-box{ flex:1 1 220px; }
    .welder-table-tools .actions{ display:flex; gap:10px; }

    .welder-overview table{ width:100%; border-collapse:collapse; }
    .welder-overview thead th{ background:#ecf1ff; color:#2b3b63; font-size:12px; letter-spacing:.2px; text-transform:uppercase; padding:12px; border-bottom:1px solid #d8e0f2; }
    .welder-overview tbody td{ padding:12px; border-bottom:1px solid #e3e9f8; font-size:13px; vertical-align:top; }
    .welder-overview tbody tr:nth-child(odd){ background:#f7f9ff; }
    .welder-overview tbody tr.selected{ background:#e0e8ff !important; box-shadow:inset 0 0 0 2px rgba(58,122,254,.35); }
    .welder-name-link{ color:#255ee9; font-weight:600; text-decoration:none; }
    .welder-name-link:hover{ text-decoration:underline; }
    .qualifications-summary{ display:flex; flex-wrap:wrap; gap:8px; }
    .process-summary{ display:flex; flex-wrap:wrap; gap:8px; }
    .process-chip{ background:#f1f4ff; color:#2f55d4; border-radius:999px; padding:4px 10px; font-size:11px; font-weight:600; letter-spacing:.3px; }
    .status-chip{ border-radius:999px; padding:4px 10px; font-size:11px; font-weight:600; letter-spacing:.3px; display:inline-flex; align-items:center; gap:6px; }
    .status-chip.ok{ background:rgba(26,155,111,.12); color:#137953; border:1px solid rgba(26,155,111,.4); }
    .status-chip.warn{ background:rgba(210,138,0,.14); color:#985b00; border:1px solid rgba(210,138,0,.38); }
    .status-chip.bad{ background:rgba(217,74,74,.14); color:#a52a2a; border:1px solid rgba(217,74,74,.38); }
    .status-chip .dot{ width:8px; height:8px; border-radius:50%; background:currentColor; opacity:.55; }

    .modal{ position:fixed; inset:0; background:rgba(19,28,49,.58); display:none; align-items:center; justify-content:center; padding:32px; z-index:1000; }
    .modal.open{ display:flex; }
    .modal-dialog{ background:#ffffff; border-radius:20px; width:min(820px, 96vw); max-height:94vh; overflow-y:auto; box-shadow:0 24px 48px rgba(18,32,68,.28); position:relative; padding:28px 32px; }
    .modal-close{ position:absolute; top:16px; right:16px; border:none; background:rgba(58,122,254,.1); color:#2b3b63; width:32px; height:32px; border-radius:999px; cursor:pointer; font-size:18px; font-weight:700; display:flex; align-items:center; justify-content:center; }
    .modal-close:hover{ background:rgba(58,122,254,.2); }
    .modal-dialog h2{ margin-top:0; }

    .auth-overlay{ position:fixed; inset:0; background:rgba(17,26,44,.82); display:flex; align-items:center; justify-content:center; padding:32px; z-index:2000; }
    .auth-overlay.hidden{ display:none; }
    .auth-card{ width:min(420px, 92vw); background:#fdfdff; border-radius:22px; padding:32px; box-shadow:0 32px 64px rgba(9,18,38,.45); display:flex; flex-direction:column; gap:18px; }
    .auth-card h2{ margin:0; font-size:22px; letter-spacing:.4px; color:#1e2b46; }
    .auth-card p{ margin:0; font-size:13px; color:#5f6c87; }
    .auth-card form{ display:flex; flex-direction:column; gap:14px; }
    .auth-card label{ font-size:12px; font-weight:600; color:#1e2b46; letter-spacing:.3px; }
    .auth-card input{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(48,68,112,.2); font-size:14px; }
    .auth-card button{ appearance:none; border:none; border-radius:14px; padding:12px 16px; background:#3a7afe; color:#fff; font-weight:600; font-size:14px; cursor:pointer; box-shadow:0 12px 24px rgba(58,122,254,.32); transition:background .2s, transform .2s; }
    .auth-card button:hover{ background:#255ee9; transform:translateY(-1px); }
    .auth-error{ background:rgba(217,74,74,.12); color:#a52a2a; border:1px solid rgba(217,74,74,.28); padding:10px 12px; border-radius:12px; font-size:12px; display:none; }
    .auth-error.visible{ display:block; }
    .auth-notice{ font-size:12px; color:#f7f9ff; background:rgba(37,94,233,.25); border:1px solid rgba(58,122,254,.35); padding:10px 12px; border-radius:12px; display:none; }
    .auth-notice.visible{ display:block; }

    .icon-button{ appearance:none; border:none; background:rgba(58,122,254,.12); color:#255ee9; width:36px; height:36px; border-radius:999px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:background .2s, transform .2s; }
    .icon-button:hover{ background:rgba(58,122,254,.22); transform:translateY(-1px); }

    .dossier-settings-panel{ display:none; flex-direction:column; gap:12px; padding:12px; border:1px solid #dfe3f5; border-radius:12px; background:#f7f9ff; }
    .dossier-settings-panel.open{ display:flex; }
    .dossier-settings-panel label{ font-size:13px; color:#2f3f63; display:flex; align-items:center; gap:8px; }

    .letter-format-controls{ display:flex; flex-wrap:wrap; gap:10px; margin-bottom:8px; }
    .letter-format-controls button{ appearance:none; border:1px solid #c9d5f7; background:#eef2ff; color:#2b3b63; padding:6px 10px; border-radius:10px; font-size:12px; cursor:pointer; transition:background .2s, color .2s; }
    .letter-format-controls button.active{ background:#3a7afe; color:#fff; border-color:#3a7afe; box-shadow:0 6px 16px rgba(58,122,254,.28); }
    .letter-format-controls input[type="number"]{ width:80px; padding:6px 8px; border-radius:8px; border:1px solid #c9d5f7; font-size:12px; }

    .custom-step-list{ display:flex; flex-direction:column; gap:12px; }
    .custom-step{ border:1px solid #dfe3f5; border-radius:12px; padding:12px; background:#fff; display:flex; flex-direction:column; gap:10px; }
    .custom-step-header{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; }
    .custom-step-header h5{ margin:0; font-size:14px; }
    .custom-step-header .meta{ font-size:12px; color:#5f6c87; }
    .custom-step-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .custom-step input[type="file"]{ max-width:280px; }

    .branding-row{ display:flex; flex-wrap:nowrap; gap:var(--branding-gap, 16px); align-items:flex-start; justify-content:space-between; }
    .branding-row .branding-block{ flex:1 1 0; min-width:0; display:flex; justify-content:flex-start; align-items:center; word-break:break-word; }
    .branding-row .branding-block.align-center{ justify-content:center; text-align:center; }
    .branding-row .branding-block.align-right{ justify-content:flex-end; text-align:right; }
    .branding-row .branding-block img{ max-height:64px; width:auto; max-width:100%; object-fit:contain; margin-inline:auto; }

    .branding-item .row-select{ width:72px; }

    .dossier-archive{ border-top:1px solid #dfe3f5; padding-top:16px; display:flex; flex-direction:column; gap:12px; }
    .dossier-archive table{ width:100%; border-collapse:collapse; }
    .dossier-archive th, .dossier-archive td{ padding:10px 12px; border-bottom:1px solid #e1e7f7; font-size:12px; text-align:left; }
    .dossier-archive thead th{ background:#eef2ff; font-weight:600; color:#2f3f63; }
    .dossier-archive-empty{ font-size:13px; color:#7d89a5; margin:0; }

    .grid{ display:grid; grid-template-columns:minmax(320px, 360px) 1fr; gap:24px; align-items:start; }
    .form-row{ display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:16px; margin-bottom:16px; }
    .form-row:last-of-type{ margin-bottom:0; }
    .attachment-preview{ display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--muted); margin-top:8px; }
    .attachment-preview a{ font-size:12px; }
    .attachment-preview img{ width:120px; height:120px; object-fit:cover; border-radius:12px; border:1px solid var(--card-border); }
    .tag-secondary{ background:#f0f3ff; color:#3a7afe; border:1px solid #c9d5f7; padding:2px 8px; border-radius:999px; font-size:11px; display:inline-flex; align-items:center; gap:4px; }
    .attachment-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .panson-card-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .panson-meta{ font-size:12px; color:var(--muted); }
    .panson-archive-toggle{ width:100%; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .panson-archive-toggle::after{ content:'‚ñæ'; font-size:14px; color:var(--muted); transition:transform .2s ease; }
    .panson-archive-toggle[aria-expanded="true"]::after{ transform:rotate(180deg); }
    .auth-standard-tabs{ display:flex; border-bottom:2px solid #2f55d4; margin-bottom:18px; flex-wrap:wrap; gap:6px; }
    .auth-standard-tabs button{ appearance:none; border:none; background:none; padding:10px 18px; font-weight:600; color:var(--muted); cursor:pointer; position:relative; border-radius:12px 12px 0 0; }
    .auth-standard-tabs button::after{ content:''; position:absolute; left:0; right:0; bottom:-2px; height:2px; background:transparent; transition:background .2s; border-radius:999px; }
    .auth-standard-tabs button.active{ color:var(--accent-strong); }
    .auth-standard-tabs button.active::after{ background:var(--accent-strong); }
    .auth-context{ display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin-bottom:16px; }
    .auth-context .tag{ font-size:12px; }
    .divider{ height:1px; background:var(--card-border); margin:18px 0; }
    .report-actions{ display:flex; flex-wrap:wrap; gap:12px; }
    .branding-section{ border:1px solid var(--card-border); border-radius:14px; padding:16px; margin-bottom:18px; background:rgba(255,255,255,.85); box-shadow:inset 0 1px 0 rgba(255,255,255,.4); }
    .branding-section h3{ margin:0 0 8px; font-size:16px; color:var(--text); }
    .branding-section p{ margin:0 0 12px; }
    .branding-list{ display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
    .branding-item{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; padding:10px 12px; border:1px solid var(--card-border); border-radius:10px; background:linear-gradient(180deg,#f8f9ff 0%,#eef2ff 100%); }
    .branding-item .meta{ display:flex; flex-direction:column; gap:4px; font-size:13px; color:var(--text); }
    .branding-item .meta .label{ font-weight:600; font-size:14px; }
    .branding-item .actions{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .branding-preview{ max-height:48px; max-width:140px; object-fit:contain; border-radius:8px; border:1px solid var(--card-border); background:#fff; padding:4px; }
    .branding-controls{ display:flex; flex-wrap:wrap; gap:10px; }
    .branding-controls .btn{ font-size:13px; }
    .branding-spacing-control{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; font-size:12px; color:var(--muted); margin-top:8px; }
    .branding-spacing-control input{ width:90px; }
    .btn.small{ font-size:12px; padding:6px 10px; border-radius:8px; }
    .subtabs{ display:flex; gap:8px; border-bottom:1px solid #d8e0f2; margin-bottom:18px; flex-wrap:wrap; }
    .subtabs button{ appearance:none; border:none; background:#eef2ff; color:#42507a; padding:10px 18px; border-radius:12px 12px 0 0; font-weight:600; cursor:pointer; box-shadow:inset 0 -1px 0 rgba(37,94,233,.25); }
    .subtabs button.active{ background:#fff; color:var(--accent-strong); box-shadow:0 -2px 10px rgba(37,94,233,.12); }
    .subtabs.compact{ gap:6px; margin-bottom:12px; }
    .subtabs.compact button{ padding:8px 14px; font-size:12px; border-radius:10px 10px 0 0; }
    .subtab-panel{ display:none; animation:fadeIn .25s ease; }
    .subtab-panel.active{ display:block; }
    .standard-manager{ border:1px solid #dfe6fb; border-radius:12px; padding:12px; background:#f8faff; margin-top:12px; display:none; flex-direction:column; gap:12px; }
    .standard-manager.visible{ display:flex; }
    .standard-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 10px; border-radius:10px; background:#fff; border:1px solid #dfe6fb; }
    .standard-row strong{ font-size:13px; }
    .standard-meta{ font-size:11px; color:#7d89a5; display:flex; gap:12px; flex-wrap:wrap; }
    .dossier-builder{ display:flex; flex-direction:column; gap:16px; }
    .dossier-create{ display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end; }
    .dossier-create > div{ flex:1 1 220px; }
    .dossier-create-actions{ display:flex; gap:8px; align-items:center; }
    .dossier-switcher{ display:flex; flex-wrap:wrap; gap:8px; }
    .dossier-switcher button{ appearance:none; border:none; background:#eef2ff; color:#2b3b63; padding:6px 12px; border-radius:999px; font-size:12px; cursor:pointer; }
    .dossier-switcher button.active{ background:#3a7afe; color:#fff; box-shadow:0 4px 12px rgba(58,122,254,.18); }
    .dossier-detail{ border:1px solid #dfe3f5; border-radius:14px; padding:16px; background:#f9fbff; display:flex; flex-direction:column; gap:18px; }
    .dossier-detail.hidden{ display:none; }
    .dossier-header-bar{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .dossier-header-bar h3{ margin:0; }
    .dossier-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .dossier-step h4{ margin:0 0 6px; font-size:14px; }
    .opis-preview{ background:#fff; border:1px solid #dfe3f5; border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px; }
    .opis-title{ font-weight:600; text-align:center; }
    .opis-preview ol{ margin:0; padding-left:18px; display:flex; flex-direction:column; gap:4px; font-size:13px; }
    .dossier-row-form{ border:1px dashed #c9d5f7; border-radius:12px; padding:12px; background:#fff; display:flex; flex-direction:column; gap:12px; }
    .form-actions.align-end{ display:flex; align-items:flex-end; justify-content:flex-end; }
    .dossier-doc-list{ display:flex; flex-direction:column; gap:8px; }
    .dossier-doc-list .doc-item{ display:flex; justify-content:space-between; align-items:center; gap:12px; padding:10px 12px; background:#fff; border:1px solid #dfe3f5; border-radius:10px; font-size:13px; }
    .dossier-doc-list .doc-item .meta{ display:flex; flex-direction:column; gap:2px; }
    .dossier-doc-list .doc-item .actions{ display:flex; gap:8px; }
    .material-uploader{ border:1px dashed #c9d5f7; border-radius:12px; padding:12px; background:#fff; display:flex; flex-direction:column; gap:12px; }
    .material-uploader-controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .dossier-actions{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    .dossier-list{ border:1px solid #dfe3f5; border-radius:12px; overflow:hidden; }
    .dossier-list table{ width:100%; border-collapse:collapse; }
    .dossier-list th, .dossier-list td{ padding:10px 12px; border-bottom:1px solid #e7ecfb; font-size:13px; text-align:left; }
    .dossier-list tbody tr:nth-child(odd){ background:#f9fbff; }
    .dossier-empty{ font-size:13px; color:#7d89a5; }
    @keyframes fadeIn{ from{ opacity:0; transform:translateY(4px); } to{ opacity:1; transform:translateY(0); } }
    .logo-preview{ width:64px; height:64px; border-radius:16px; border:1px dashed #c9d5f7; display:flex; align-items:center; justify-content:center; background:#f4f7ff; overflow:hidden; }
    .logo-preview img{ max-width:100%; max-height:100%; object-fit:contain; }
    .card{
      background:var(--card);
      border:1px solid var(--card-border);
      border-radius:16px;
      box-shadow:0 10px 28px rgba(32,56,104,.12);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      font-size:16px;
      padding:14px 16px;
      border-bottom:1px solid var(--card-border);
      background:#eff3ff;
      color:var(--text);
    }
    .card .content{ padding:14px 16px; }
    .muted{ color:var(--muted); font-size:13px; }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    label{ font-size:12px; color:#7381a3; display:block; margin:8px 0 6px; }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #c9d5f7;
      background:#f9fbff;
      color:var(--text);
      outline:none;
      transition:border-color .2s, box-shadow .2s;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(58,122,254,.18);
    }
    input::placeholder, textarea::placeholder{ color:#9aa7c6; }
    button{ appearance:none; border:none; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; transition:transform .15s ease, box-shadow .15s ease; }
    button:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(37,94,233,.18); }
    button:disabled{ cursor:not-allowed; opacity:.6; box-shadow:none; transform:none; }
    button:disabled:hover{ box-shadow:none; transform:none; }
    .btn{ background:var(--accent); color:#fff; }
    .btn.secondary{ background:#e7ecfb; color:var(--accent-strong); box-shadow:none; }
    .btn.secondary:hover{ box-shadow:0 4px 12px rgba(37,94,233,.12); }
    .btn.ghost{ background:#fff; border:1px solid #c9d5f7; color:var(--accent-strong); box-shadow:none; }
    .btn.ghost:hover{ box-shadow:0 4px 12px rgba(37,94,233,.12); }
    .btn.danger{ background:var(--bad); color:#fff; box-shadow:none; }
    .toolbar{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }

    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; border:1px solid var(--card-border); }
    th, td{ text-align:left; padding:10px 12px; font-size:14px; }
    thead th{ background:#eef3ff; position:sticky; top:0; z-index:1; color:var(--text); }
    tbody tr:nth-child(odd){ background:#fff; }
    tbody tr:nth-child(even){ background:var(--table-alt); }
    tbody tr:hover{ background:#e7efff; }
    .status{ font-size:12px; padding:4px 8px; border-radius:999px; display:inline-block; border:1px solid transparent; }
    .status.ok{ background:rgba(26,155,111,.12); color:#187657; border-color:rgba(26,155,111,.24); }
    .status.warn{ background:rgba(210,138,0,.12); color:#8a5a00; border-color:rgba(210,138,0,.24); }
    .status.bad{ background:rgba(217,74,74,.12); color:#932828; border-color:rgba(217,74,74,.26); }

    .list{ max-height:480px; overflow:auto; }
    .search-box{ margin-bottom:12px; }
    .search-box input{ width:100%; }
    #welder_count{ font-weight:600; }
    #welders_tbody tr.selected{ background:#e0e8ff !important; box-shadow:inset 0 0 0 2px rgba(58,122,254,.35); }
    .welder-name-cell{ display:flex; align-items:center; gap:8px; }
    .icon-button{ background:transparent; border:1px solid transparent; color:var(--bad); padding:4px; border-radius:10px; cursor:pointer; font-size:16px; line-height:1; transition:background .2s, border-color .2s, color .2s; }
    .icon-button:hover{ background:rgba(217,74,74,.08); border-color:rgba(217,74,74,.18); }
    .icon-button:focus-visible{ outline:2px solid var(--bad); outline-offset:2px; }
    .status.neutral{ background:#edf2ff; color:var(--accent-strong); border-color:#d0dcff; }
    .hidden{ display:none !important; }
    .section-title{ display:flex; align-items:center; gap:8px; margin:8px 0 4px; color:var(--text); }
    .tag{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #c9d5f7; color:var(--accent-strong); background:#edf2ff; }
    .help{ font-size:12px; color:#7d89a5; margin-top:8px; }
    #q_attachment_wrap{ margin-top:12px; }
    .attachment-link{ font-size:12px; color:var(--accent-strong); text-decoration:none; font-weight:600; }
    .attachment-link:hover{ text-decoration:underline; }
    .link-button{ appearance:none; border:none; background:none; padding:0; margin:0; color:var(--accent-strong); font-weight:600; font-size:13px; cursor:pointer; text-decoration:none; }
    .link-button:hover{ text-decoration:underline; }
    .attachment-preview .link-button{ font-size:12px; }
    .danger-zone{ border-top:1px dashed #c9d5f7; margin-top:12px; padding-top:12px; }
    .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:18px; margin-top:16px; }
    .stat-card{ background:linear-gradient(180deg,#ffffff,#f4f7ff); border:1px solid var(--card-border); border-radius:16px; padding:16px; box-shadow:0 10px 24px rgba(32,56,104,.12); transition:background .2s, border-color .2s; }
    .stat-card.warning{ background:linear-gradient(180deg,#fff8e6,#ffeab6); border-color:rgba(210,138,0,.45); }
    .stat-card.danger{ background:linear-gradient(180deg,#ffeaea,#ffd1d1); border-color:rgba(217,74,74,.45); }
    .stat-card h3{ margin:0 0 6px; font-size:12px; text-transform:uppercase; letter-spacing:.6px; color:#6c7aa1; }
    .stat-card strong{ font-size:28px; font-weight:700; color:var(--accent-strong); }
    .stat-card span{ font-size:12px; color:#7c88a8; }
    .stat-card.warning h3{ color:#a06400; }
    .stat-card.warning strong{ color:var(--warn); }
    .stat-card.warning span{ color:#a06400; }
    .stat-card.danger h3{ color:#b33a3a; }
    .stat-card.danger strong{ color:var(--bad); }
    .stat-card.danger span{ color:#b33a3a; }
    .overview-table{ margin-top:20px; border-radius:16px; overflow:hidden; border:1px solid var(--card-border); }
    .overview-table table{ border:none; }
    .overview-table caption{ text-align:left; font-weight:600; padding:12px 16px; background:#eef3ff; }
    .company-list{ display:flex; flex-direction:column; gap:12px; margin-top:12px; }
    .company-item{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; padding:12px; border:1px solid var(--card-border); border-radius:12px; background:#f8faff; }
    .company-item input{ max-width:240px; }
    .company-item .tag{ margin-left:auto; }
    .app-footer{ margin-top:auto; padding:18px 24px; color:#7d89a5; font-size:12px; background:rgba(255,255,255,.86); border-top:1px solid var(--card-border); }
    .view-note{ font-size:13px; color:#7180a4; margin-top:8px; }
    .document-viewer{ position:fixed; inset:0; background:rgba(17,28,62,.65); backdrop-filter:blur(4px); display:none; align-items:center; justify-content:center; z-index:999; padding:32px; }
    .document-viewer.open{ display:flex; }
    .document-viewer-dialog{ position:relative; background:#fff; border-radius:18px; box-shadow:0 18px 60px rgba(17,28,62,.28); max-width:90vw; width:960px; max-height:90vh; display:flex; flex-direction:column; }
    .document-viewer-header{ display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid #e2e8ff; }
    .document-viewer-title{ font-size:16px; font-weight:600; color:var(--surface); }
    .document-viewer-close{ border:none; background:none; font-size:20px; line-height:1; cursor:pointer; color:#7481a0; }
    .document-viewer-close:hover{ color:#2b3b63; }
    .document-viewer-body{ padding:0 20px 20px; overflow:auto; flex:1; }
    .document-viewer-body iframe{ width:100%; height:70vh; border:none; border-radius:12px; background:#f5f7ff; }
    .document-viewer-body img{ max-width:100%; height:auto; border-radius:12px; }
    .print-branding{ display:flex; flex-direction:column; gap:4px; font-size:12px; color:#202b46; }
    .print-branding img{ max-height:48px; object-fit:contain; }
    @media (max-width:960px){
      .app-shell{ flex-direction:column; }
      .sidebar{ flex-direction:row; overflow:auto; width:100%; padding:16px 12px; gap:12px; align-items:flex-start; }
      .sidebar-header{ display:none; }
      .sidebar-nav{ flex-direction:row; flex-wrap:wrap; margin-top:0; gap:12px; }
      .nav-button{ flex:1 1 150px; flex-direction:row; justify-content:flex-start; min-height:auto; padding:12px 14px; }
      .nav-button .icon{ font-size:20px; width:24px; height:24px; border-radius:8px; }
      .nav-button span:last-child{ text-transform:none; font-size:14px; text-align:left; }
      .workspace{ min-height:auto; }
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .archive-section{ margin-top:16px; border-top:1px dashed var(--card-border); padding-top:16px; }
    .archive-toggle{ width:100%; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .archive-toggle::after{ content:'‚ñæ'; font-size:14px; color:var(--muted); transition:transform .2s ease; }
    .archive-toggle[aria-expanded="true"]::after{ transform:rotate(180deg); }
    .archive-toggle:disabled{ opacity:.5; cursor:not-allowed; }
    .archive-panel{ margin-top:12px; background:#f8faff; border:1px solid #dfe6fb; border-radius:12px; padding:12px; }
    .archive-panel .archive-note{ margin:0 0 10px; font-size:12px; color:#7d89a5; }
    .archive-panel .list{ max-height:240px; }
    .archive-panel table thead th{ background:#e9eeff; }
    .archive-panel td:last-child{ text-align:right; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <div id="auth_overlay" class="auth-overlay" aria-hidden="false">
    <div class="auth-card" role="dialog" aria-modal="true" aria-labelledby="auth_title">
      <h2 id="auth_title">Autentificare</h2>
      <p>Introduce datele de acces pentru a intra √Æn aplica»õie.</p>
      <div id="auth_error" class="auth-error" role="alert">Utilizator sau parolƒÉ incorecte.</div>
      <p id="auth_notice" class="auth-notice" role="status"></p>
      <form id="auth_form" autocomplete="off">
        <div>
          <label for="auth_user">Utilizator</label>
          <input id="auth_user" name="username" type="text" autocomplete="username" required />
        </div>
        <div>
          <label for="auth_pass">ParolƒÉ</label>
          <input id="auth_pass" name="password" type="password" autocomplete="current-password" required />
        </div>
        <button type="submit">AutentificƒÉ-te</button>
      </form>
    </div>
  </div>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-header">
        <span class="sidebar-title">Gestiune Sudori</span>
        <span class="sidebar-subtitle">panou opera»õional</span>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-button active" data-view="home">
          <span class="icon">üè†</span>
          <span>Home</span>
        </button>
        <button class="nav-button" data-view="authorizations">
          <span class="icon">üìÑ</span>
          <span>Autoriza»õii</span>
        </button>
        <button class="nav-button" data-view="welders">
          <span class="icon">üßë‚Äçüè≠</span>
          <span>Sudori</span>
        </button>
        <button class="nav-button" data-view="procedures">
          <span class="icon">üìò</span>
          <span>OmologƒÉri</span>
        </button>
        <button class="nav-button" data-view="settings">
          <span class="icon">‚öôÔ∏è</span>
          <span>SetƒÉri</span>
        </button>
      </nav>
      <div class="sidebar-footer">
        Date salvate local √Æn browser.<br/>DescarcƒÉ periodic backup-ul JSON.
      </div>
    </aside>
    <div class="workspace">
      <header class="topbar">
        <div class="topbar-brand">
          <img id="active_company_logo" class="company-logo" alt="Logo companie" />
          <div class="title-stack">
            <h1>Gestiune Sudori</h1>
            <span class="pill">ASME Sec IX ¬∑ ISCIR CR9 / CR7</span>
          </div>
        </div>
        <div class="topbar-actions">
          <div class="company-select">
            <span>Companie activƒÉ</span>
            <select id="company_selector"></select>
          </div>
          <button class="btn ghost" id="btn_add_company">Companie nouƒÉ</button>
          <span class="muted">Frontend HTML ‚Äì date stocate local</span>
          <button class="btn ghost" id="btn_import_state">ImportƒÉ baza de date</button>
          <button class="btn ghost" id="btn_export_state">SalveazƒÉ baza de date</button>
          <input type="file" id="input_import_state" accept="application/json" hidden />
        </div>
      </header>
      <main>
        <div class="content-inner">
          <section id="view_home" class="view active">
            <div class="card">
              <h2>Panou general</h2>
              <div class="content">
                <p class="muted">Statistici agregate din toate companiile administrate.</p>
                <div class="stats-grid">
                  <div class="stat-card">
                    <h3>Sudori activi</h3>
                    <strong id="home_total_welders">0</strong>
                    <span>Total sudori √Ænregistra»õi</span>
                  </div>
                  <div class="stat-card">
                    <h3>Autoriza»õii active</h3>
                    <strong id="home_total_authorizations">0</strong>
                    <span>Autoriza»õii sudori √Æn curs de valabilitate</span>
                  </div>
                  <div class="stat-card">
                    <h3>OmologƒÉri active</h3>
                    <strong id="home_total_procedures">0</strong>
                    <span>Procedee omologate gestionate</span>
                  </div>
                  <div class="stat-card warning">
                    <h3>ExpirƒÉ cur√¢nd</h3>
                    <strong id="home_expiring_soon">0</strong>
                    <span>√én urmƒÉtoarele 30 de zile</span>
                  </div>
                  <div class="stat-card danger">
                    <h3>Expirate</h3>
                    <strong id="home_expired">0</strong>
                    <span>NecesitƒÉ ac»õiune</span>
                  </div>
                </div>
                <div class="overview-table">
                  <table>
                    <caption>Situa»õie pe companii</caption>
                    <thead>
                      <tr>
                        <th>Companie</th>
                        <th>Sudori</th>
                        <th>Autoriza»õii</th>
                        <th>Procedee</th>
                        <th>ExpirƒÉ &lt; 30 zile</th>
                        <th>Expirate</th>
                      </tr>
                    </thead>
                    <tbody id="home_company_table"></tbody>
                  </table>
                </div>
                <p class="muted hidden" id="home_companies_empty">AdaugƒÉ o companie »ôi √ÆnregistreazƒÉ sudori pentru a vedea statistici defalcate.</p>
                <div class="overview-table">
                  <table>
                    <caption>UrmƒÉtoarele expirƒÉri</caption>
                    <thead>
                      <tr>
                        <th>Companie</th>
                        <th>Sudor</th>
                        <th>Standard</th>
                        <th>Proces</th>
                        <th>ExpirƒÉ la</th>
                      </tr>
                    </thead>
                    <tbody id="home_expiring_table"></tbody>
                  </table>
                </div>
                <p class="muted hidden" id="home_no_expiring">Nicio autoriza»õie nu expirƒÉ √Æn urmƒÉtoarele 60 de zile.</p>
              </div>
            </div>
          </section>

          <section id="view_welders" class="view">
            <div class="content-inner">
              <section id="welders_menu" class="card">
                <h2>Alege modul de administrare</h2>
                <div class="content">
                  <p class="muted">Gestionarea personalului este √ÆmpƒÉr»õitƒÉ pe douƒÉ zone dedicate.</p>
                  <div class="selection-hub">
                    <button type="button" class="selection-card" id="welders_menu_welders">
                      <div class="icon">üë∑‚Äç‚ôÇÔ∏è</div>
                      <h3>Sudori</h3>
                      <p>ListƒÉ completƒÉ cu eviden»õa autoriza»õiilor »ôi acces la documentele fiecƒÉrui sudor.</p>
                    </button>
                    <button type="button" class="selection-card" id="welders_menu_pansoane">
                      <div class="icon">üîñ</div>
                      <h3>Pansoane</h3>
                      <p>AdministreazƒÉ codurile disponibile, arhiveazƒÉ sau reactiveazƒÉ pansoane.</p>
                    </button>
                  </div>
                </div>
              </section>

              <section id="welders_overview" class="card hidden">
                <div class="content welder-overview">
                  <div class="subview-header">
                    <button type="button" class="back-link" data-subview-back="menu">‚Üê √énapoi la meniu</button>
                    <h2>Sudori</h2>
                    <span class="tag">Total activi: <strong id="welder_count">0</strong></span>
                  </div>
                  <div class="welder-table-tools">
                    <div class="search-box">
                      <input id="welder_search" type="search" placeholder="CautƒÉ dupƒÉ nume sau cod" aria-label="CautƒÉ sudor" />
                    </div>
                    <div class="actions">
                      <button type="button" class="btn secondary" id="btn_new_welder">AdaugƒÉ sudor</button>
                    </div>
                  </div>
                  <div class="list">
                    <table>
                      <thead>
                        <tr>
                          <th style="width:15%">Panson</th>
                          <th style="width:20%">Sudor</th>
                          <th style="width:30%">CalificƒÉri</th>
                          <th style="width:25%">CalificƒÉri pe proces</th>
                          <th style="width:10%">Ac»õiuni</th>
                        </tr>
                      </thead>
                      <tbody id="welders_tbody"></tbody>
                    </table>
                  </div>
                  <div class="archive-section">
                    <button type="button" class="btn ghost archive-toggle" id="toggle_archive" aria-expanded="false">
                      ArhivƒÉ sudori (0)
                    </button>
                    <div class="archive-panel hidden" id="archive_panel" aria-hidden="true">
                      <p class="archive-note">Sudorii arhiva»õi pot fi reactiva»õi √ÆmpreunƒÉ cu autoriza»õiile lor.</p>
                      <div class="search-box">
                        <input type="search" id="archive_search" placeholder="CautƒÉ √Æn arhivƒÉ dupƒÉ nume, cod sau motiv" />
                      </div>
                      <div class="list hidden" id="archive_table_wrap">
                        <table>
                          <thead>
                            <tr>
                              <th style="width:28%">Nume</th>
                              <th>Cod</th>
                              <th>Arhivat la</th>
                              <th>Motiv</th>
                              <th>AutorizƒÉri</th>
                              <th></th>
                            </tr>
                          </thead>
                          <tbody id="archive_tbody"></tbody>
                        </table>
                      </div>
                      <p class="muted" id="archive_empty">Arhiva este goalƒÉ.</p>
                      <p class="muted hidden" id="archive_no_results">Nicio potrivire pentru filtrul curent.</p>
                    </div>
                  </div>
                </div>
              </section>

              <section id="pansoane_overview" class="card hidden">
                <div class="content">
                  <div class="subview-header">
                    <button type="button" class="back-link" data-subview-back="menu">‚Üê √énapoi la meniu</button>
                    <h2>Pansoane active (<span id="panson_count">0</span>)</h2>
                  </div>
                  <div class="form-row">
                    <div>
                      <label>Cod panson</label>
                      <input id="panson_code" placeholder="ex: P-001" />
                    </div>
                    <div>
                      <label>Descriere</label>
                      <input id="panson_description" placeholder="ex: Panson linia A" />
                    </div>
                    <div class="toolbar">
                      <button class="btn" id="btn_add_panson">AdaugƒÉ panson</button>
                    </div>
                  </div>
                  <div class="list">
                    <table>
                      <thead>
                        <tr>
                          <th>Cod</th>
                          <th>Descriere</th>
                          <th>UtilizƒÉri</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="pansoane_tbody"></tbody>
                    </table>
                  </div>
                  <p class="muted" id="pansoane_empty">AdaugƒÉ primul panson pentru a-l putea asigna sudorilor.</p>
                  <div class="archive-section">
                    <button type="button" class="btn ghost panson-archive-toggle" id="toggle_panson_archive" aria-expanded="false">
                      ArhivƒÉ pansoane (0)
                    </button>
                    <div class="archive-panel hidden" id="panson_archive_panel" aria-hidden="true">
                      <p class="archive-note">Pansoanele arhivate nu mai pot fi alese de sudori, dar pot fi restaurate ulterior.</p>
                      <div class="list hidden" id="panson_archive_table_wrap">
                        <table>
                          <thead>
                            <tr>
                              <th>Cod</th>
                              <th>Descriere</th>
                              <th>Arhivat la</th>
                              <th></th>
                            </tr>
                          </thead>
                          <tbody id="panson_archive_tbody"></tbody>
                        </table>
                      </div>
                      <p class="muted" id="panson_archive_empty">Nu existƒÉ pansoane arhivate.</p>
                    </div>
                  </div>
                </div>
              </section>
            </div>
          </section>

          <section id="view_authorizations" class="view">
            <section class="card">
              <h2>Autoriza»õii</h2>
              <div class="content">
                <div class="auth-context">
                  <span class="muted">Sudor selectat:</span>
                  <span id="auth_current_welder" class="tag">(selecteazƒÉ un sudor)</span>
                </div>
                <div class="subtabs" id="auth_tabs" role="tablist" aria-label="Sec»õiuni autoriza»õii">
                  <button type="button" class="active" data-tab="auth_form">Autoriza»õii sudori</button>
                  <button type="button" data-tab="auth_existing">Autoriza»õii existente</button>
                  <button type="button" data-tab="auth_dossier">Dosar autorizare</button>
                </div>

                <div class="subtab-panel active" data-panel="auth_form">
                  <div class="auth-standard-tabs" id="auth_standard_tabs" role="tablist" aria-label="Standard autorizare"></div>
                  <div class="form-row">
                    <div>
                      <label>Standard</label>
                      <select id="auth_standard"></select>
                      <button type="button" class="btn ghost small" id="btn_manage_standards">Gestionare standarde</button>
                    </div>
                    <div>
                      <label>Sudor</label>
                      <select id="auth_welder_select">
                        <option value="">SelecteazƒÉ sudor</option>
                      </select>
                    </div>
                    <div>
                      <label>Panson asignat</label>
                      <input id="auth_welder_panson" type="text" placeholder="‚Äî" readonly />
                    </div>
                  </div>
                  <div class="form-row">
                    <div>
                      <label>Procedeu omologat</label>
                      <select id="auth_procedure_select">
                        <option value="">SelecteazƒÉ procedeu</option>
                      </select>
                    </div>
                    <div>
                      <label id="auth_process_label">Procedeu de sudare</label>
                      <select id="auth_process">
                        <option>GMAW (MIG/MAG)</option>
                        <option>GTAW (TIG)</option>
                        <option>SMAW (MMA)</option>
                        <option>FCAW</option>
                        <option>SAW</option>
                      </select>
                    </div>
                    <div>
                      <label>Calitate material de bazƒÉ</label>
                      <input id="auth_base_quality" placeholder="ex: S235" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div>
                      <label>Materiale de bazƒÉ</label>
                      <input id="auth_base_material" placeholder="ex: »õeavƒÉ S355 / 48.6√ó3.6" />
                    </div>
                    <div>
                      <label>Material de adaos</label>
                      <input id="auth_filler_material" placeholder="ex: ER70S-6" />
                    </div>
                    <div>
                      <label id="auth_position_label">Pozi»õie de sudare</label>
                      <select id="auth_position">
                        <option>PA</option><option>PB</option><option>PC</option><option>PD</option><option>PE</option><option>PF</option><option>PG</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div>
                      <label>Dimensiune material de bazƒÉ</label>
                      <input id="auth_base_dimension" placeholder="ex: 300 √ó 30 mm" />
                    </div>
                    <div>
                      <label>Diametru / grosime</label>
                      <input id="auth_diameter" placeholder="ex: √ò114 ¬∑ 8 mm" />
                    </div>
                    <div>
                      <label>Domeniu grosime</label>
                      <input id="auth_thickness_domain" placeholder="ex: t16√∑38 mm" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div>
                      <label>Nr. autoriza»õie</label>
                      <input id="auth_cert" placeholder="ex: Q-2025-044" />
                    </div>
                    <div>
                      <label>Emitent</label>
                      <input id="auth_issuer" placeholder="ex: Organism Aprob." />
                    </div>
                    <div>
                      <label>Data expirƒÉrii</label>
                      <input id="auth_expiry" type="date" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div>
                      <label>Observa»õii</label>
                      <input id="auth_observation" placeholder="ex: Autorizare ini»õialƒÉ" />
                    </div>
                    <div>
                      <label>Document asociat (PDF op»õional)</label>
                      <input id="auth_attachment" type="file" accept="application/pdf" />
                      <p class="help">Ata»ôeazƒÉ copia autoriza»õiei √Æn format PDF pentru eviden»õƒÉ.</p>
                    </div>
                  </div>
                  <div class="toolbar">
                    <button class="btn" id="btn_add_authorization">AdaugƒÉ autoriza»õie</button>
                    <button class="btn ghost" id="btn_refresh_authorizations">Re√ÆncarcƒÉ</button>
                  </div>
                  <div class="standard-manager" id="auth_standard_manager" aria-hidden="true">
                    <div class="standard-row">
                      <strong>Standardele disponibile</strong>
                      <div class="attachment-actions">
                        <button type="button" class="btn secondary small" id="btn_add_standard">AdaugƒÉ standard</button>
                        <button type="button" class="btn ghost small" id="btn_close_standard_manager">√énchide</button>
                      </div>
                    </div>
                    <p class="muted">ActualizeazƒÉ denumirea »ôi grupul standardelor folosite pentru autorizarea sudorilor.</p>
                    <div id="auth_standard_list"></div>
                  </div>
                </div>

                <div class="subtab-panel" data-panel="auth_existing">
                  <div class="section-title">
                    <strong>Autoriza»õii existente</strong>
                    <span class="tag" id="auth_existing_hint">vizualizare pe standarde fƒÉrƒÉ selec»õie de sudor</span>
                  </div>
                  <div class="subtabs compact" id="auth_existing_tabs" role="tablist" aria-label="Grupuri standard autoriza»õii"></div>
                  <p class="muted hidden" id="auth_empty_state">Nu existƒÉ autoriza»õii salvate.</p>
                  <div class="list" id="auth_existing_tables"></div>
                </div>

                <div class="subtab-panel" data-panel="auth_dossier">
                  <div class="dossier-builder">
                    <div class="dossier-create">
                      <div>
                        <label>Standard dosar</label>
                        <select id="auth_dossier_standard_select"></select>
                      </div>
                      <div class="dossier-create-actions">
                        <button type="button" class="btn" id="btn_new_auth_dossier">Dosar nou</button>
                        <button type="button" class="btn ghost" id="btn_auth_dossier_settings" aria-expanded="false">SetƒÉri</button>
                      </div>
                    </div>
                    <div id="auth_dossier_settings_panel" class="dossier-settings-panel" aria-hidden="true">
                      <label><input type="checkbox" id="auth_dossier_page_numbers" checked /> NumeroteazƒÉ paginile √Æn PDF-ul dosarului</label>
                    </div>
                    <div id="auth_dossier_switcher" class="dossier-switcher"></div>
                    <p class="muted" id="auth_dossier_empty_state">CreeazƒÉ un dosar de autorizare pentru a √Æncepe.</p>
                    <div id="auth_dossier_detail" class="dossier-detail hidden" aria-live="polite">
                      <div class="dossier-header-bar">
                        <div>
                          <h3 id="auth_dossier_title">Dosar autorizare</h3>
                          <span class="tag" id="auth_dossier_standard_label"></span>
                        </div>
                        <div class="dossier-actions">
                          <button type="button" class="btn ghost small" id="btn_delete_auth_dossier">»òterge dosarul</button>
                          <button type="button" class="btn secondary" id="btn_preview_auth_dossier_pdf">PrevizualizeazƒÉ</button>
                          <button type="button" class="btn" id="btn_generate_auth_dossier_pdf">DescarcƒÉ dosar PDF</button>
                          <button type="button" class="btn ghost" id="btn_save_auth_dossier_pdf">SalveazƒÉ</button>
                        </div>
                      </div>

                      <div id="auth_dossier_editor_body">
                      <div class="dossier-step" id="auth_dossier_step_opis">
                        <h4>Pasul 1 ¬∑ OPIS</h4>
                        <p class="muted">Titlul »ôi numerotarea se actualizeazƒÉ automat √Æn func»õie de pa»ôii completa»õi.</p>
                        <div class="opis-preview">
                          <div class="opis-title" id="auth_dossier_opis_title"></div>
                          <ol id="auth_dossier_opis_list"></ol>
                        </div>
                      </div>

                      <div class="dossier-step">
                        <h4>Pasul 2 ¬∑ AdresƒÉ cƒÉtre organismul de calificare</h4>
                        <div class="letter-format-controls">
                          <button type="button" data-letter-align="left" id="btn_letter_align_left">St√¢nga</button>
                          <button type="button" data-letter-align="center" id="btn_letter_align_center">Centru</button>
                          <button type="button" data-letter-bold-toggle id="btn_letter_bold">Text √Ængro»ôat</button>
                          <label for="auth_letter_size">MƒÉrime text
                            <input type="number" id="auth_letter_size" min="10" max="24" value="12" />
                          </label>
                        </div>
                        <textarea id="auth_dossier_letter" rows="5" placeholder="Introdu textul adresei cƒÉtre organismul de calificare"></textarea>
                      </div>

                      <div class="dossier-step">
                        <h4>Pasul 3 ¬∑ Tabel autoriza»õii</h4>
                        <p class="muted">CompleteazƒÉ manual sau folose»ôte butoanele ‚ÄûReautorizare‚Äù »ôi ‚ÄûPrelungire‚Äù din tabul ‚ÄûAutoriza»õii existente‚Äù.</p>
                        <div class="dossier-row-form">
                          <div class="form-row">
                            <div>
                              <label>Sudor</label>
                              <select id="auth_dossier_row_welder">
                                <option value="">SelecteazƒÉ sudor</option>
                              </select>
                            </div>
                            <div>
                              <label>Procedeu de sudare</label>
                              <input id="auth_dossier_row_process" />
                            </div>
                            <div>
                              <label>Calitate material de bazƒÉ</label>
                              <input id="auth_dossier_row_base" />
                            </div>
                            <div>
                              <label>Procedeu omologat (op»õional)</label>
                              <select id="auth_dossier_row_procedure">
                                <option value="">FƒÉrƒÉ asociere</option>
                              </select>
                            </div>
                          </div>
                          <div class="form-row">
                            <div>
                              <label>Material de adaos</label>
                              <input id="auth_dossier_row_filler" />
                            </div>
                            <div>
                              <label>Materiale de bazƒÉ</label>
                              <input id="auth_dossier_row_material" />
                            </div>
                            <div>
                              <label>Pozi»õie de sudare</label>
                              <input id="auth_dossier_row_position" />
                            </div>
                          </div>
                          <div class="form-row">
                            <div>
                              <label>Dim. material de bazƒÉ</label>
                              <input id="auth_dossier_row_dimension" />
                            </div>
                            <div>
                              <label>Diametru / grosime</label>
                              <input id="auth_dossier_row_diameter" />
                            </div>
                            <div>
                              <label>Domeniu grosime</label>
                              <input id="auth_dossier_row_domain" />
                            </div>
                            <div>
                              <label>Observa»õii</label>
                              <input id="auth_dossier_row_observation" placeholder="autorizare / prelungire / omologare" />
                            </div>
                            <div class="form-actions align-end">
                              <button type="button" class="btn secondary" id="btn_add_dossier_row">AdaugƒÉ √Æn tabel</button>
                            </div>
                          </div>
                        </div>
                        <div class="list" id="auth_dossier_table_wrap">
                          <table>
                            <thead>
                              <tr>
                                <th>Nr. crt.</th>
                                <th>Nume / panson</th>
                                <th>Procedee de sudare</th>
                                <th>Calitatea mat. de bazƒÉ</th>
                                <th>Materiale de adaos</th>
                                <th>Pozi»õii de sudare</th>
                                <th>Grosime mat. de bazƒÉ</th>
                                <th>Diametru »õeavƒÉ</th>
                                <th>Domeniu grosimi / observa»õii</th>
                                <th></th>
                              </tr>
                            </thead>
                            <tbody id="auth_dossier_table_body"></tbody>
                          </table>
                        </div>
                        <p class="muted hidden" id="auth_dossier_table_empty">Tabelul nu con»õine √ÆncƒÉ intrƒÉri.</p>
                      </div>

                      <div class="dossier-step">
                        <h4>Pasul 4 ¬∑ Procedee anexate</h4>
                        <p class="muted">Procedeele omologate selectate se includ automat cu documentele ata»ôate.</p>
                        <div class="dossier-doc-list" id="auth_dossier_procedure_docs"></div>
                      </div>

                      <div class="dossier-step">
                        <h4>Pasul 5 ¬∑ Documente sudori</h4>
                        <p class="muted">Pentru fiecare sudor din tabel se vor ata»ôa copia actului de identitate, diploma, contractul »ôi fi»ôa de aptitudini (dacƒÉ existƒÉ).</p>
                        <div class="dossier-doc-list" id="auth_dossier_welder_docs"></div>
                      </div>

                      <div class="dossier-step">
                        <h4>Pasul 6 ¬∑ Materiale de bazƒÉ</h4>
                        <div class="material-uploader">
                          <div class="material-uploader-controls">
                            <select id="auth_dossier_base_material_select"></select>
                            <input type="file" id="auth_dossier_base_material_file" accept="application/pdf,image/*" />
                            <button type="button" class="btn ghost" id="btn_add_base_material_doc">Ata»ôeazƒÉ document</button>
                          </div>
                          <div class="dossier-doc-list" id="auth_dossier_base_material_docs"></div>
                        </div>
                      </div>

                      <div class="dossier-step">
                        <h4>Pasul 7 ¬∑ Materiale de adaos</h4>
                        <div class="material-uploader">
                          <div class="material-uploader-controls">
                            <select id="auth_dossier_filler_material_select"></select>
                            <input type="file" id="auth_dossier_filler_material_file" accept="application/pdf,image/*" />
                            <button type="button" class="btn ghost" id="btn_add_filler_material_doc">Ata»ôeazƒÉ document</button>
                          </div>
                          <div class="dossier-doc-list" id="auth_dossier_filler_material_docs"></div>
                        </div>
                      </div>
                      <div class="dossier-step">
                        <h4>Pa»ôi suplimentari</h4>
                        <p class="muted">AdaugƒÉ pa»ôi personaliza»õi cu denumire, descriere pentru OPIS »ôi documente aferente.</p>
                        <div class="dossier-row-form">
                          <div class="form-row">
                            <div>
                              <label>Denumire pas</label>
                              <input id="auth_custom_step_name" placeholder="ex: Raport evaluator" />
                            </div>
                            <div>
                              <label>Text √Æn OPIS</label>
                              <input id="auth_custom_step_opis" placeholder="ex: Raport evaluator autorizare" />
                            </div>
                          </div>
                          <div class="dossier-actions">
                            <button type="button" class="btn secondary" id="btn_add_custom_step">AdaugƒÉ pas</button>
                          </div>
                        </div>
                        <p class="muted" id="auth_custom_steps_empty">Nu existƒÉ pa»ôi suplimentari defini»õi.</p>
                        <div id="auth_custom_steps_list" class="custom-step-list"></div>
                      </div>
                      </div>
                      <div class="dossier-archive" id="auth_dossier_archive_section">
                        <h4>ArhivƒÉ dosare PDF salvate</h4>
                        <p class="dossier-archive-empty" id="auth_dossier_archive_empty">Nu existƒÉ dosare salvate √Æn arhivƒÉ.</p>
                        <div class="list hidden" id="auth_dossier_archive_table_wrap">
                          <table>
                            <thead>
                              <tr>
                                <th>Denumire</th>
                                <th>Standard</th>
                                <th>Salvat la</th>
                                <th>Pagini</th>
                                <th></th>
                              </tr>
                            </thead>
                            <tbody id="auth_dossier_archive_tbody"></tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </section>

          <section id="view_procedures" class="view">
            <section class="card">
              <h2>OmologƒÉri</h2>
              <div class="content">
                <div class="subtabs" id="proc_tabs" role="tablist" aria-label="Sec»õiuni omologƒÉri">
                  <button type="button" class="active" data-tab="proc_form">OmologƒÉri procedee</button>
                  <button type="button" data-tab="proc_existing">Procedee omologate</button>
                  <button type="button" data-tab="proc_dossier">Dosar omologare</button>
                </div>

                <div class="subtab-panel active" data-panel="proc_form">
                  <div class="form-row">
                    <div>
                      <label>Standard</label>
                      <select id="proc_standard">
                        <option value="ISCIR_CR7">ISCIR CR7 (omologare)</option>
                        <option value="ASME_IX">ASME Sec»õiunea IX</option>
                        <option value="EN_ISO_15614">EN ISO 15614</option>
                        <option value="AWS_D1_1">AWS D1.1</option>
                      </select>
                    </div>
                    <div>
                      <label>Procedeu</label>
                      <select id="proc_process">
                        <option>GMAW (MIG/MAG)</option>
                        <option>GTAW (TIG)</option>
                        <option>SMAW (MMA)</option>
                        <option>FCAW</option>
                        <option>SAW</option>
                      </select>
                    </div>
                    <div>
                      <label>Pozi»õie</label>
                      <select id="proc_position">
                        <option>PA</option><option>PB</option><option>PC</option><option>PD</option><option>PE</option><option>PF</option><option>PG</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div>
                      <label>Sudor (op»õional)</label>
                      <select id="proc_welder_select">
                        <option value="">Procedeu general</option>
                      </select>
                    </div>
                    <div>
                      <label>P-No. (material)</label>
                      <input id="proc_pno" placeholder="ex: P-No. 1" />
                    </div>
                    <div>
                      <label>Interval grosime (t)</label>
                      <input id="proc_thk" placeholder="ex: 3‚Äì12 mm" />
                    </div>
                    <div>
                      <label>Produs</label>
                      <select id="proc_product">
                        <option>PlacƒÉ</option>
                        <option>»öeavƒÉ</option>
                        <option>ColoanƒÉ</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div>
                      <label>Nr. procedeu</label>
                      <input id="proc_cert" placeholder="ex: WPQR-01" />
                    </div>
                    <div>
                      <label>Emitent</label>
                      <input id="proc_issuer" placeholder="ex: Organism Aprob." />
                    </div>
                    <div>
                      <label>Document procedeu (PDF op»õional)</label>
                      <input id="proc_attachment" type="file" accept="application/pdf" />
                    </div>
                  </div>
                  <div class="toolbar">
                    <button class="btn" id="btn_add_procedure">AdaugƒÉ procedeu</button>
                    <button class="btn ghost" id="btn_refresh_procedures">Re√ÆncarcƒÉ</button>
                  </div>
                </div>

                <div class="subtab-panel" data-panel="proc_existing">
                  <div class="section-title">
                    <strong>Procedee omologate</strong>
                    <span class="tag">nu au datƒÉ de expirare</span>
                  </div>
                  <p class="muted hidden" id="procedures_empty_state">Nu existƒÉ procedee omologate salvate √ÆncƒÉ.</p>
                  <div class="list" id="procedures_list_wrap">
                    <table>
                      <thead>
                        <tr>
                          <th style="width:18%">Standard</th>
                          <th>Procedeu</th>
                          <th>Pozi»õie</th>
                          <th>P-No.</th>
                          <th>t</th>
                          <th>Produs</th>
                          <th>Certificat</th>
                          <th>Sudor asociat</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="procedures_tbody"></tbody>
                    </table>
                  </div>
                </div>

                <div class="subtab-panel" data-panel="proc_dossier">
                  <p class="muted">√éncarcƒÉ documente generale pentru dosarul de omologare al companiei active.</p>
                  <div class="dossier-actions">
                    <input type="file" id="proc_dossier_file" accept="application/pdf,image/*" />
                    <button type="button" class="btn" id="btn_add_proc_dossier">AdaugƒÉ document</button>
                    <button type="button" class="btn ghost" id="btn_refresh_proc_dossier">Re√ÆncarcƒÉ</button>
                  </div>
                  <div class="dossier-list hidden" id="proc_dossier_list_wrap">
                    <table>
                      <thead>
                        <tr>
                          <th>Document</th>
                          <th>AdƒÉugat</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="proc_dossier_tbody"></tbody>
                    </table>
                  </div>
                  <p class="dossier-empty" id="proc_dossier_empty">Nu existƒÉ documente √Æn dosarul de omologare.</p>
                </div>
              </div>
            </section>
          </section>

          <section id="view_settings" class="view">
            <div class="card">
              <h2>SetƒÉri generale</h2>
              <div class="content">
                <div class="form-row">
                  <div>
                    <label for="general_inactivity_minutes">Blocare dupƒÉ inactivitate (minute)</label>
                    <input id="general_inactivity_minutes" type="number" min="1" max="120" />
                    <p class="help">DupƒÉ aceastƒÉ perioadƒÉ aplica»õia solicitƒÉ din nou parola de acces.</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="card">
              <h2>SetƒÉri companii</h2>
              <div class="content">
                <p class="muted">Redenume»ôte sau activeazƒÉ companiile existente. Folose»ôte ‚ÄûCompanie nouƒÉ‚Äù din antet pentru a adƒÉuga firme suplimentare.</p>
                <div class="company-list" id="company_list"></div>
              </div>
            </div>
            <div class="card">
              <h2>Rapoarte PDF</h2>
              <div class="content">
                <p class="muted">GenereazƒÉ rapid situa»õii √Æn format PDF pentru compania activƒÉ.</p>
                <div class="report-actions">
                  <button class="btn secondary" id="btn_report_welders">Raport sudori</button>
                  <button class="btn secondary" id="btn_report_authorizations">Raport autoriza»õii</button>
                  <button class="btn secondary" id="btn_report_procedures">Raport omologƒÉri</button>
                </div>
              </div>
            </div>
          </section>
        </div>
      </main>
      <footer class="app-footer">
        Datele introduse sunt pƒÉstrate local √Æn browser prin <span class="mono">localStorage</span>. Folose»ôte butonul ‚ÄûSalveazƒÉ baza de date‚Äù pentru a descƒÉrca un backup JSON.
      </footer>
    </div>
  </div>

  <div id="welder_modal" class="modal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="welder_modal_title">
      <button type="button" class="modal-close" data-action="close-welder-modal" aria-label="√énchide">√ó</button>
      <h2 id="welder_modal_title">Detalii sudor</h2>
      <p class="muted">CompleteazƒÉ datele de identificare »ôi ata»ôeazƒÉ documentele necesare dosarului personal.</p>
      <div class="form-row">
        <div>
          <label>Nume »ôi prenume</label>
          <input id="w_name" placeholder="ex: Popescu Ion" />
        </div>
        <div>
          <label>Telefon</label>
          <input id="w_phone" placeholder="ex: 07xx xxx xxx" />
        </div>
        <div>
          <label>Data angajƒÉrii</label>
          <input id="w_hire" type="date" />
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>Panson</label>
          <select id="w_panson">
            <option value="">SelecteazƒÉ panson</option>
          </select>
          <p class="help">Lista este populatƒÉ din sec»õiunea ‚ÄûPansoane‚Äù.</p>
        </div>
        <div>
          <label>Cod de identificare (manual)</label>
          <input id="w_code_manual" placeholder="ex: W-017" />
          <p class="help">DacƒÉ alegi un panson, codul se completeazƒÉ automat. Folose»ôte acest c√¢mp doar pentru coduri personalizate.</p>
        </div>
      </div>
      <div class="divider"></div>
      <div class="form-row">
        <div>
          <label>Fotografie sudor</label>
          <input id="w_photo" type="file" accept="image/*" />
          <div class="attachment-preview" id="w_photo_preview"></div>
        </div>
        <div>
          <label>Carte de identitate</label>
          <input id="w_id_card" type="file" accept="application/pdf,image/*" />
          <div class="attachment-preview" id="w_id_card_preview"></div>
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>DiplomƒÉ</label>
          <input id="w_diploma" type="file" accept="application/pdf,image/*" />
          <div class="attachment-preview" id="w_diploma_preview"></div>
        </div>
        <div>
          <label>Contract</label>
          <input id="w_contract" type="file" accept="application/pdf,image/*" />
          <div class="attachment-preview" id="w_contract_preview"></div>
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>Fi»ôƒÉ de aptitudini</label>
          <input id="w_aptitude" type="file" accept="application/pdf,image/*" />
          <div class="attachment-preview" id="w_aptitude_preview"></div>
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>Documente personale (CI/DiplomƒÉ/Contract/Fi»ôƒÉ)</label>
          <input id="w_bundle" type="file" accept="application/pdf,image/*" />
          <div class="attachment-preview" id="w_bundle_preview"></div>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="btn_save_welder">SalveazƒÉ</button>
      </div>
    </div>
  </div>

  <div id="document_viewer" class="document-viewer" aria-hidden="true">
    <div class="document-viewer-dialog" role="dialog" aria-modal="true" aria-labelledby="document_viewer_title">
      <div class="document-viewer-header">
        <div id="document_viewer_title" class="document-viewer-title">Vizualizare document</div>
        <button type="button" class="document-viewer-close" data-action="close-viewer" aria-label="√énchide vizualizarea">√ó</button>
      </div>
      <div class="document-viewer-body" id="document_viewer_body"></div>
    </div>
  </div>

  <div id="branding_modal" class="modal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="branding_modal_title">
      <button type="button" class="modal-close" data-action="close-branding-modal" aria-label="√énchide">√ó</button>
      <h2 id="branding_modal_title">SetƒÉri antet &amp; subsol rapoarte</h2>
      <div id="branding_modal_content"></div>
    </div>
  </div>


<script>
const STORAGE_KEY = 'gestiune_sudori_local_v1';
const AUTH_USERNAME = 'inginerSudor';
const AUTH_PASSWORD = 'gestionareSudori2025@';
const AUTH_SESSION_KEY = 'gestiune_sudori_auth_session';
const DEFAULT_AUTH_STANDARD = 'ASME_IX';
const DEFAULT_PROCEDURE_STANDARD = 'ISCIR_CR7';
const QUALIFICATION_CATEGORIES = ['autorizatii', 'procedee'];
const DEFAULT_QUALIFICATION_CATEGORY = 'autorizatii';
const DEFAULT_LETTER_STYLE = { align: 'left', bold: false, size: 12 };
const BASE_STANDARDS = [
  {
    id: 'ASME_IX',
    label: 'ASME Sec»õiunea IX',
    type: 'both',
    group: 'ASME',
    fieldLabels: { process: 'Proces sudare', position: 'Pozi»õie' },
  },
  {
    id: 'ISCIR_CR9',
    label: 'ISCIR CR9 (autorizare)',
    type: 'authorization',
    group: 'ALTE',
    fieldLabels: { process: 'Proces autorizat', position: 'Pozi»õie autorizatƒÉ' },
  },
  {
    id: 'ISCIR_CR7',
    label: 'ISCIR CR7 (omologare)',
    type: 'procedure',
    group: 'ALTE',
    fieldLabels: { process: 'Procedeu omologat', position: 'Pozi»õie omologatƒÉ' },
  },
  {
    id: 'ISO_9606_1',
    label: 'ISO 9606-1',
    type: 'authorization',
    group: 'ISO',
    fieldLabels: { process: 'Proces sudare', position: 'Pozi»õie' },
  },
  {
    id: 'ISO_14732',
    label: 'ISO 14732',
    type: 'authorization',
    group: 'ISO',
    fieldLabels: { process: 'Proces sudare', position: 'Pozi»õie' },
  },
  {
    id: 'AWS_D1_1',
    label: 'AWS D1.1',
    type: 'authorization',
    group: 'AWS',
    fieldLabels: { process: 'Proces sudare', position: 'Pozi»õie' },
  },
  {
    id: 'AWS_D1_6',
    label: 'AWS D1.6',
    type: 'authorization',
    group: 'AWS',
    fieldLabels: { process: 'Proces sudare', position: 'Pozi»õie' },
  },
  {
    id: 'EN_287',
    label: 'EN 287',
    type: 'authorization',
    group: 'ALTE',
    fieldLabels: { process: 'Proces sudare', position: 'Pozi»õie' },
  },
  {
    id: 'EN_ISO_15614',
    label: 'EN ISO 15614',
    type: 'procedure',
    group: 'ALTE',
    fieldLabels: { process: 'Procedeu', position: 'Pozi»õie' },
  },
];
const PRINT_STYLES = `
@page portrait { size: A4 portrait; margin: 18mm 18mm 20mm; }
@page landscape { size: A4 landscape; margin: 16mm 18mm 18mm; }
@page portrait-full { size: A4 portrait; margin: 0; }
@page landscape-full { size: A4 landscape; margin: 0; }
body{ font-family: 'Segoe UI','Roboto',sans-serif; color:#1a2240; margin:0; }
.print-document{ page-break-after:always; position:relative; min-height:100vh; padding:70px 40px 70px; box-sizing:border-box; }
.print-document:last-of-type{ page-break-after:auto; }
.print-document.portrait{ page: portrait; }
.print-document.landscape{ page: landscape; }
.print-document.portrait.full-bleed{ page: portrait-full; }
.print-document.landscape.full-bleed{ page: landscape-full; }
.print-document.full-bleed{ padding:48px 24px 48px; }
.print-document.full-bleed .print-header,.print-document.full-bleed .print-footer{ left:24px; right:24px; }
.print-document.full-bleed .print-header{ top:16px; }
.print-document.full-bleed .print-footer{ bottom:16px; }
.print-document.no-branding{ padding-top:0; padding-bottom:0; }
.print-document.no-branding .print-header,.print-document.no-branding .print-footer{ display:none; }
.print-document.no-branding .print-body{ margin-top:0; margin-bottom:0; }
.print-document.full-bleed.no-branding{ padding:0; }
.print-document.full-bleed.no-branding .print-body.full-bleed{ height:100vh; }
.print-header,.print-footer{ position:absolute; left:40px; right:40px; }
.print-header{ top:20px; }
.print-footer{ bottom:20px; }
.print-body{ margin-top:90px; margin-bottom:70px; }
.print-body.full-bleed{ margin:0; padding:0; height:calc(100vh - 120px); display:flex; flex-direction:column; }
.print-body.full-bleed .attachment-section.pdf-attachment{ flex:1; display:flex; flex-direction:column; }
.print-body.full-bleed .attachment-section.pdf-attachment .attachment-frame{ flex:1; height:100%; }
.print-title{ font-size:20px; font-weight:700; margin:0 0 12px; text-align:center; }
.print-subtitle{ font-size:14px; margin:0 0 18px; text-align:center; }
.print-table{ width:100%; border-collapse:collapse; font-size:12px; }
.print-table th,.print-table td{ border:1px solid #1f2f5c; padding:6px 8px; vertical-align:top; }
.print-table thead th{ background:#e5ecff; text-transform:uppercase; font-size:11px; letter-spacing:.6px; }
.print-table tbody tr:nth-child(even){ background:#f8faff; }
.opis-list{ list-style:none; padding:0; margin:24px 0 0; font-size:13px; }
.opis-list li{ display:flex; gap:12px; margin-bottom:8px; }
.opis-list span{ font-weight:600; min-width:90px; }
.letter-body{ font-size:13px; line-height:1.7; white-space:pre-wrap; }
.print-note{ color:#5a6285; font-size:11px; }
.section-heading{ font-size:18px; font-weight:600; margin:0 0 12px; text-align:left; }
.section-text{ font-size:13px; line-height:1.6; white-space:pre-wrap; }
.doc-list{ display:flex; flex-direction:column; gap:8px; font-size:13px; }
.doc-item{ display:flex; justify-content:space-between; gap:16px; border:1px solid #d9e1ff; border-radius:12px; padding:10px 14px; }
.doc-item strong{ font-weight:600; }
.dossier-table td > div{ margin-bottom:4px; }
.dossier-table td > div:last-child{ margin-bottom:0; }
.branding-block{ display:flex; flex-direction:column; gap:4px; }
.branding-block.align-center{ text-align:center; align-items:center; }
.branding-block.align-right{ text-align:right; align-items:flex-end; }
.branding-block img{ max-height:48px; max-width:200px; object-fit:contain; }
.attachment-section{ display:flex; flex-direction:column; gap:14px; font-size:13px; }
.attachment-section.bare{ gap:0; height:100%; flex:1; }
.attachment-section.bare .attachment-frame{ flex:1; }
.attachment-meta{ font-size:12px; color:#3f4b7f; display:flex; flex-direction:column; gap:4px; }
.attachment-frame{ border:1px solid #c9d4f9; border-radius:12px; padding:12px; background:#f6f8ff; min-height:640px; display:flex; align-items:center; justify-content:center; }
.attachment-frame.bare{ border:none; background:none; padding:0; min-height:0; height:100%; width:100%; }
.attachment-frame img{ max-width:100%; max-height:100%; object-fit:contain; border-radius:8px; }
.attachment-frame.bare img{ border-radius:0; width:100%; height:100%; object-fit:contain; }
.attachment-frame object,.attachment-frame embed,.attachment-frame iframe{ width:100%; height:100%; min-height:100%; border:none; border-radius:8px; background:#fff; display:block; }
.attachment-frame.bare object,.attachment-frame.bare embed,.attachment-frame.bare iframe{ border-radius:0; }
.attachment-section.pdf-attachment{ gap:12px; height:100%; }
.attachment-section.pdf-attachment .attachment-frame{ border:none; background:none; padding:0; min-height:auto; display:block; height:100%; }
.attachment-section.pdf-attachment .attachment-meta{ margin-bottom:12px; }
.attachment-section.pdf-attachment .attachment-frame object,
.attachment-section.pdf-attachment .attachment-frame embed,
.attachment-section.pdf-attachment .attachment-frame iframe{ border-radius:0; background:#fff; height:100%; }
.attachment-fallback{ font-size:11px; color:#5a6285; margin:6px 0 0; }
`;
const PRINT_DELAY = 350;
const PDF_PAGE_DIMENSIONS = {
  portrait: { width: 595.28, height: 841.89 },
  landscape: { width: 841.89, height: 595.28 },
};
const PDF_PAGE_PIXEL_DIMENSIONS = {
  portrait: { width: 794, height: 1123 },
  landscape: { width: 1123, height: 794 },
};
const attachmentRegistry = new Map();
let attachmentSequence = 1;
let activeViewerUrl = null;
const ESCAPE_MAP = {
  "&": "&amp;",
  "<": "&lt;",
  ">": "&gt;",
  "\"": "&quot;",
  "'": "&#039;",
};

function cloneBaseStandards(){
  return BASE_STANDARDS.map(item => ({
    ...item,
    fieldLabels: item.fieldLabels ? { ...item.fieldLabels } : { process: 'Proces', position: 'Pozi»õie' },
  }));
}

function normalizeStandard(raw){
  if(!raw || typeof raw !== 'object'){
    return null;
  }
  const id = typeof raw.id === 'string' && raw.id.trim() ? raw.id.trim() : null;
  if(!id){
    return null;
  }
  const base = BASE_STANDARDS.find(item => item.id === id);
  const label = typeof raw.label === 'string' && raw.label.trim()
    ? raw.label.trim()
    : base && base.label ? base.label : id;
  const type = raw.type === 'authorization' || raw.type === 'procedure' || raw.type === 'both'
    ? raw.type
    : (base && base.type ? base.type : 'authorization');
  const group = typeof raw.group === 'string' && raw.group.trim()
    ? raw.group.trim()
    : base && base.group ? base.group : 'ALTE';
  const fieldLabels = base && base.fieldLabels ? { ...base.fieldLabels } : { process: 'Proces', position: 'Pozi»õie' };
  if(raw.fieldLabels && typeof raw.fieldLabels === 'object'){
    if(raw.fieldLabels.process){
      fieldLabels.process = String(raw.fieldLabels.process);
    }
    if(raw.fieldLabels.position){
      fieldLabels.position = String(raw.fieldLabels.position);
    }
  }
  return { id, label, type, group, fieldLabels };
}

function ensureStandards(list){
  const normalized = new Map();
  (Array.isArray(list) ? list : []).map(normalizeStandard).filter(Boolean).forEach(entry => {
    normalized.set(entry.id, entry);
  });
  BASE_STANDARDS.forEach(base => {
    if(!normalized.has(base.id)){
      normalized.set(base.id, {
        ...base,
        fieldLabels: base.fieldLabels ? { ...base.fieldLabels } : { process: 'Proces', position: 'Pozi»õie' },
      });
    }
  });
  return Array.from(normalized.values());
}

function ensureStateStandards(){
  if(!state || !Array.isArray(state.standards)){
    if(!state){
      state = createDefaultState();
    }
    state.standards = ensureStandards(state && state.standards);
  }
  return state.standards;
}

function ensureGeneralSettings(){
  if(!state || typeof state !== 'object'){
    state = createDefaultState();
  }
  if(!state.generalSettings || typeof state.generalSettings !== 'object'){
    state.generalSettings = normalizeGeneralSettings();
  } else {
    state.generalSettings.inactivityMinutes = clampInactivityMinutes(state.generalSettings.inactivityMinutes);
  }
  return state.generalSettings;
}

function getInactivityMinutes(){
  const settings = ensureGeneralSettings();
  return settings.inactivityMinutes;
}

function getInactivityTimeoutMs(){
  return getInactivityMinutes() * 60000;
}

function setGeneralInactivityMinutes(value){
  const minutes = clampInactivityMinutes(value);
  const settings = ensureGeneralSettings();
  if(settings.inactivityMinutes !== minutes){
    settings.inactivityMinutes = minutes;
    persistState();
  }
  restartInactivityTimer();
  return minutes;
}

function renderGeneralSettings(){
  const input = document.getElementById('general_inactivity_minutes');
  if(!input){
    return;
  }
  const minutes = getInactivityMinutes();
  if(Number(input.value) !== Number(minutes)){
    input.value = minutes;
  }
}

function clearInactivityTimer(){
  if(inactivityTimer){
    clearTimeout(inactivityTimer);
    inactivityTimer = null;
  }
}

function scheduleInactivityTimer(){
  clearInactivityTimer();
  if(!isAuthenticated){
    return;
  }
  const timeout = getInactivityTimeoutMs();
  if(timeout <= 0){
    return;
  }
  inactivityTimer = setTimeout(() => lockApplication('timeout'), timeout);
}

function restartInactivityTimer(){
  if(!isAuthenticated){
    clearInactivityTimer();
    return;
  }
  scheduleInactivityTimer();
}

function handleUserActivity(){
  if(!isAuthenticated){
    return;
  }
  scheduleInactivityTimer();
}

function bindInactivityListeners(){
  if(inactivityListenersBound){
    return;
  }
  inactivityListenersBound = true;
  ['mousemove', 'mousedown', 'keydown', 'touchstart', 'scroll'].forEach(eventName => {
    document.addEventListener(eventName, handleUserActivity, true);
  });
  window.addEventListener('focus', handleUserActivity);
  document.addEventListener('visibilitychange', () => {
    if(!document.hidden){
      handleUserActivity();
    }
  });
}

function updateAuthNotice(message){
  const notice = document.getElementById('auth_notice');
  if(!notice){
    return;
  }
  if(message){
    notice.textContent = message;
    notice.classList.add('visible');
  } else {
    notice.textContent = '';
    notice.classList.remove('visible');
  }
}

function lockApplication(reason){
  clearInactivityTimer();
  try {
    if(window.sessionStorage){
      window.sessionStorage.removeItem(AUTH_SESSION_KEY);
    }
  } catch (err) {
    console.warn('Nu s-a putut curƒÉ»õa sesiunea de autentificare.', err);
  }
  if(reason === 'timeout'){
    const minutes = getInactivityMinutes();
    updateAuthNotice(`Sesiunea a fost blocatƒÉ dupƒÉ ${minutes} minute de inactivitate. Reintrodu parola pentru a continua.`);
  } else {
    updateAuthNotice('');
  }
  setAuthenticationState(false);
}

function registerAttachment(attachment){
  if(!attachment || !attachment.data){
    return null;
  }
  const id = `att_${attachmentSequence++}`;
  attachmentRegistry.set(id, attachment);
  return id;
}

function getAttachmentById(id){
  return attachmentRegistry.get(id) || null;
}

function dataUrlToObjectUrl(dataUrl){
  try {
    if(!dataUrl || !dataUrl.startsWith('data:')){
      return dataUrl;
    }
    const parts = dataUrl.split(',');
    if(parts.length < 2){
      return dataUrl;
    }
    const meta = parts[0];
    const base64 = parts[1];
    const match = meta.match(/^data:([^;]+);base64$/i);
    if(!match){
      return dataUrl;
    }
    const mime = match[1];
    const binary = atob(base64);
    const length = binary.length;
    const bytes = new Uint8Array(length);
    for(let index = 0; index < length; index += 1){
      bytes[index] = binary.charCodeAt(index);
    }
    const blob = new Blob([bytes], { type: mime });
    return URL.createObjectURL(blob);
  } catch (error) {
    console.warn('Nu s-a putut converti documentul pentru previzualizare.', error);
    return dataUrl;
  }
}

function buildBrandingHtml(items, company){
  if(!items || items.length === 0){
    return '';
  }
  const spacing = getCompanyBrandingSpacing(company);
  const grouped = new Map();
  items.forEach(item => {
    if(!item){
      return;
    }
    const rowValue = Number(item.row);
    const row = Number.isInteger(rowValue) && rowValue > 0 ? rowValue : 1;
    if(!grouped.has(row)){
      grouped.set(row, []);
    }
    grouped.get(row).push(item);
  });
  const rows = Array.from(grouped.keys()).sort((a, b) => a - b);
  return rows.map(rowNumber => {
    const rowItems = grouped.get(rowNumber) || [];
    const rowContent = rowItems.map(item => {
      if(!item){
        return '';
      }
      const alignClass = item.align === 'center'
        ? ' align-center'
        : (item.align === 'right' ? ' align-right' : '');
      if(item.type === 'image' && item.data){
        return `<div class="branding-block${alignClass}"><img src="${item.data}" alt="Branding" /></div>`;
      }
      if(item.type === 'text' && item.content){
        const size = clampBrandingTextSize(item.size);
        return `<div class="branding-block${alignClass}" style="font-size:${size}px;">${escapeHtml(String(item.content)).replace(/\n/g, '<br />')}</div>`;
      }
      return '';
    }).join('');
    if(!rowContent){
      return '';
    }
    return `<div class="branding-row" style="--branding-gap:${spacing}px">${rowContent}</div>`;
  }).join('');
}

function renderPrintPage(options){
  const company = options && options.company ? options.company : getActiveCompany();
  const orientation = options && options.orientation ? options.orientation : 'portrait';
  const fullBleed = Boolean(options && options.fullBleed);
  const showBranding = options && options.showBranding !== undefined ? Boolean(options.showBranding) : true;
  const heading = fullBleed ? '' : (options && options.heading ? options.heading : '');
  const subheading = fullBleed ? '' : (options && options.subheading ? options.subheading : '');
  const content = options && options.content ? options.content : '';
  const branding = ensureReportBranding(company);
  const headerHtml = showBranding ? buildBrandingHtml(branding.header, company) : '';
  const footerHtml = showBranding ? buildBrandingHtml(branding.footer, company) : '';
  const headingHtml = heading ? `<h1 class="print-title">${heading}</h1>` : '';
  const subheadingHtml = subheading ? `<p class="print-subtitle">${subheading}</p>` : '';
  const bodyClasses = ['print-body'];
  if(fullBleed){
    bodyClasses.push('full-bleed');
  }
  if(options && options.bodyClass){
    bodyClasses.push(options.bodyClass);
  }
  const sectionClasses = ['print-document', orientation];
  if(fullBleed){
    sectionClasses.push('full-bleed');
  }
  if(!showBranding){
    sectionClasses.push('no-branding');
  }
  return `
    <section class="${sectionClasses.join(' ')}">
      <header class="print-header">${headerHtml}</header>
      <footer class="print-footer">${footerHtml}</footer>
      <div class="${bodyClasses.join(' ')}">
        ${headingHtml}
        ${subheadingHtml}
        ${content}
      </div>
    </section>
  `;
}

function openPrintPreview(config){
  const pages = config && Array.isArray(config.pages) ? config.pages.filter(Boolean) : [];
  if(pages.length === 0){
    alert('Nu existƒÉ con»õinut de tipƒÉrit.');
    return;
  }
  const title = config && config.title ? config.title : 'Raport';
  const printWindow = window.open('', '_blank');
  if(!printWindow){
    alert('Fereastra de tipƒÉrire a fost blocatƒÉ de browser.');
    return;
  }
  const htmlParts = [
    '<!DOCTYPE html><html lang="ro"><head><meta charset="utf-8" />',
    `<title>${escapeHtml(title)}</title>`,
    `<style>${PRINT_STYLES}</style>`,
    '</head><body>',
    pages.join(''),
    `<script>(function(){var PRINT_DELAY=${PRINT_DELAY};function triggerPrint(){setTimeout(function(){try{window.focus();}catch(e){}window.print();},PRINT_DELAY);}function cleanupObjectUrls(){var selectors=['object[data^="blob:"]','embed[src^="blob:"]','iframe[src^="blob:"]'];var nodes=Array.prototype.slice.call(document.querySelectorAll(selectors.join(',')));nodes.forEach(function(node){var attr=node.tagName==='OBJECT'?'data':'src';var value=node.getAttribute(attr);if(!value){return;}var base=value.split('#')[0];if(base&&base.indexOf('blob:')===0){try{URL.revokeObjectURL(base);}catch(err){}}});}window.addEventListener('beforeunload',cleanupObjectUrls);window.addEventListener('load',function(){var resources=Array.prototype.slice.call(document.querySelectorAll('object,embed,iframe,img'));if(resources.length===0){triggerPrint();return;}var remaining=resources.length;var fired=false;function resolveOne(){if(remaining>0){remaining-=1;}if(remaining<=0&&!fired){fired=true;if(fallback){clearTimeout(fallback);}triggerPrint();}}var fallback=setTimeout(function(){if(!fired){fired=true;triggerPrint();}},10000);resources.forEach(function(node){var settled=false;var waitTimer=null;function settle(){if(settled){return;}settled=true;if(waitTimer){clearTimeout(waitTimer);waitTimer=null;}resolveOne();}waitTimer=setTimeout(function(){settle();},5000);if(node.tagName==='IMG'){if(node.complete){settle();return;}node.addEventListener('load',settle,{once:true});node.addEventListener('error',settle,{once:true});return;}node.addEventListener('load',settle,{once:true});node.addEventListener('error',settle,{once:true});if(node.tagName==='IFRAME'){try{var doc=node.contentDocument;if(doc&&doc.readyState==='complete'){settle();}}catch(err){}}});});})();<\/script>`,
    '</body></html>',
  ];
  printWindow.document.open();
  printWindow.document.write(htmlParts.join(''));
  printWindow.document.close();
}

function getStandardById(id){
  if(!id){
    return null;
  }
  const standards = ensureStateStandards();
  return standards.find(entry => entry.id === id) || null;
}

function syncStandardsFromState(){
  const standards = ensureStateStandards();
  const known = new Map(standards.map(entry => [entry.id, entry]));
  let changed = false;
  if(state && Array.isArray(state.companies)){
    state.companies.forEach(company => {
      if(!company || !Array.isArray(company.qualifications)){
        return;
      }
      company.qualifications.forEach(q => {
        if(!q || !q.standard){
          return;
        }
        const id = String(q.standard);
        if(!known.has(id)){
          const type = q.category === 'procedee' ? 'procedure' : 'authorization';
          const entry = normalizeStandard({ id, label: id, type });
          if(entry){
            known.set(entry.id, entry);
            changed = true;
          }
        }
      });
    });
  }
  if(changed){
    state.standards = Array.from(known.values());
  }
}

function getStandardLabel(id){
  const entry = getStandardById(id);
  if(entry){
    return entry.label || entry.id;
  }
  const fallback = BASE_STANDARDS.find(item => item.id === id);
  return fallback ? fallback.label : (id || '');
}

function getFieldLabelsForStandard(standard){
  const entry = getStandardById(standard);
  if(entry && entry.fieldLabels){
    return {
      process: entry.fieldLabels.process || 'Proces',
      position: entry.fieldLabels.position || 'Pozi»õie',
    };
  }
  return { process: 'Proces', position: 'Pozi»õie' };
}

function getStandardsForType(type){
  return ensureStateStandards().filter(entry => entry && (entry.type === type || entry.type === 'both'));
}

function getAuthorizationGroups(){
  const groups = new Set();
  getStandardsForType('authorization').forEach(entry => {
    if(entry && entry.group){
      groups.add(entry.group);
    }
  });
  if(groups.size === 0){
    groups.add('ALTE');
  }
  return Array.from(groups);
}

function normalizeNameInput(raw){
  if(typeof raw !== 'string'){
    return '';
  }
  return raw.trim().replace(/\s+/g, ' ');
}

function getNameParts(value){
  const normalized = normalizeNameInput(value).toLowerCase();
  if(!normalized){
    return { full: '', family: '', given: '' };
  }
  const segments = normalized.split(' ');
  return {
    full: normalized,
    family: segments[0] || '',
    given: segments.slice(1).join(' ') || '',
  };
}

function normalizeAttachment(raw, fallbackName){
  if(!raw || typeof raw !== 'object'){
    return null;
  }
  const name = typeof raw.name === 'string' ? raw.name.trim() : '';
  const data = typeof raw.data === 'string' ? raw.data.trim() : '';
  const type = typeof raw.type === 'string' ? raw.type : '';
  if(!data){
    return null;
  }
  return {
    name: name || (fallbackName || 'document'),
    data,
    type,
  };
}

function normalizeWelderAttachment(raw, fallbackName){
  return normalizeAttachment(raw, fallbackName);
}

function clampBrandingTextSize(value){
  const numeric = Number(value);
  if(!Number.isFinite(numeric)){
    return 11;
  }
  return Math.min(Math.max(Math.round(numeric), 5), 28);
}

function clampBrandingSpacing(value){
  const numeric = Number(value);
  if(!Number.isFinite(numeric)){
    return 16;
  }
  return Math.min(Math.max(Math.round(numeric), 0), 120);
}

function clampInactivityMinutes(value){
  const numeric = Number(value);
  if(!Number.isFinite(numeric)){
    return 10;
  }
  return Math.min(Math.max(Math.round(numeric), 1), 120);
}

function normalizeBrandingItem(raw, fallbackName){
  if(!raw || typeof raw !== 'object'){
    return null;
  }
  const id = typeof raw.id === 'string' && raw.id.trim()
    ? raw.id.trim()
    : generateDocumentId('branding');
  const type = raw.type === 'image' ? 'image' : 'text';
  if(type === 'image'){
    const attachment = normalizeAttachment(raw, fallbackName || 'branding');
    if(!attachment){
      return null;
    }
    const align = raw && (raw.align === 'center' || raw.align === 'right')
      ? raw.align
      : 'left';
    const rowValue = Number(raw && raw.row);
    const row = Number.isInteger(rowValue) && rowValue > 0 ? rowValue : 1;
    return {
      id,
      type: 'image',
      name: attachment.name,
      data: attachment.data,
      mime: attachment.type || raw.mime || '',
      align,
      row,
    };
  }
  const content = typeof raw.content === 'string' ? raw.content.trim() : '';
  if(!content){
    return null;
  }
  const align = raw && (raw.align === 'center' || raw.align === 'right') ? raw.align : 'left';
  const size = clampBrandingTextSize(raw.size);
  const rowValue = Number(raw && raw.row);
  const row = Number.isInteger(rowValue) && rowValue > 0 ? rowValue : 1;
  return {
    id,
    type: 'text',
    content,
    align,
    size,
    row,
  };
}

function normalizeReportBranding(raw){
  const base = { header: [], footer: [] };
  if(!raw || typeof raw !== 'object'){
    return base;
  }
  ['header', 'footer'].forEach(section => {
    const entries = Array.isArray(raw[section]) ? raw[section] : [];
    base[section] = entries
      .map(item => normalizeBrandingItem(item, `${section}_branding`))
      .filter(Boolean);
  });
  return base;
}

function normalizeGeneralSettings(raw){
  const settings = { inactivityMinutes: 10 };
  if(!raw || typeof raw !== 'object'){
    return settings;
  }
  settings.inactivityMinutes = clampInactivityMinutes(raw.inactivityMinutes);
  return settings;
}

function normalizeMaterialDocumentMap(raw, prefix){
  const result = {};
  if(raw && typeof raw === 'object'){
    Object.keys(raw).forEach(key => {
      const list = Array.isArray(raw[key]) ? raw[key] : [];
      const normalized = list
        .map(item => normalizeDossierItem(item, `${prefix}_${key}`))
        .filter(Boolean);
      if(normalized.length > 0){
        result[key] = normalized;
      }
    });
  }
  return result;
}

function normalizeCustomStep(raw){
  if(!raw || typeof raw !== 'object'){
    return null;
  }
  const id = typeof raw.id === 'string' && raw.id.trim()
    ? raw.id.trim()
    : generateDocumentId('custep');
  const name = typeof raw.name === 'string' ? raw.name.trim() : '';
  const opis = typeof raw.opis === 'string' ? raw.opis.trim() : '';
  const attachments = Array.isArray(raw.attachments)
    ? raw.attachments.map(item => normalizeDossierItem(item, name || 'document_personalizat')).filter(Boolean)
    : [];
  return { id, name, opis, attachments };
}

function normalizeDossierEntry(raw){
  if(!raw || typeof raw !== 'object'){
    return null;
  }
  const id = typeof raw.id === 'string' && raw.id.trim()
    ? raw.id.trim()
    : generateDocumentId('dosrow');
  let welderId = null;
  if(raw.welder_id !== undefined && raw.welder_id !== null){
    const numeric = Number(raw.welder_id);
    welderId = Number.isNaN(numeric) ? null : numeric;
  }
  let qualificationId = null;
  if(raw.qualification_id !== undefined && raw.qualification_id !== null){
    const numeric = Number(raw.qualification_id);
    qualificationId = Number.isNaN(numeric) ? null : numeric;
  }
  let procedureId = null;
  if(raw.procedure_id !== undefined && raw.procedure_id !== null){
    const numeric = Number(raw.procedure_id);
    procedureId = Number.isNaN(numeric) ? null : numeric;
  }
  return {
    id,
    welder_id: welderId,
    welder_name: typeof raw.welder_name === 'string' ? raw.welder_name : '',
    panson_code: typeof raw.panson_code === 'string' ? raw.panson_code : '',
    process: raw && raw.process ? String(raw.process) : '',
    base_quality: raw && raw.base_quality ? String(raw.base_quality) : '',
    base_material: raw && raw.base_material ? String(raw.base_material) : '',
    filler_material: raw && raw.filler_material ? String(raw.filler_material) : '',
    position: raw && raw.position ? String(raw.position) : '',
    base_dimension: raw && raw.base_dimension ? String(raw.base_dimension) : '',
    diameter: raw && raw.diameter ? String(raw.diameter) : '',
    thickness_domain: raw && raw.thickness_domain ? String(raw.thickness_domain) : '',
    observation: raw && raw.observation ? String(raw.observation) : '',
    source: raw && raw.source ? String(raw.source) : 'manual',
    qualification_id: qualificationId,
    procedure_id: procedureId,
  };
}

function normalizeAuthorizationDossier(raw){
  if(!raw || typeof raw !== 'object'){
    return null;
  }
  const id = typeof raw.id === 'string' && raw.id.trim()
    ? raw.id.trim()
    : generateDocumentId('authdos');
  const standard = typeof raw.standard === 'string' && raw.standard.trim()
    ? raw.standard.trim()
    : DEFAULT_AUTH_STANDARD;
  const entries = Array.isArray(raw.entries)
    ? raw.entries.map(normalizeDossierEntry).filter(Boolean)
    : [];
  const letter = typeof raw.letter === 'string' ? raw.letter : '';
  const styleRaw = raw && raw.letterStyle && typeof raw.letterStyle === 'object' ? raw.letterStyle : null;
  const letterStyle = {
    align: styleRaw && styleRaw.align === 'center' ? 'center' : 'left',
    bold: Boolean(styleRaw && styleRaw.bold),
    size: (() => {
      const value = styleRaw && styleRaw.size !== undefined ? Number(styleRaw.size) : NaN;
      return Number.isFinite(value) ? Math.min(24, Math.max(10, value)) : DEFAULT_LETTER_STYLE.size;
    })(),
  };
  const materialDocuments = {
    base: normalizeMaterialDocumentMap(raw && raw.materialDocuments && raw.materialDocuments.base
      ? raw.materialDocuments.base
      : raw && raw.baseMaterialDocuments, 'base'),
    filler: normalizeMaterialDocumentMap(raw && raw.materialDocuments && raw.materialDocuments.filler
      ? raw.materialDocuments.filler
      : raw && raw.fillerMaterialDocuments, 'filler'),
  };
  const name = typeof raw.name === 'string' ? raw.name : '';
  const createdAt = raw && raw.created_at ? raw.created_at : new Date().toISOString();
  const customSteps = Array.isArray(raw.customSteps)
    ? raw.customSteps.map(normalizeCustomStep).filter(Boolean)
    : [];
  return {
    id,
    standard,
    entries,
    letter,
    letterStyle,
    materialDocuments,
    name,
    created_at: createdAt,
    customSteps,
  };
}

function readFileAsDataURL(file){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(reader.error || new Error('Eroare la citirea fi»ôierului.'));
    reader.readAsDataURL(file);
  });
}

let state = loadState();
ensureStateStandards();
syncStandardsFromState();
ensureGeneralSettings();
let isAuthenticated = false;
let selectedWelder = null;
let selectedWelderPosition = null;
let welderModalMode = 'create';
let welderSearchTerm = '';
let archiveVisible = false;
let archiveSearchTerm = '';
let pansonArchiveVisible = false;
let activeAuthGroup = getAuthorizationGroups()[0] || 'ALTE';
let activeAuthorizationExistingGroup = null;
let activeAuthorizationDossierId = null;
let brandingModalCompanyId = null;
let inactivityTimer = null;
let inactivityListenersBound = false;

function updateAuthorizationFieldLabels(){
  const select = document.getElementById('auth_standard');
  const standard = select && select.value ? select.value : DEFAULT_AUTH_STANDARD;
  const config = getFieldLabelsForStandard(standard);
  const processLabel = document.getElementById('auth_process_label');
  if(processLabel){
    processLabel.textContent = config && config.process ? config.process : 'Proces';
  }
  const positionLabel = document.getElementById('auth_position_label');
  if(positionLabel){
    positionLabel.textContent = config && config.position ? config.position : 'Pozi»õie';
  }
}

function populateAuthStandardSelect(){
  const select = document.getElementById('auth_standard');
  if(!select){
    return;
  }
  const standards = getStandardsForType('authorization').filter(item => {
    const group = item && item.group ? item.group : 'ALTE';
    return group === activeAuthGroup;
  });
  const currentValue = select.value;
  select.innerHTML = '';
  if(standards.length === 0){
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = '‚Äî';
    select.appendChild(placeholder);
    select.value = '';
    updateAuthorizationFieldLabels();
    return;
  }
  standards.forEach(item => {
    const option = document.createElement('option');
    option.value = item.id;
    option.textContent = item.label || item.id;
    select.appendChild(option);
  });
  let targetValue = standards.find(item => item.id === currentValue)?.id
    || (standards[0] ? standards[0].id : DEFAULT_AUTH_STANDARD);
  select.value = targetValue;
  updateAuthorizationFieldLabels();
}

function setActiveAuthGroup(group){
  const groups = getAuthorizationGroups();
  const next = groups.includes(group) ? group : (groups[0] || 'ALTE');
  activeAuthGroup = next;
  const tabContainer = document.getElementById('auth_standard_tabs');
  if(tabContainer){
    tabContainer.querySelectorAll('button').forEach(button => {
      const value = button.getAttribute('data-group');
      const isActive = value === next;
      button.classList.toggle('active', isActive);
      button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
  }
  populateAuthStandardSelect();
  loadAuthorizations();
}

function renderAuthStandardTabs(){
  const container = document.getElementById('auth_standard_tabs');
  if(!container){
    return;
  }
  container.innerHTML = '';
  const groups = getAuthorizationGroups();
  if(groups.length === 0){
    container.classList.add('hidden');
    activeAuthGroup = 'ALTE';
    populateAuthStandardSelect();
    return;
  }
  container.classList.remove('hidden');
  groups.forEach(group => {
    const button = document.createElement('button');
    button.type = 'button';
    button.textContent = group;
    button.dataset.group = group;
    button.addEventListener('click', () => setActiveAuthGroup(group));
    container.appendChild(button);
  });
  if(!groups.includes(activeAuthGroup)){
    activeAuthGroup = groups[0];
  }
  setActiveAuthGroup(activeAuthGroup);
}

function activateSubTab(containerId, tabName){
  const container = document.getElementById(containerId);
  if(!container || !tabName){
    return;
  }
  const prefix = tabName.includes('_') ? tabName.split('_')[0] : '';
  container.querySelectorAll('button').forEach(button => {
    const value = button.getAttribute('data-tab');
    const isActive = value === tabName;
    button.classList.toggle('active', isActive);
    button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });
  const host = container.closest('.content');
  if(!host){
    return;
  }
  host.querySelectorAll('.subtab-panel').forEach(panel => {
    const panelName = panel.getAttribute('data-panel');
    if(prefix && panelName && !panelName.startsWith(prefix)){
      return;
    }
    const match = panelName === tabName;
    panel.classList.toggle('active', match);
    panel.setAttribute('aria-hidden', match ? 'false' : 'true');
  });
}

function initSubTabs(containerId, defaultTab){
  const container = document.getElementById(containerId);
  if(!container){
    return;
  }
  container.querySelectorAll('button').forEach(button => {
    button.addEventListener('click', () => {
      const value = button.getAttribute('data-tab');
      if(value){
        activateSubTab(containerId, value);
      }
    });
  });
  const initial = defaultTab
    || (container.querySelector('button.active') && container.querySelector('button.active').getAttribute('data-tab'))
    || (container.querySelector('button') && container.querySelector('button').getAttribute('data-tab'));
  if(initial){
    activateSubTab(containerId, initial);
  }
}

function generateDocumentId(prefix){
  const base = prefix || 'doc';
  const random = Math.random().toString(36).slice(2, 8);
  return `${base}_${Date.now().toString(36)}_${random}`;
}

function joinRomanianList(items){
  const filtered = (Array.isArray(items) ? items : []).map(item => item && item.trim ? item.trim() : String(item || '')).filter(Boolean);
  if(filtered.length === 0){
    return '';
  }
  if(filtered.length === 1){
    return filtered[0];
  }
  if(filtered.length === 2){
    return `${filtered[0]} »ôi ${filtered[1]}`;
  }
  const leading = filtered.slice(0, -1).join(', ');
  return `${leading} »ôi ${filtered[filtered.length - 1]}`;
}

function setAuthenticationState(flag){
  const overlay = document.getElementById('auth_overlay');
  if(flag){
    isAuthenticated = true;
    if(overlay){
      overlay.classList.add('hidden');
      overlay.setAttribute('aria-hidden', 'true');
    }
    document.body.classList.remove('auth-locked');
    updateAuthNotice('');
    bindInactivityListeners();
    scheduleInactivityTimer();
  } else {
    isAuthenticated = false;
    if(overlay){
      overlay.classList.remove('hidden');
      overlay.setAttribute('aria-hidden', 'false');
    }
    document.body.classList.add('auth-locked');
    clearInactivityTimer();
  }
}

function initAuthentication(){
  const overlay = document.getElementById('auth_overlay');
  const form = document.getElementById('auth_form');
  if(!overlay || !form){
    return;
  }
  const errorBox = document.getElementById('auth_error');
  const userInput = document.getElementById('auth_user');
  const passInput = document.getElementById('auth_pass');
  let sessionValue = null;
  try {
    if(window.sessionStorage){
      sessionValue = window.sessionStorage.getItem(AUTH_SESSION_KEY);
    }
  } catch (err) {
    console.warn('Session storage indisponibil pentru autentificare.', err);
  }
  if(sessionValue === '1'){
    setAuthenticationState(true);
  } else {
    setAuthenticationState(false);
    updateAuthNotice('');
  }
  form.addEventListener('submit', event => {
    event.preventDefault();
    const username = userInput && typeof userInput.value === 'string' ? userInput.value.trim() : '';
    const password = passInput && typeof passInput.value === 'string' ? passInput.value : '';
    if(username === AUTH_USERNAME && password === AUTH_PASSWORD){
      try {
        if(window.sessionStorage){
          window.sessionStorage.setItem(AUTH_SESSION_KEY, '1');
        }
      } catch (err) {
        console.warn('Nu s-a putut salva sesiunea de autentificare.', err);
      }
      if(errorBox){
        errorBox.classList.remove('visible');
      }
      setAuthenticationState(true);
      return;
    }
    if(errorBox){
      errorBox.textContent = 'Utilizator sau parolƒÉ incorecte.';
      errorBox.classList.add('visible');
    }
    if(passInput){
      passInput.value = '';
      passInput.focus();
    }
  });
  if(!isAuthenticated && userInput){
    setTimeout(() => {
      try { userInput.focus(); } catch (err) { /* ignore */ }
    }, 100);
  }
}

function normalizeDossierItem(raw, fallbackName){
  if(!raw || typeof raw !== 'object'){
    return null;
  }
  const attachment = normalizeAttachment(raw, fallbackName);
  if(!attachment){
    return null;
  }
  const id = typeof raw.id === 'string' && raw.id.trim()
    ? raw.id.trim()
    : generateDocumentId('doc');
  const addedAt = raw && raw.added_at ? raw.added_at : new Date().toISOString();
  return {
    id,
    ...attachment,
    added_at: addedAt,
  };
}

function normalizeAuthorizationArchiveEntry(raw){
  if(!raw || typeof raw !== 'object'){
    return null;
  }
  const idValue = Number(raw.id);
  const id = Number.isInteger(idValue) && idValue > 0 ? idValue : 0;
  const name = typeof raw.name === 'string' && raw.name.trim() ? raw.name.trim() : 'Dosar PDF';
  const standard = typeof raw.standard === 'string' && raw.standard.trim() ? raw.standard.trim() : null;
  const savedAt = raw.saved_at || raw.savedAt || null;
  const filename = typeof raw.filename === 'string' && raw.filename.trim() ? raw.filename.trim() : null;
  const data = typeof raw.data === 'string' ? raw.data : null;
  const pageCount = Number.isFinite(Number(raw.page_count)) && Number(raw.page_count) > 0
    ? Number(raw.page_count)
    : (Number.isFinite(Number(raw.pages)) && Number(raw.pages) > 0 ? Number(raw.pages) : null);
  const details = Array.isArray(raw.details)
    ? raw.details.map(detail => ({
      label: detail && detail.label ? String(detail.label) : 'Sec»õiune',
      startPage: Number.isFinite(Number(detail && detail.startPage)) ? Number(detail.startPage) : null,
      endPage: Number.isFinite(Number(detail && detail.endPage)) ? Number(detail.endPage) : null,
      pageCount: Number.isFinite(Number(detail && detail.pageCount)) ? Number(detail.pageCount) : null,
    }))
    : [];
  let snapshot = null;
  if(raw && raw.snapshot && typeof raw.snapshot === 'object'){
    try {
      snapshot = JSON.parse(JSON.stringify(raw.snapshot));
    } catch (error) {
      console.warn('Nu s-a putut normaliza structura snapshot-ului din arhivƒÉ.', error);
      snapshot = null;
    }
  }
  return {
    id,
    dossier_id: raw && raw.dossier_id !== undefined ? raw.dossier_id : null,
    name,
    standard,
    saved_at: savedAt,
    filename,
    data,
    page_count: pageCount,
    details,
    snapshot,
  };
}

function isBaseStandard(id){
  return BASE_STANDARDS.some(entry => entry.id === id);
}

function renderStandardManagerList(){
  const container = document.getElementById('auth_standard_list');
  if(!container){
    return;
  }
  const standards = getStandardsForType('authorization')
    .slice()
    .sort((a, b) => (a.label || a.id || '').localeCompare(b.label || b.id || '', 'ro', { sensitivity: 'base' }));
  container.innerHTML = '';
  if(standards.length === 0){
    const empty = document.createElement('p');
    empty.className = 'dossier-empty';
    empty.textContent = 'Nu existƒÉ standarde definite.';
    container.appendChild(empty);
    return;
  }
  standards.forEach(entry => {
    const row = document.createElement('div');
    row.className = 'standard-row';
    const info = document.createElement('div');
    info.innerHTML = `
      <strong>${escapeHtml(entry.label || entry.id)}</strong>
      <div class="standard-meta">
        <span>Cod: ${escapeHtml(entry.id)}</span>
        <span>Grup: ${escapeHtml(entry.group || 'ALTE')}</span>
      </div>
    `;
    row.appendChild(info);
    const actions = document.createElement('div');
    actions.className = 'attachment-actions';
    const editBtn = document.createElement('button');
    editBtn.type = 'button';
    editBtn.className = 'btn ghost small';
    editBtn.textContent = 'EditeazƒÉ';
    editBtn.addEventListener('click', () => editAuthorizationStandard(entry.id));
    actions.appendChild(editBtn);
    if(!isBaseStandard(entry.id)){
      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'btn ghost small';
      deleteBtn.textContent = '»òterge';
      deleteBtn.addEventListener('click', () => deleteAuthorizationStandard(entry.id));
      actions.appendChild(deleteBtn);
    }
    row.appendChild(actions);
    container.appendChild(row);
  });
}

function toggleStandardManager(forceState){
  const panel = document.getElementById('auth_standard_manager');
  if(!panel){
    return;
  }
  const shouldShow = typeof forceState === 'boolean'
    ? forceState
    : !panel.classList.contains('visible');
  panel.classList.toggle('visible', shouldShow);
  panel.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
  if(shouldShow){
    renderStandardManagerList();
  }
}

function sanitizeStandardId(label){
  const raw = label.toUpperCase().replace(/[^A-Z0-9]+/g, '_').replace(/^_+|_+$/g, '');
  return raw || 'STD';
}

function createUniqueStandardId(baseId){
  const standards = ensureStateStandards();
  let candidate = baseId;
  let counter = 1;
  while(standards.some(entry => entry.id === candidate)){
    candidate = `${baseId}_${++counter}`;
  }
  return candidate;
}

function addAuthorizationStandard(){
  const namePrompt = prompt('Denumirea noului standard de autorizare:');
  if(namePrompt === null){
    return;
  }
  const label = namePrompt.trim();
  if(!label){
    alert('Denumirea standardului este obligatorie.');
    return;
  }
  const groupPrompt = prompt('Grupul √Æn care sƒÉ fie afi»ôat (ex: ASME, ISO, AWS, ALTE):', activeAuthGroup || 'ALTE');
  if(groupPrompt === null){
    return;
  }
  const group = groupPrompt.trim() || 'ALTE';
  const baseId = sanitizeStandardId(label);
  const id = createUniqueStandardId(baseId);
  const standards = ensureStateStandards();
  standards.push({
    id,
    label,
    type: 'authorization',
    group,
    fieldLabels: { process: 'Proces sudare', position: 'Pozi»õie' },
  });
  activeAuthGroup = group;
  syncStandardsFromState();
  persistState();
  renderAuthStandardTabs();
  renderStandardManagerList();
  alert(`Standardul ${label} a fost adƒÉugat.`);
}

function editAuthorizationStandard(id){
  const standard = getStandardById(id);
  if(!standard){
    return;
  }
  const namePrompt = prompt('ActualizeazƒÉ denumirea standardului:', standard.label || standard.id);
  if(namePrompt === null){
    return;
  }
  const label = namePrompt.trim();
  if(!label){
    alert('Denumirea standardului este obligatorie.');
    return;
  }
  const groupPrompt = prompt('ActualizeazƒÉ grupul:', standard.group || 'ALTE');
  if(groupPrompt === null){
    return;
  }
  const group = groupPrompt.trim() || 'ALTE';
  standard.label = label;
  standard.group = group;
  activeAuthGroup = group;
  syncStandardsFromState();
  persistState();
  renderAuthStandardTabs();
  renderStandardManagerList();
}

function deleteAuthorizationStandard(id){
  if(isBaseStandard(id)){
    alert('Standardele implicite nu pot fi »ôterse.');
    return;
  }
  const standards = ensureStateStandards();
  const index = standards.findIndex(entry => entry.id === id);
  if(index === -1){
    return;
  }
  const inUse = state.companies.some(company => Array.isArray(company.qualifications)
    && company.qualifications.some(q => q && q.category === 'autorizatii' && q.standard === id));
  if(inUse){
    alert('Standardul este folosit de autoriza»õii existente »ôi nu poate fi »ôters.');
    return;
  }
  if(!confirm('»òtergi acest standard personalizat?')){
    return;
  }
  standards.splice(index, 1);
  syncStandardsFromState();
  persistState();
  renderAuthStandardTabs();
  renderStandardManagerList();
}


function ensureAuthorizationDossiers(company){
  if(!company.authorizationDossiers || !Array.isArray(company.authorizationDossiers)){
    company.authorizationDossiers = [];
  }
  return company.authorizationDossiers;
}

function ensureAuthorizationDossierArchive(company){
  if(!company.authorizationDossierArchive || !Array.isArray(company.authorizationDossierArchive)){
    company.authorizationDossierArchive = [];
  }
  if(typeof company.nextAuthorizationDossierArchiveId !== 'number' || company.nextAuthorizationDossierArchiveId < 1){
    company.nextAuthorizationDossierArchiveId = 1;
  }
  return company.authorizationDossierArchive;
}

function ensureAuthorizationDossierSettings(company){
  if(!company.authorizationDossierSettings || typeof company.authorizationDossierSettings !== 'object'){
    company.authorizationDossierSettings = { pageNumbering: true };
  }
  if(typeof company.authorizationDossierSettings.pageNumbering !== 'boolean'){
    company.authorizationDossierSettings.pageNumbering = true;
  }
  return company.authorizationDossierSettings;
}

function getActiveAuthorizationDossier(company){
  const dossiers = ensureAuthorizationDossiers(company);
  if(dossiers.length === 0){
    activeAuthorizationDossierId = null;
    return null;
  }
  if(!activeAuthorizationDossierId || !dossiers.some(d => d && d.id === activeAuthorizationDossierId)){
    activeAuthorizationDossierId = dossiers[0].id;
  }
  return dossiers.find(d => d && d.id === activeAuthorizationDossierId) || null;
}

function handleCreateAuthorizationDossier(){
  const select = document.getElementById('auth_dossier_standard_select');
  if(!select){
    return;
  }
  const standard = select.value || DEFAULT_AUTH_STANDARD;
  const company = getActiveCompany();
  const dossier = normalizeAuthorizationDossier({
    id: generateDocumentId('authdos'),
    standard,
    entries: [],
    letter: '',
    letterStyle: { ...DEFAULT_LETTER_STYLE },
    materialDocuments: { base: {}, filler: {} },
    customSteps: [],
    created_at: new Date().toISOString(),
  });
  ensureAuthorizationDossiers(company).push(dossier);
  activeAuthorizationDossierId = dossier.id;
  persistState();
  renderAuthorizationDossierControls();
}

function renderAuthorizationDossierControls(){
  const company = getActiveCompany();
  const dossiers = ensureAuthorizationDossiers(company);
  renderAuthorizationDossierArchive();
  const standardSelect = document.getElementById('auth_dossier_standard_select');
  if(standardSelect){
    const previous = standardSelect.value;
    standardSelect.innerHTML = '';
    const standards = getStandardsForType('authorization');
    standards.forEach(standard => {
      const option = document.createElement('option');
      option.value = standard.id;
      option.textContent = standard.label || standard.id;
      standardSelect.appendChild(option);
    });
    if(previous && Array.from(standardSelect.options).some(opt => opt.value === previous)){
      standardSelect.value = previous;
    }
  }
  const switcher = document.getElementById('auth_dossier_switcher');
  const emptyState = document.getElementById('auth_dossier_empty_state');
  const detail = document.getElementById('auth_dossier_detail');
  if(!switcher || !emptyState || !detail){
    return;
  }
  switcher.innerHTML = '';
  if(dossiers.length === 0){
    emptyState.classList.remove('hidden');
    renderAuthorizationDossierDetail(null);
    return;
  }
  emptyState.classList.add('hidden');
  detail.classList.remove('hidden');
  dossiers.forEach(dossier => {
    if(!dossier || !dossier.id){
      return;
    }
    const button = document.createElement('button');
    button.type = 'button';
    const label = dossier.name && dossier.name.trim()
      ? dossier.name.trim()
      : `${getStandardLabel(dossier.standard)} ¬∑ ${new Date(dossier.created_at || Date.now()).toLocaleDateString('ro-RO')}`;
    button.textContent = label;
    button.dataset.id = dossier.id;
    const isActive = dossier.id === activeAuthorizationDossierId;
    button.classList.toggle('active', isActive);
    button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    button.addEventListener('click', () => {
      activeAuthorizationDossierId = dossier.id;
      renderAuthorizationDossierControls();
    });
    switcher.appendChild(button);
  });
  const active = getActiveAuthorizationDossier(company);
  renderAuthorizationDossierDetail(active);
}

function renderAuthorizationDossierDetail(dossier){
  const detail = document.getElementById('auth_dossier_detail');
  renderAuthorizationDossierArchive();
  if(!detail){
    return;
  }
  const editorBody = document.getElementById('auth_dossier_editor_body');
  const titleEl = document.getElementById('auth_dossier_title');
  const opisTitle = document.getElementById('auth_dossier_opis_title');
  const standardLabel = document.getElementById('auth_dossier_standard_label');
  const headerBar = detail.querySelector('.dossier-header-bar');
  if(!dossier){
    if(editorBody){
      editorBody.classList.add('hidden');
    }
    if(headerBar){
      headerBar.classList.add('hidden');
    }
    if(titleEl){
      titleEl.textContent = 'Nu existƒÉ dosar activ';
    }
    if(standardLabel){
      standardLabel.textContent = '';
    }
    if(opisTitle){
      opisTitle.innerHTML = '<div>OPIS</div><div>SelecteazƒÉ sau creeazƒÉ un dosar nou.</div>';
    }
    detail.classList.remove('hidden');
    return;
  }
  detail.classList.remove('hidden');
  if(editorBody){
    editorBody.classList.remove('hidden');
  }
  if(headerBar){
    headerBar.classList.remove('hidden');
  }
  const company = getActiveCompany();
  ensureDossierMaterialDocuments(dossier);
  ensureDossierLetterStyle(dossier);
  ensureDossierCustomSteps(dossier);
  if(titleEl){
    titleEl.textContent = computeDossierTitle(dossier);
  }
  if(opisTitle){
    const subtitle = computeDossierSubtitle(dossier);
    opisTitle.innerHTML = `<div>OPIS</div><div>${escapeHtml(subtitle)}</div>`;
  }
  if(standardLabel){
    standardLabel.textContent = getStandardLabel(dossier.standard);
  }
  const settings = ensureAuthorizationDossierSettings(company);
  const numberingCheckbox = document.getElementById('auth_dossier_page_numbers');
  if(numberingCheckbox){
    const shouldNumber = !settings || settings.pageNumbering !== false;
    if(numberingCheckbox.checked !== shouldNumber){
      numberingCheckbox.checked = shouldNumber;
    }
  }
  refreshAuthorizationDossierOpisList(dossier, company);
  const letterField = document.getElementById('auth_dossier_letter');
  if(letterField && letterField.value !== (dossier.letter || '')){
    letterField.value = dossier.letter || '';
  }
  const letterStyle = ensureDossierLetterStyle(dossier);
  const alignLeftBtn = document.getElementById('btn_letter_align_left');
  const alignCenterBtn = document.getElementById('btn_letter_align_center');
  if(alignLeftBtn){
    alignLeftBtn.classList.toggle('active', letterStyle.align !== 'center');
  }
  if(alignCenterBtn){
    alignCenterBtn.classList.toggle('active', letterStyle.align === 'center');
  }
  const boldBtn = document.getElementById('btn_letter_bold');
  if(boldBtn){
    boldBtn.classList.toggle('active', Boolean(letterStyle.bold));
  }
  const letterSizeInput = document.getElementById('auth_letter_size');
  if(letterSizeInput){
    const desired = letterStyle.size || DEFAULT_LETTER_STYLE.size;
    if(Number(letterSizeInput.value) !== Number(desired)){
      letterSizeInput.value = desired;
    }
  }
  populateAuthorizationDossierFormOptions(company);
  renderAuthorizationDossierTable(dossier, company);
  renderAuthorizationDossierProcedureDocs(dossier, company);
  renderAuthorizationDossierWelderDocs(dossier, company);
  renderAuthorizationDossierMaterialSections(dossier);
  renderAuthorizationDossierCustomSteps(dossier);
  renderAuthorizationDossierArchive();
}

let authorizationOpisRenderToken = 0;

function refreshAuthorizationDossierOpisList(dossier, company){
  const opisList = document.getElementById('auth_dossier_opis_list');
  if(!opisList){
    return;
  }
  const token = ++authorizationOpisRenderToken;
  opisList.innerHTML = '';
  const placeholder = document.createElement('li');
  placeholder.className = 'muted';
  placeholder.textContent = 'Se calculeazƒÉ paginile dosarului‚Ä¶';
  opisList.appendChild(placeholder);
  computeDossierOpis(dossier, company).then(items => {
    if(token !== authorizationOpisRenderToken){
      return;
    }
    opisList.innerHTML = '';
    if(!items || items.length === 0){
      const emptyItem = document.createElement('li');
      emptyItem.className = 'muted';
      emptyItem.textContent = 'Dosarul nu con»õine sec»õiuni.';
      opisList.appendChild(emptyItem);
      return;
    }
    items.forEach(item => {
      const li = document.createElement('li');
      const span = document.createElement('span');
      span.textContent = item.pageCount > 1
        ? `Pagina ${item.startPage}-${item.endPage}`
        : `Pagina ${item.startPage}`;
      const title = document.createElement('div');
      title.textContent = item.label;
      li.appendChild(span);
      li.appendChild(title);
      opisList.appendChild(li);
    });
  }).catch(error => {
    if(token !== authorizationOpisRenderToken){
      return;
    }
    console.error('Nu s-a putut actualiza opisul dosarului.', error);
    opisList.innerHTML = '';
    const errorItem = document.createElement('li');
    errorItem.className = 'muted';
    errorItem.textContent = 'Nu s-a putut calcula opisul.';
    opisList.appendChild(errorItem);
  });
}

function resolveProcedureLabel(company, procedureId){
  if(!procedureId){
    return '';
  }
  const numericId = Number(procedureId);
  if(Number.isNaN(numericId)){
    return '';
  }
  const procedure = company.qualifications.find(item => item && item.category === 'procedee' && item.id === numericId);
  if(!procedure){
    return '';
  }
  const parts = [getStandardLabel(procedure.standard)];
  if(procedure.process){
    parts.push(procedure.process);
  }
  if(procedure.position){
    parts.push(procedure.position);
  }
  return parts.filter(Boolean).join(' ¬∑ ');
}

function getAttachmentMimeType(attachment){
  if(!attachment || typeof attachment !== 'object'){
    return '';
  }
  if(attachment.type && typeof attachment.type === 'string' && attachment.type.trim()){
    return attachment.type.trim().toLowerCase();
  }
  if(attachment.data && typeof attachment.data === 'string'){
    const match = attachment.data.match(/^data:([^;,]+)[;,]/i);
    if(match && match[1]){
      return match[1].toLowerCase();
    }
  }
  return '';
}

function isPdfAttachment(attachment){
  const mime = getAttachmentMimeType(attachment);
  if(mime){
    return mime === 'application/pdf';
  }
  return Boolean(attachment && typeof attachment.data === 'string' && attachment.data.startsWith('data:application/pdf'));
}

function createPrintAttachmentEmbed(attachment, options){
  if(!attachment || !attachment.data){
    return '<p class="section-text">Document indisponibil pentru afi»ôare.</p>';
  }
  const mime = getAttachmentMimeType(attachment);
  const data = attachment.data;
  const objectUrl = dataUrlToObjectUrl(data);
  const source = objectUrl || data;
  const safeName = escapeHtml(attachment.name || 'document');
  const bare = Boolean(options && options.bare);
  const frameClasses = ['attachment-frame'];
  if(bare){
    frameClasses.push('bare');
  }
  if(mime && mime.startsWith('image/')){
    return `<div class="${frameClasses.join(' ')}"><img src="${source}" alt="${safeName}" /></div>`;
  }
  if(mime === 'application/pdf' || data.startsWith('data:application/pdf')){
    const hasHash = source.includes('#');
    const pdfSrc = `${source}${hasHash ? '&' : '#'}toolbar=0&navpanes=0&scrollbar=0&zoom=page-fit`;
    return `<div class="${frameClasses.join(' ')}"><object data="${pdfSrc}" type="application/pdf" aria-label="${safeName}"><embed src="${pdfSrc}" type="application/pdf" /></object></div>`;
  }
  return `<div class="${frameClasses.join(' ')}"><iframe src="${source}" title="${safeName}"></iframe></div>`;
}

function decodePdfSampleData(dataUrl){
  if(!dataUrl || typeof dataUrl !== 'string'){
    return '';
  }
  const commaIndex = dataUrl.indexOf(',');
  let base64 = commaIndex >= 0 ? dataUrl.slice(commaIndex + 1) : dataUrl;
  if(!base64){
    return '';
  }
  base64 = base64.replace(/\s+/g, '');
  if(!base64){
    return '';
  }
  const SAMPLE_LIMIT = 500000;
  let sample = base64.slice(0, SAMPLE_LIMIT);
  const padding = sample.length % 4;
  if(padding){
    sample = sample.padEnd(sample.length + (4 - padding), '=');
  }
  try {
    return atob(sample);
  } catch (error) {
    console.warn('Nu s-a putut decoda e»ôantionul PDF pentru orientare.', error);
    return '';
  }
}

function detectPdfOrientation(attachment){
  if(!isPdfAttachment(attachment)){
    return null;
  }
  const binary = decodePdfSampleData(attachment.data);
  if(!binary){
    return null;
  }
  const mediaBoxRegex = /\/MediaBox\s*\[\s*([-+]?\d*\.?\d+)\s+([-+]?\d*\.?\d+)\s+([-+]?\d*\.?\d+)\s+([-+]?\d*\.?\d+)\s*\]/g;
  let orientation = null;
  let match;
  let inspected = 0;
  while((match = mediaBoxRegex.exec(binary)) !== null){
    inspected += 1;
    const x1 = parseFloat(match[1]);
    const y1 = parseFloat(match[2]);
    const x2 = parseFloat(match[3]);
    const y2 = parseFloat(match[4]);
    if(!isFinite(x1) || !isFinite(y1) || !isFinite(x2) || !isFinite(y2)){
      continue;
    }
    const width = Math.abs(x2 - x1);
    const height = Math.abs(y2 - y1);
    if(width <= 0 || height <= 0){
      continue;
    }
    const pageOrientation = width > height ? 'landscape' : 'portrait';
    if(!orientation){
      orientation = pageOrientation;
    } else if(orientation !== pageOrientation){
      orientation = null;
      break;
    }
    if(inspected > 12){
      break;
    }
  }
  if(!orientation){
    return null;
  }
  const rotateMatch = /\/Rotate\s+(-?\d+)/.exec(binary);
  if(rotateMatch){
    const rotation = Math.abs(parseInt(rotateMatch[1], 10) || 0) % 360;
    if(rotation === 90 || rotation === 270){
      orientation = orientation === 'portrait' ? 'landscape' : 'portrait';
    }
  }
  return orientation;
}

function getAttachmentPrintOrientation(attachment){
  if(isPdfAttachment(attachment)){
    return detectPdfOrientation(attachment);
  }
  return null;
}

function createPrintAttachmentSection(options){
  const attachment = options && options.attachment ? options.attachment : null;
  const bare = Boolean(options && options.bare);
  const title = !bare && options && options.title ? `<h2 class="section-heading">${escapeHtml(options.title)}</h2>` : '';
  const details = [];
  if(!bare && options && options.subtitle){
    details.push(`<span>${escapeHtml(options.subtitle)}</span>`);
  }
  if(!bare && attachment && attachment.name){
    details.push(`<span>Fi»ôier: ${escapeHtml(attachment.name)}</span>`);
  }
  const meta = details.length ? `<div class="attachment-meta">${details.join('')}</div>` : '';
  const classes = ['attachment-section'];
  if(bare){
    classes.push('bare');
  }
  if(isPdfAttachment(attachment)){
    classes.push('pdf-attachment');
  }
  return `<div class="${classes.join(' ')}">${title}${meta}${createPrintAttachmentEmbed(attachment, { bare })}</div>`;
}

function gatherProceduresForEntries(entries, company){
  const map = new Map();
  (Array.isArray(entries) ? entries : []).forEach(entry => {
    if(!entry || !entry.procedure_id){
      return;
    }
    if(map.has(entry.procedure_id)){
      return;
    }
    const procedure = company.qualifications.find(q => q && q.category === 'procedee' && q.id === entry.procedure_id);
    if(procedure){
      map.set(entry.procedure_id, procedure);
    }
  });
  return Array.from(map.values()).sort((a, b) => {
    const labelA = resolveProcedureLabel(company, a.id) || '';
    const labelB = resolveProcedureLabel(company, b.id) || '';
    return labelA.localeCompare(labelB, 'ro', { sensitivity: 'base' });
  });
}

function findWelderRecordForDossier(welderId, company){
  if(!welderId){
    return null;
  }
  if(company){
    const active = Array.isArray(company.welders)
      ? company.welders.find(w => w && w.id === welderId)
      : null;
    if(active){
      return { welder: active, archived: false, company };
    }
    const archived = Array.isArray(company.archivedWelders)
      ? company.archivedWelders.find(entry => entry && entry.welder && entry.welder.id === welderId)
      : null;
    if(archived && archived.welder){
      return { welder: archived.welder, archived: true, company };
    }
  }
  if(state && Array.isArray(state.companies)){
    for(const otherCompany of state.companies){
      if(!otherCompany || otherCompany === company){
        continue;
      }
      const active = Array.isArray(otherCompany.welders)
        ? otherCompany.welders.find(w => w && w.id === welderId)
        : null;
      if(active){
        return { welder: active, archived: false, company: otherCompany };
      }
      const archived = Array.isArray(otherCompany.archivedWelders)
        ? otherCompany.archivedWelders.find(entry => entry && entry.welder && entry.welder.id === welderId)
        : null;
      if(archived && archived.welder){
        return { welder: archived.welder, archived: true, company: otherCompany };
      }
    }
  }
  return null;
}

function gatherWelderRecords(entries, company){
  const ids = new Set();
  (Array.isArray(entries) ? entries : []).forEach(entry => {
    if(entry && entry.welder_id){
      ids.add(entry.welder_id);
    }
  });
  const records = Array.from(ids).map(id => findWelderRecordForDossier(id, company)).filter(Boolean);
  records.sort((a, b) => {
    const nameA = a && a.welder && a.welder.name ? a.welder.name : '';
    const nameB = b && b.welder && b.welder.name ? b.welder.name : '';
    return nameA.localeCompare(nameB, 'ro', { sensitivity: 'base' });
  });
  return records;
}

function collectProcedureAttachmentSections(entries, company){
  const sections = [];
  const procedures = gatherProceduresForEntries(entries, company);
  procedures.forEach(proc => {
    if(!proc || !proc.attachment || !proc.attachment.data){
      return;
    }
    const label = resolveProcedureLabel(company, proc.id) || getStandardLabel(proc.standard) || 'Procedeu omologat';
    const orientation = getAttachmentPrintOrientation(proc.attachment) || 'portrait';
    sections.push({
      id: `procedure_attachment_${proc.id}`,
      label: `Procedeu omologat ‚Äì ${label}`,
      orientation,
      getContent: () => createPrintAttachmentSection({
        attachment: proc.attachment,
        bare: true,
      }),
      fullBleed: true,
      showBranding: false,
      attachment: proc.attachment,
    });
  });
  return sections;
}

function collectWelderAttachmentSections(entries, company){
  const sections = [];
  const records = gatherWelderRecords(entries, company);
  records.forEach(record => {
    const welder = record.welder;
    if(!welder){
      return;
    }
    const welderName = welder.name || 'Sudor';
    const infoParts = [];
    if(welder.code){
      infoParts.push(`Cod: ${welder.code}`);
    }
    if(welder.panson_id){
      const pansonCode = getPansonCodeById(welder.panson_id);
      if(pansonCode){
        infoParts.push(`Panson: ${pansonCode}`);
      }
    }
    const subtitle = infoParts.join(' ¬∑ ');
    if(welder.bundle && welder.bundle.data){
      const bundleOrientation = getAttachmentPrintOrientation(welder.bundle) || 'portrait';
      const suffix = subtitle ? ` (${subtitle})` : '';
      sections.push({
        id: `welder_attachment_${welder.id}_bundle`,
        label: `Documente personale ‚Äì ${welderName}${suffix}`,
        orientation: bundleOrientation,
        getContent: () => createPrintAttachmentSection({
          attachment: welder.bundle,
          bare: true,
        }),
        fullBleed: true,
        showBranding: false,
        attachment: welder.bundle,
      });
      return;
    }
    const attachmentKeys = [
      { key: 'id_card', label: 'Carte de identitate' },
      { key: 'diploma', label: 'DiplomƒÉ' },
      { key: 'contract', label: 'Contract de muncƒÉ' },
      { key: 'aptitude', label: 'Fi»ôƒÉ de aptitudini' },
    ];
    const suffix = subtitle ? ` (${subtitle})` : '';
    attachmentKeys.forEach(descriptor => {
      const attachment = welder[descriptor.key];
      if(!attachment || !attachment.data){
        return;
      }
      const orientation = getAttachmentPrintOrientation(attachment) || 'portrait';
      sections.push({
        id: `welder_attachment_${welder.id}_${descriptor.key}`,
        label: `${descriptor.label} ‚Äì ${welderName}${suffix}`,
        orientation,
        getContent: () => createPrintAttachmentSection({
          attachment,
          bare: true,
        }),
        fullBleed: true,
        showBranding: false,
        attachment,
      });
    });
  });
  return sections;
}

function collectMaterialAttachmentSections(dossier){
  if(!dossier){
    return [];
  }
  ensureDossierMaterialDocuments(dossier);
  const sections = [];
  const configs = [
    { key: 'base', label: 'Material de bazƒÉ', step: 'Pasul 6' },
    { key: 'filler', label: 'Material de adaos', step: 'Pasul 7' },
  ];
  configs.forEach(config => {
    const documentsMap = dossier.materialDocuments[config.key] || {};
    Object.keys(documentsMap).sort((a, b) => a.localeCompare(b, 'ro', { sensitivity: 'base' })).forEach(materialName => {
      const docs = Array.isArray(documentsMap[materialName]) ? documentsMap[materialName] : [];
      docs.forEach((doc, index) => {
        if(!doc || !doc.data){
          return;
        }
        const docId = doc.id ? String(doc.id) : `${materialName.replace(/\W+/g, '_')}_${index}`;
        const orientation = getAttachmentPrintOrientation(doc) || 'portrait';
        sections.push({
          id: `material_${config.key}_${docId}`,
          label: `${config.label} ‚Äì ${materialName}`,
          orientation,
          getContent: () => createPrintAttachmentSection({
            attachment: doc,
            bare: true,
          }),
          fullBleed: true,
          showBranding: false,
          attachment: doc,
        });
      });
    });
  });
  return sections;
}

function collectCustomStepSections(dossier){
  const sections = [];
  if(!dossier){
    return sections;
  }
  const steps = ensureDossierCustomSteps(dossier);
  steps.forEach(step => {
    const attachments = Array.isArray(step.attachments) ? step.attachments.filter(att => att && att.data) : [];
    if(attachments.length === 0){
      return;
    }
    const label = step.opis ? step.opis : (step.name || 'Pas suplimentar');
    sections.push({
      id: `custom_step_${step.id}`,
      label,
      attachments,
      fullBleed: true,
      showBranding: false,
    });
  });
  return sections;
}

function describeAuthorizationDossierSections(dossier, company){
  ensureDossierMaterialDocuments(dossier);
  const entries = Array.isArray(dossier && dossier.entries) ? dossier.entries.filter(Boolean) : [];
  const sections = [];
  const subtitle = computeDossierSubtitle(dossier);
  const letterStyle = ensureDossierLetterStyle(dossier);
  const letterText = dossier && dossier.letter && dossier.letter.trim()
    ? dossier.letter.trim()
    : 'AdresƒÉ necompletatƒÉ.';
  const letterWeight = letterStyle.bold ? 'font-weight:700;' : 'font-weight:400;';
  const letterAlign = letterStyle.align === 'center' ? 'text-align:center;' : 'text-align:left;';
  const letterSize = `font-size:${letterStyle.size || DEFAULT_LETTER_STYLE.size}px;`;
  const letterContent = `<div class="letter-body" style="${letterAlign}${letterWeight}${letterSize}">${escapeHtml(letterText).replace(/\n/g, '<br />')}</div>`;
  sections.push({
    id: 'letter',
    label: 'AdresƒÉ cƒÉtre organismul de calificare',
    heading: 'Pasul 2 ¬∑ AdresƒÉ cƒÉtre organismul de calificare',
    orientation: 'portrait',
    getContent: () => letterContent,
    showBranding: true,
    pageCount: 1,
  });

  const tableLabel = entries.length > 0
    ? 'Tabel autoriza»õii sudori'
    : 'Tabel autoriza»õii sudori (√Æn curs de completare)';
  sections.push({
    id: 'table',
    label: tableLabel,
    heading: 'Pasul 3 ¬∑ Tabel autoriza»õii sudori',
    orientation: 'landscape',
    getContent: () => buildAuthorizationDossierTablePrintHtml(entries, company),
    showBranding: true,
    pageCount: 1,
  });

  const attachmentSections = [
    ...collectProcedureAttachmentSections(entries, company),
    ...collectWelderAttachmentSections(entries, company),
    ...collectMaterialAttachmentSections(dossier),
    ...collectCustomStepSections(dossier),
  ].filter(Boolean);

  attachmentSections.forEach(section => {
    sections.push(section);
  });

  sections.subtitle = subtitle;
  return sections;
}

async function getAttachmentPageCount(attachment){
  if(!attachment || !attachment.data){
    return 1;
  }
  if(typeof attachment.pageCount === 'number' && attachment.pageCount > 0){
    return Math.max(1, Math.round(attachment.pageCount));
  }
  const mime = getAttachmentMimeType(attachment);
  if(mime === 'application/pdf' && window.PDFLib && window.PDFLib.PDFDocument){
    try {
      const bytes = dataUrlToUint8Array(attachment.data);
      const externalDoc = await window.PDFLib.PDFDocument.load(bytes);
      const pages = externalDoc.getPageCount ? externalDoc.getPageCount() : externalDoc.getPageIndices().length;
      if(pages && pages > 0){
        attachment.pageCount = pages;
        return pages;
      }
    } catch (error) {
      console.warn('Nu s-a putut detecta numƒÉrul de pagini al unui document PDF.', error);
    }
  }
  attachment.pageCount = 1;
  return 1;
}

async function resolveSectionPageCount(section){
  if(!section){
    return 1;
  }
  if(typeof section.pageCount === 'number' && section.pageCount > 0){
    return Math.max(1, Math.round(section.pageCount));
  }
  if(section.attachment){
    return Math.max(1, await getAttachmentPageCount(section.attachment));
  }
  if(Array.isArray(section.attachments) && section.attachments.length > 0){
    let total = 0;
    for(const attachment of section.attachments){
      total += Math.max(1, await getAttachmentPageCount(attachment));
    }
    return total || 1;
  }
  return 1;
}

async function buildAuthorizationDossierPagePlan(dossier, company){
  const sections = describeAuthorizationDossierSections(dossier, company) || [];
  const subtitle = sections.subtitle || computeDossierSubtitle(dossier);
  const details = [];
  for(const section of sections){
    const pageCount = await resolveSectionPageCount(section);
    details.push({
      section,
      label: section && section.label ? section.label : 'Sec»õiune',
      pageCount,
    });
  }
  let currentPage = 2;
  details.forEach(detail => {
    detail.startPage = currentPage;
    detail.endPage = currentPage + detail.pageCount - 1;
    currentPage = detail.endPage + 1;
  });
  return { sections, details, subtitle };
}

function computeDossierSubtitle(dossier){
  const entries = Array.isArray(dossier && dossier.entries) ? dossier.entries : [];
  const flags = new Set();
  entries.forEach(entry => {
    const observation = entry && entry.observation ? String(entry.observation).toLowerCase() : '';
    if(observation.includes('omolog')){
      flags.add('omologare');
    }
    if(observation.includes('prelung')){
      flags.add('prelungire');
    }
    if(observation.includes('autoriz')){
      flags.add('autorizare');
    }
  });
  if(flags.size === 0){
    return 'Dosar de autorizare sudori';
  }
  const hasOmolog = flags.has('omologare');
  const hasAutorizare = flags.has('autorizare');
  const hasPrelungire = flags.has('prelungire');
  if(flags.size === 1){
    if(hasOmolog){
      return 'Dosar de omologare procedee de sudare';
    }
    if(hasPrelungire){
      return 'Dosar de prelungire autoriza»õii sudori';
    }
    return 'Dosar de autorizare sudori';
  }
  const parts = [];
  if(hasOmolog){
    parts.push('omologare procedee de sudare');
  }
  if(hasAutorizare){
    parts.push('autorizare sudori');
  }
  if(hasPrelungire){
    parts.push('prelungire autoriza»õii sudori');
  }
  return `Dosar de ${joinRomanianList(parts)}`;
}

function computeDossierTitle(dossier){
  if(!dossier){
    return 'Dosar autorizare';
  }
  if(dossier.name && dossier.name.trim()){
    return dossier.name.trim();
  }
  const subtitle = computeDossierSubtitle(dossier);
  const standardLabel = getStandardLabel(dossier.standard);
  return `${subtitle} ‚Äì ${standardLabel}`;
}

async function computeDossierOpis(dossier, company){
  const plan = await buildAuthorizationDossierPagePlan(dossier, company);
  return plan.details.map(detail => ({
    label: detail.label,
    pageCount: detail.pageCount,
    startPage: detail.startPage,
    endPage: detail.endPage,
  }));
}

function buildAuthorizationDossierTablePrintHtml(entries, company){
  if(!entries || entries.length === 0){
    return '<p class="section-text">Tabelul nu con»õine √ÆncƒÉ √ÆnregistrƒÉri.</p>';
  }
  const rows = entries.map((entry, index) => {
    const welderName = entry && entry.welder_name ? escapeHtml(entry.welder_name) : '‚Äî';
    const panson = entry && entry.panson_code ? `<div class="print-note">${escapeHtml(entry.panson_code)}</div>` : '';
    const procedureLabel = resolveProcedureLabel(company, entry && entry.procedure_id);
    const processParts = [];
    if(entry && entry.process){
      processParts.push(escapeHtml(entry.process));
    }
    if(procedureLabel){
      processParts.push(`<div class="print-note">Procedeu: ${escapeHtml(procedureLabel)}</div>`);
    }
    const processCell = processParts.length ? processParts.join('') : '‚Äî';
    const baseQuality = entry && entry.base_quality ? escapeHtml(entry.base_quality) : '‚Äî';
    const baseMaterial = entry && entry.base_material ? `<div class="print-note">Material: ${escapeHtml(entry.base_material)}</div>` : '';
    const filler = entry && entry.filler_material ? escapeHtml(entry.filler_material) : '‚Äî';
    const position = entry && entry.position ? escapeHtml(entry.position) : '‚Äî';
    const baseDimension = entry && entry.base_dimension ? escapeHtml(entry.base_dimension) : '‚Äî';
    const diameter = entry && entry.diameter ? escapeHtml(entry.diameter) : '‚Äî';
    const domainParts = [];
    if(entry && entry.thickness_domain){
      domainParts.push(`<div>Domeniu: ${escapeHtml(entry.thickness_domain)}</div>`);
    }
    if(entry && entry.observation){
      domainParts.push(`<div class="print-note">Obs: ${escapeHtml(entry.observation)}</div>`);
    }
    const domainCell = domainParts.length ? domainParts.join('') : '‚Äî';
    return `
      <tr>
        <td>${index + 1}</td>
        <td>${welderName}${panson}</td>
        <td>${processCell}</td>
        <td>${baseQuality}${baseMaterial}</td>
        <td>${filler}</td>
        <td>${position}</td>
        <td>${baseDimension}</td>
        <td>${diameter}</td>
        <td>${domainCell}</td>
      </tr>
    `;
  }).join('');
  return `
    <table class="print-table dossier-table">
      <thead>
        <tr>
          <th>Nr. crt.</th>
          <th>Numele »ôi prenumele / Panson</th>
          <th>Procedee de sudare</th>
          <th>Calitatea materialului de bazƒÉ</th>
          <th>Materiale de adaos</th>
          <th>Pozi»õii de sudare</th>
          <th>Grosime material de bazƒÉ</th>
          <th>Diametru »õeavƒÉ</th>
          <th>Domeniu grosimi / Observa»õii</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function buildAuthorizationDossierProcedurePrintHtml(entries, company){
  const procedures = gatherProceduresForEntries(entries, company);
  if(procedures.length === 0){
    return '<p class="section-text">Nu existƒÉ procedee asociate √Æn tabel.</p>';
  }
  const items = procedures.map(proc => {
    const label = resolveProcedureLabel(company, proc.id) || getStandardLabel(proc.standard);
    const certificate = proc.certificate_no ? `Certificat: ${escapeHtml(proc.certificate_no)}` : 'Certificat: ‚Äî';
    const docInfo = proc.attachment && proc.attachment.name
      ? `Document: ${escapeHtml(proc.attachment.name)}`
      : 'Document: neata»ôat';
    return `
      <div class="doc-item">
        <div class="meta"><strong>${escapeHtml(label)}</strong><span>${certificate}</span></div>
        <div class="meta">${docInfo}</div>
      </div>
    `;
  });
  return `<div class="doc-list">${items.join('')}</div>`;
}

function buildAuthorizationDossierWelderDocsPrintHtml(entries, company){
  const records = gatherWelderRecords(entries, company);
  if(records.length === 0){
    return '<p class="section-text">Nu sunt selecta»õi sudori √Æn tabel.</p>';
  }
  const items = records.map(record => {
    const welder = record.welder;
    if(!welder){
      return '';
    }
    const docs = [];
    const attachmentFields = [
      ['Fotografie', welder.photo],
      ['Carte identitate', welder.id_card],
      ['DiplomƒÉ', welder.diploma],
      ['Contract de muncƒÉ', welder.contract],
      ['Fi»ôƒÉ aptitudini', welder.aptitude],
    ];
    attachmentFields.forEach(([label, attachment]) => {
      if(attachment && attachment.name){
        docs.push(`${label}: ${escapeHtml(attachment.name)}`);
      }
    });
    const docInfo = docs.length ? docs.join('<br>') : 'FƒÉrƒÉ documente disponibile';
    const welderInfo = [];
    if(welder.code){
      welderInfo.push(`Cod: ${escapeHtml(welder.code)}`);
    }
    if(welder.panson_id){
      const pansonCode = getPansonCodeById(welder.panson_id);
      if(pansonCode){
        welderInfo.push(`Panson: ${escapeHtml(pansonCode)}`);
      }
    }
    const subtitle = welderInfo.length ? `<span>${welderInfo.join(' ¬∑ ')}</span>` : '';
    return `
      <div class="doc-item">
        <div class="meta"><strong>${escapeHtml(welder.name || 'Sudor')}</strong>${subtitle}</div>
        <div class="meta">${docInfo}</div>
      </div>
    `;
  }).filter(Boolean);
  return `<div class="doc-list">${items.join('')}</div>`;
}

function buildAuthorizationDossierMaterialPrintHtml(type, dossier){
  ensureDossierMaterialDocuments(dossier);
  const collection = type === 'base' ? dossier.materialDocuments.base : dossier.materialDocuments.filler;
  const keys = Object.keys(collection || {});
  if(keys.length === 0){
    return '<p class="section-text">Nu au fost ata»ôate documente pentru aceastƒÉ categorie.</p>';
  }
  const items = keys.sort((a, b) => a.localeCompare(b, 'ro', { sensitivity: 'base' })).map(material => {
    const docs = Array.isArray(collection[material]) ? collection[material] : [];
    const names = docs.length
      ? docs.map(doc => escapeHtml(doc.name || 'document')).join('<br>')
      : 'FƒÉrƒÉ documente ata»ôate';
    return `
      <div class="doc-item">
        <div class="meta"><strong>${escapeHtml(material)}</strong><span>${type === 'base' ? 'Material de bazƒÉ' : 'Material de adaos'}</span></div>
        <div class="meta">${names}</div>
      </div>
    `;
  });
  return `<div class="doc-list">${items.join('')}</div>`;
}

function populateAuthorizationDossierFormOptions(company){
  const welderSelect = document.getElementById('auth_dossier_row_welder');
  if(welderSelect){
    const previous = welderSelect.value;
    welderSelect.innerHTML = '<option value="">SelecteazƒÉ sudor</option>';
    sortWelders(company.welders).forEach(welder => {
      const option = document.createElement('option');
      option.value = String(welder.id);
      option.textContent = welder.name;
      welderSelect.appendChild(option);
    });
    if(previous && Array.from(welderSelect.options).some(opt => opt.value === previous)){
      welderSelect.value = previous;
    } else {
      welderSelect.value = '';
    }
  }
  const procedureSelect = document.getElementById('auth_dossier_row_procedure');
  if(procedureSelect){
    const previous = procedureSelect.value;
    procedureSelect.innerHTML = '<option value="">FƒÉrƒÉ asociere</option>';
    company.qualifications.filter(q => q && q.category === 'procedee')
      .sort((a, b) => {
        const labelA = `${getStandardLabel(a.standard)} ${a.process || ''}`;
        const labelB = `${getStandardLabel(b.standard)} ${b.process || ''}`;
        return labelA.localeCompare(labelB, 'ro', { sensitivity: 'base' });
      })
      .forEach(proc => {
        const option = document.createElement('option');
        option.value = String(proc.id);
        option.textContent = `${getStandardLabel(proc.standard)} ¬∑ ${proc.process || ''}`;
        procedureSelect.appendChild(option);
      });
    if(previous && Array.from(procedureSelect.options).some(opt => opt.value === previous)){
      procedureSelect.value = previous;
    } else {
      procedureSelect.value = '';
    }
    procedureSelect.disabled = procedureSelect.options.length <= 1;
  }
  clearAuthorizationDossierForm();
}

function clearAuthorizationDossierForm(){
  ['auth_dossier_row_process','auth_dossier_row_base','auth_dossier_row_material','auth_dossier_row_filler','auth_dossier_row_position','auth_dossier_row_dimension','auth_dossier_row_diameter','auth_dossier_row_domain','auth_dossier_row_observation'].forEach(id => {
    const input = document.getElementById(id);
    if(input){
      input.value = '';
    }
  });
  const welderSelect = document.getElementById('auth_dossier_row_welder');
  if(welderSelect){
    welderSelect.value = '';
  }
  const procedureSelect = document.getElementById('auth_dossier_row_procedure');
  if(procedureSelect){
    procedureSelect.value = '';
  }
}

function handleAddAuthorizationDossierRow(){
  const company = getActiveCompany();
  const dossier = getActiveAuthorizationDossier(company);
  if(!dossier){
    alert('CreeazƒÉ mai √Ænt√¢i un dosar de autorizare.');
    return;
  }
  const welderSelect = document.getElementById('auth_dossier_row_welder');
  const procedureSelect = document.getElementById('auth_dossier_row_procedure');
  const getValue = id => {
    const input = document.getElementById(id);
    return input && input.value ? input.value.trim() : '';
  };
  const welderIdValue = welderSelect && welderSelect.value ? Number(welderSelect.value) : NaN;
  const welderId = Number.isNaN(welderIdValue) ? null : welderIdValue;
  const welder = welderId ? company.welders.find(w => w.id === welderId) : null;
  const procedureIdValue = procedureSelect && procedureSelect.value ? Number(procedureSelect.value) : NaN;
  const procedureId = Number.isNaN(procedureIdValue) ? null : procedureIdValue;
  const entryPayload = {
    id: generateDocumentId('dosrow'),
    welder_id: welder ? welder.id : null,
    welder_name: welder ? welder.name : '',
    panson_code: (() => {
      if(!welder){
        return '';
      }
      if(welder.panson_id){
        const panson = company.pansoane.find(p => p && p.id === welder.panson_id);
        if(panson && panson.code){
          return panson.code;
        }
      }
      return welder.code || '';
    })(),
    process: getValue('auth_dossier_row_process'),
    base_quality: getValue('auth_dossier_row_base'),
    base_material: getValue('auth_dossier_row_material'),
    filler_material: getValue('auth_dossier_row_filler'),
    position: getValue('auth_dossier_row_position'),
    base_dimension: getValue('auth_dossier_row_dimension'),
    diameter: getValue('auth_dossier_row_diameter'),
    thickness_domain: getValue('auth_dossier_row_domain'),
    observation: getValue('auth_dossier_row_observation'),
    source: 'manual',
    qualification_id: null,
    procedure_id: procedureId,
  };
  const hasContent = entryPayload.welder_id
    || entryPayload.process
    || entryPayload.base_quality
    || entryPayload.base_material
    || entryPayload.filler_material
    || entryPayload.position
    || entryPayload.base_dimension
    || entryPayload.diameter
    || entryPayload.thickness_domain
    || entryPayload.observation;
  if(!hasContent){
    alert('CompleteazƒÉ cel pu»õin un c√¢mp pentru a adƒÉuga r√¢ndul.');
    return;
  }
  const normalized = normalizeDossierEntry(entryPayload);
  dossier.entries.push(normalized);
  persistState();
  clearAuthorizationDossierForm();
  renderAuthorizationDossierDetail(dossier);
}

function pushAuthorizationToDossier(qualificationId, mode){
  const company = getActiveCompany();
  const dossier = getActiveAuthorizationDossier(company);
  if(!dossier){
    alert('CreeazƒÉ »ôi selecteazƒÉ un dosar de autorizare √Ænainte de a importa autoriza»õii.');
    return;
  }
  const qualification = company.qualifications.find(q => q && q.id === qualificationId && q.category === 'autorizatii');
  if(!qualification){
    alert('Autoriza»õia selectatƒÉ nu a fost gƒÉsitƒÉ.');
    return;
  }
  const welder = qualification.welder_id ? company.welders.find(w => w.id === qualification.welder_id) : null;
  const pansonCode = (() => {
    if(!welder){
      return '';
    }
    if(welder.panson_id){
      const panson = company.pansoane.find(p => p && p.id === welder.panson_id);
      if(panson && panson.code){
        return panson.code;
      }
    }
    return welder.code || '';
  })();
  const baseObservation = mode === 'prelungire'
    ? 'Prelungire autoriza»õie'
    : 'Autorizare';
  const observation = qualification.observation
    ? `${baseObservation} ‚Äì ${qualification.observation}`
    : baseObservation;
  const normalized = normalizeDossierEntry({
    id: generateDocumentId('dosrow'),
    welder_id: welder ? welder.id : null,
    welder_name: welder ? welder.name : '',
    panson_code: pansonCode,
    process: qualification.process || '',
    base_quality: qualification.base_quality || '',
    base_material: qualification.base_material || '',
    filler_material: qualification.filler_material || '',
    position: qualification.position || '',
    base_dimension: qualification.base_dimension || '',
    diameter: qualification.diameter || '',
    observation,
    source: mode === 'prelungire' ? 'prelungire' : 'reautorizare',
    qualification_id: qualification.id,
    procedure_id: qualification.procedure_id || null,
    thickness_domain: qualification.thickness_domain || '',
  });
  dossier.entries.push(normalized);
  persistState();
  renderAuthorizationDossierDetail(dossier);
}

function updateAuthorizationDossierLetter(value){
  const company = getActiveCompany();
  const dossier = getActiveAuthorizationDossier(company);
  if(!dossier){
    return;
  }
  dossier.letter = value || '';
  persistState();
}

function updateAuthorizationDossierLetterStyle(partial){
  const company = getActiveCompany();
  const dossier = getActiveAuthorizationDossier(company);
  if(!dossier){
    return;
  }
  const style = ensureDossierLetterStyle(dossier);
  if(partial && Object.prototype.hasOwnProperty.call(partial, 'align')){
    style.align = partial.align === 'center' ? 'center' : 'left';
  }
  if(partial && Object.prototype.hasOwnProperty.call(partial, 'bold')){
    style.bold = Boolean(partial.bold);
  }
  if(partial && Object.prototype.hasOwnProperty.call(partial, 'size')){
    const value = Number(partial.size);
    if(Number.isFinite(value)){
      style.size = Math.min(24, Math.max(10, value));
    }
  }
  persistState();
  renderAuthorizationDossierDetail(dossier);
}

function handleDeleteAuthorizationDossier(){
  const company = getActiveCompany();
  const dossier = getActiveAuthorizationDossier(company);
  if(!dossier){
    return;
  }
  if(!confirm('»òtergi acest dosar de autorizare? Opera»õia nu poate fi anulatƒÉ.')){
    return;
  }
  const dossiers = ensureAuthorizationDossiers(company);
  const index = dossiers.findIndex(entry => entry && entry.id === dossier.id);
  if(index !== -1){
    dossiers.splice(index, 1);
  }
  if(dossiers.length === 0){
    activeAuthorizationDossierId = null;
  } else if(!dossiers.some(entry => entry.id === activeAuthorizationDossierId)){
    activeAuthorizationDossierId = dossiers[0].id;
  }
  persistState();
  renderAuthorizationDossierControls();
}

function resetAuthorizationDossier(dossier){
  if(!dossier){
    return;
  }
  dossier.entries = [];
  dossier.letter = '';
  dossier.letterStyle = { ...DEFAULT_LETTER_STYLE };
  dossier.materialDocuments = { base: {}, filler: {} };
  ensureDossierMaterialDocuments(dossier);
  ensureDossierLetterStyle(dossier);
  dossier.customSteps = [];
}

function slugifyForFilename(value, fallback){
  const safeFallback = fallback || 'document';
  if(!value || typeof value !== 'string'){
    return safeFallback;
  }
  const normalized = value.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  const cleaned = normalized.replace(/[^a-zA-Z0-9]+/g, '-').replace(/^-+|-+$/g, '').toLowerCase();
  return cleaned || safeFallback;
}

function dataUrlToUint8Array(dataUrl){
  if(!dataUrl || typeof dataUrl !== 'string'){
    return new Uint8Array();
  }
  const commaIndex = dataUrl.indexOf(',');
  const base64 = (commaIndex >= 0 ? dataUrl.slice(commaIndex + 1) : dataUrl).replace(/\s+/g, '');
  let binary;
  try {
    binary = atob(base64);
  } catch (error) {
    console.error('Conversia datelor √Æn format binar a e»ôuat.', error);
    return new Uint8Array();
  }
  const length = binary.length;
  const bytes = new Uint8Array(length);
  for(let index = 0; index < length; index += 1){
    bytes[index] = binary.charCodeAt(index);
  }
  return bytes;
}

function uint8ArrayToBase64(bytes){
  if(!bytes || typeof bytes.length !== 'number'){
    return '';
  }
  let binary = '';
  const chunk = 0x8000;
  for(let offset = 0; offset < bytes.length; offset += chunk){
    const slice = bytes.subarray(offset, Math.min(offset + chunk, bytes.length));
    binary += String.fromCharCode.apply(null, slice);
  }
  return btoa(binary);
}

function base64ToUint8Array(base64){
  if(!base64 || typeof base64 !== 'string'){
    return new Uint8Array();
  }
  let binary;
  try {
    binary = atob(base64.replace(/\s+/g, ''));
  } catch (error) {
    console.error('Conversia base64 a e»ôuat.', error);
    return new Uint8Array();
  }
  const length = binary.length;
  const bytes = new Uint8Array(length);
  for(let index = 0; index < length; index += 1){
    bytes[index] = binary.charCodeAt(index);
  }
  return bytes;
}

async function renderHtmlPageToCanvas(html, orientation){
  if(typeof html !== 'string' || !window.html2canvas){
    throw new Error('Componenta de randare nu este disponibilƒÉ.');
  }
  const container = document.createElement('div');
  container.className = 'print-render-root';
  container.style.position = 'fixed';
  container.style.left = '-12000px';
  container.style.top = '0';
  container.style.width = '0';
  container.style.height = '0';
  container.style.overflow = 'hidden';
  container.innerHTML = `<style>${PRINT_STYLES}</style>${html}`;
  document.body.appendChild(container);
  try {
    const element = container.querySelector('.print-document');
    if(!element){
      throw new Error('Structura paginii nu a putut fi pregƒÉtitƒÉ.');
    }
    const effectiveOrientation = element.classList.contains('landscape') || orientation === 'landscape'
      ? 'landscape'
      : 'portrait';
    const pixelSize = PDF_PAGE_PIXEL_DIMENSIONS[effectiveOrientation] || PDF_PAGE_PIXEL_DIMENSIONS.portrait;
    element.style.width = `${pixelSize.width}px`;
    element.style.minHeight = `${pixelSize.height}px`;
    element.style.height = `${pixelSize.height}px`;
    if(document.fonts && typeof document.fonts.ready === 'object'){
      try {
        await document.fonts.ready;
      } catch (err) {
        console.warn('Fonturile nu au putut fi verificate √Ænainte de export.', err);
      }
    }
    await new Promise(resolve => requestAnimationFrame(resolve));
    const canvas = await window.html2canvas(element, {
      scale: 2,
      backgroundColor: '#ffffff',
      useCORS: true,
      logging: false,
      windowWidth: pixelSize.width,
      windowHeight: pixelSize.height,
    });
    return { canvas, orientation: effectiveOrientation };
  } finally {
    document.body.removeChild(container);
  }
}

async function appendCanvasToPdf(pdfDoc, canvas, orientation, insertIndex){
  if(!canvas){
    return 0;
  }
  const dims = PDF_PAGE_DIMENSIONS[orientation] || PDF_PAGE_DIMENSIONS.portrait;
  const dataUrl = canvas.toDataURL('image/png');
  const imageBytes = dataUrlToUint8Array(dataUrl);
  const embedded = await pdfDoc.embedPng(imageBytes);
  const insertPosition = typeof insertIndex === 'number' && insertIndex >= 0 && insertIndex <= pdfDoc.getPageCount()
    ? insertIndex
    : null;
  const page = insertPosition !== null
    ? pdfDoc.insertPage(insertPosition, [dims.width, dims.height])
    : pdfDoc.addPage([dims.width, dims.height]);
  const imageWidth = embedded.width;
  const imageHeight = embedded.height;
  const scale = Math.min(dims.width / imageWidth, dims.height / imageHeight);
  const drawWidth = imageWidth * scale;
  const drawHeight = imageHeight * scale;
  page.drawImage(embedded, {
    x: (dims.width - drawWidth) / 2,
    y: (dims.height - drawHeight) / 2,
    width: drawWidth,
    height: drawHeight,
  });
  return 1;
}

async function appendAttachmentSectionToPdf(pdfDoc, section){
  if(!section || !section.attachment){
    return 0;
  }
  const attachment = section.attachment;
  if(!attachment.data){
    return 0;
  }
  const mime = getAttachmentMimeType(attachment);
  try {
    if(mime === 'application/pdf'){
      const bytes = dataUrlToUint8Array(attachment.data);
      const externalDoc = await window.PDFLib.PDFDocument.load(bytes);
      const copiedPages = await pdfDoc.copyPages(externalDoc, externalDoc.getPageIndices());
      copiedPages.forEach(page => pdfDoc.addPage(page));
      return copiedPages.length;
    }
    if(mime && mime.startsWith('image/')){
      const bytes = dataUrlToUint8Array(attachment.data);
      const image = mime === 'image/png' || (attachment.data && attachment.data.startsWith('data:image/png'))
        ? await pdfDoc.embedPng(bytes)
        : await pdfDoc.embedJpg(bytes);
      const orientation = section.orientation === 'landscape' || image.width > image.height
        ? 'landscape'
        : 'portrait';
      const dims = PDF_PAGE_DIMENSIONS[orientation] || PDF_PAGE_DIMENSIONS.portrait;
      const page = pdfDoc.addPage([dims.width, dims.height]);
      const scale = Math.min(dims.width / image.width, dims.height / image.height);
      const drawWidth = image.width * scale;
      const drawHeight = image.height * scale;
      page.drawImage(image, {
        x: (dims.width - drawWidth) / 2,
        y: (dims.height - drawHeight) / 2,
        width: drawWidth,
        height: drawHeight,
      });
      return 1;
    }
  } catch (error) {
    console.error('Nu s-a putut integra automat un ata»ôament √Æn PDF.', error);
  }
  const fallbackHtml = renderPrintPage({
    company: getActiveCompany(),
    orientation: 'portrait',
    heading: escapeHtml(section.label || 'Document anexƒÉ'),
    content: `<p class="section-text">Formatul fi»ôierului ${escapeHtml(attachment.name || 'document')} (${escapeHtml(mime || 'necunoscut')}) nu a putut fi convertit automat. Documentul original rƒÉm√¢ne disponibil √Æn aplica»õie.</p>`,
  });
  const rendered = await renderHtmlPageToCanvas(fallbackHtml, 'portrait');
  await appendCanvasToPdf(pdfDoc, rendered.canvas, rendered.orientation);
  return 1;
}

function triggerPdfDownload(bytes, filename){
  const blob = new Blob([bytes], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  setTimeout(() => {
    try {
      URL.revokeObjectURL(url);
    } catch (err) {
      console.warn('Nu s-a putut elibera URL-ul temporar.', err);
    }
  }, 4000);
}

function openAuthorizationDossierPreviewWindow(){
  try {
    const previewWindow = window.open('', '_blank');
    if(previewWindow){
      previewWindow.document.title = 'Previzualizare dosar PDF';
      previewWindow.document.body.style.margin = '0';
      previewWindow.document.body.style.fontFamily = 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
      previewWindow.document.body.innerHTML = '<div style="padding:24px;font-size:14px;color:#2b3b63;">Se pregƒÉte»ôte previzualizarea dosarului‚Ä¶</div>';
    }
    return previewWindow;
  } catch (error) {
    console.warn('Nu s-a putut deschide fereastra de previzualizare.', error);
    return null;
  }
}

function renderAuthorizationDossierPreview(previewWindow, bytes, filename){
  if(!previewWindow){
    return false;
  }
  try {
    if(previewWindow.closed){
      return false;
    }
    const blob = new Blob([bytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const doc = previewWindow.document;
    doc.title = filename;
    doc.body.style.margin = '0';
    doc.body.innerHTML = `<embed src="${url}#toolbar=1&navpanes=1&scrollbar=1&view=Fit" type="application/pdf" style="width:100%;height:100vh;" />`;
    try {
      previewWindow.addEventListener('beforeunload', () => {
        try {
          URL.revokeObjectURL(url);
        } catch (cleanupError) {
          console.warn('Nu s-a putut elibera URL-ul previzualizƒÉrii.', cleanupError);
        }
      }, { once: true });
    } catch (listenerError) {
      console.warn('Nu s-a putut ata»ôa handlerul de curƒÉ»õare pentru previzualizare.', listenerError);
      setTimeout(() => {
        try {
          URL.revokeObjectURL(url);
        } catch (cleanupError) {
          console.warn('Nu s-a putut elibera URL-ul previzualizƒÉrii.', cleanupError);
        }
      }, 60000);
    }
    return true;
  } catch (error) {
    console.error('Previzualizarea PDF nu a putut fi afi»ôatƒÉ.', error);
    try {
      previewWindow.document.body.innerHTML = '<div style="padding:24px;font-size:14px;color:#c53030;">Previzualizarea PDF nu a putut fi √ÆncƒÉrcatƒÉ.</div>';
    } catch (updateError) {
      console.warn('Nu s-a putut actualiza fereastra de previzualizare.', updateError);
    }
    return false;
  }
}

async function applyPdfPageNumbers(pdfDoc){
  if(!pdfDoc || typeof pdfDoc.getPageCount !== 'function'){
    return;
  }
  const totalPages = pdfDoc.getPageCount();
  if(!totalPages || totalPages <= 0){
    return;
  }
  let font;
  try {
    font = await pdfDoc.embedFont(window.PDFLib.StandardFonts.Helvetica);
  } catch (error) {
    console.warn('Nu s-au putut insera numerele de paginƒÉ.', error);
    return;
  }
  for(let index = 0; index < totalPages; index += 1){
    const page = pdfDoc.getPage(index);
    if(!page){
      continue;
    }
    const size = page.getSize();
    const label = `Pagina ${index + 1}`;
    const fontSize = 10;
    const textWidth = font.widthOfTextAtSize(label, fontSize);
    const marginX = 28;
    const marginY = 24;
    const x = Math.max(marginX, size.width - marginX - textWidth);
    const y = marginY;
    page.drawText(label, {
      x,
      y,
      size: fontSize,
      font,
      color: window.PDFLib.rgb(0.2, 0.2, 0.2),
    });
  }
}

async function composeAuthorizationDossierPdf(dossier, company){
  if(!dossier){
    throw new Error('Dosarul de autorizare nu este disponibil.');
  }
  if(!window.PDFLib || !window.PDFLib.PDFDocument){
    throw new Error('Motorul de generare PDF nu este disponibil.');
  }
  if(!window.html2canvas){
    throw new Error('Componenta de export vizual nu este disponibilƒÉ.');
  }
  ensureDossierMaterialDocuments(dossier);
  ensureDossierCustomSteps(dossier);
  const settings = ensureAuthorizationDossierSettings(company);
  const plan = await buildAuthorizationDossierPagePlan(dossier, company);
  const pdfDoc = await window.PDFLib.PDFDocument.create();
  let currentPage = 2;
  for(const detail of plan.details){
    const section = detail.section;
    let pagesAdded = 0;
    if(section){
      if(section.attachment){
        pagesAdded = await appendAttachmentSectionToPdf(pdfDoc, section);
      } else if(Array.isArray(section.attachments) && section.attachments.length > 0){
        for(const attachment of section.attachments){
          if(!attachment || !attachment.data){
            continue;
          }
          const derivedSection = { ...section, attachment };
          delete derivedSection.attachments;
          const appended = await appendAttachmentSectionToPdf(pdfDoc, derivedSection);
          pagesAdded += appended;
        }
      } else {
        const content = typeof section.getContent === 'function' ? section.getContent() : (section.content || '');
        const heading = section.fullBleed ? '' : escapeHtml(section.heading || section.label || '');
        const subheading = section.fullBleed ? '' : (section.subheading ? escapeHtml(section.subheading) : '');
        const pageHtml = renderPrintPage({
          company,
          orientation: section.orientation || 'portrait',
          heading,
          subheading,
          content,
          fullBleed: Boolean(section.fullBleed),
          showBranding: section.showBranding !== undefined ? Boolean(section.showBranding) : true,
        });
        const rendered = await renderHtmlPageToCanvas(pageHtml, section.orientation || 'portrait');
        pagesAdded = await appendCanvasToPdf(pdfDoc, rendered.canvas, rendered.orientation);
      }
    }
    const effectivePages = pagesAdded && pagesAdded > 0 ? pagesAdded : Math.max(1, detail.pageCount || 1);
    detail.startPage = currentPage;
    detail.endPage = currentPage + effectivePages - 1;
    detail.pageCount = effectivePages;
    currentPage = detail.endPage + 1;
  }
  const subtitle = plan.subtitle || computeDossierSubtitle(dossier);
  const opisItems = plan.details.map(detail => {
    const pageLabel = detail.pageCount > 1
      ? `Pagina ${detail.startPage}-${detail.endPage}`
      : `Pagina ${detail.startPage}`;
    return `<li><span>${pageLabel}</span><div>${escapeHtml(detail.label)}</div></li>`;
  }).join('');
  const opisHtml = renderPrintPage({
    company,
    orientation: 'portrait',
    heading: 'OPIS',
    subheading: escapeHtml(subtitle),
    content: `<ol class="opis-list">${opisItems}</ol>`,
    showBranding: true,
  });
  const opisRendered = await renderHtmlPageToCanvas(opisHtml, 'portrait');
  await appendCanvasToPdf(pdfDoc, opisRendered.canvas, opisRendered.orientation, 0);
  if(!settings || settings.pageNumbering !== false){
    await applyPdfPageNumbers(pdfDoc);
  }
  const bytes = await pdfDoc.save();
  plan.totalPages = pdfDoc.getPageCount ? pdfDoc.getPageCount() : currentPage - 1;
  const filename = `${slugifyForFilename(computeDossierTitle(dossier) || 'dosar-autorizare', 'dosar-autorizare')}.pdf`;
  return { bytes, filename, plan };
}

async function runAuthorizationDossierPdfAction(action){
  const company = getActiveCompany();
  const dossier = getActiveAuthorizationDossier(company);
  if(!dossier){
    alert('Nu existƒÉ un dosar de autorizare activ.');
    return;
  }
  const buttonIds = {
    preview: 'btn_preview_auth_dossier_pdf',
    download: 'btn_generate_auth_dossier_pdf',
    save: 'btn_save_auth_dossier_pdf',
  };
  const triggerId = buttonIds[action];
  const trigger = triggerId ? document.getElementById(triggerId) : null;
  if(trigger){
    trigger.disabled = true;
    trigger.dataset.loading = 'true';
  }
  let previewWindow = null;
  try {
    if(action === 'preview'){
      previewWindow = openAuthorizationDossierPreviewWindow();
    }
    const { bytes, filename, plan } = await composeAuthorizationDossierPdf(dossier, company);
    if(action === 'preview'){
      const rendered = renderAuthorizationDossierPreview(previewWindow, bytes, filename);
      if(previewWindow && !rendered){
        try { previewWindow.close(); } catch (closeError) { console.warn('Previzualizarea nu a putut fi √ÆnchisƒÉ.', closeError); }
      }
      return;
    }
    if(action === 'download'){
      triggerPdfDownload(bytes, filename);
      return;
    }
    if(action === 'save'){
      saveAuthorizationDossierArchiveEntry(dossier, plan, bytes, filename);
      const dossiers = ensureAuthorizationDossiers(company);
      const index = dossiers.findIndex(entry => entry && entry.id === dossier.id);
      if(index !== -1){
        dossiers.splice(index, 1);
      }
      if(dossiers.length === 0){
        activeAuthorizationDossierId = null;
      } else if(!dossiers.some(entry => entry && entry.id === activeAuthorizationDossierId)){
        activeAuthorizationDossierId = dossiers[0].id;
      }
      clearAuthorizationDossierForm();
      persistState();
      renderAuthorizationDossierControls();
      alert('Dosarul a fost salvat √Æn arhivƒÉ.');
      return;
    }
  } catch (error) {
    console.error('Generarea dosarului PDF a e»ôuat.', error);
    alert('Nu s-a putut genera dosarul PDF. VerificƒÉ ata»ôamentele »ôi √ÆncearcƒÉ din nou.');
    if(previewWindow){
      try {
        previewWindow.document.body.innerHTML = '<div style="padding:24px;font-size:14px;color:#c53030;">Generarea dosarului a e»ôuat.</div>';
      } catch (updateError) {
        console.warn('Nu s-a putut actualiza fereastra de previzualizare dupƒÉ eroare.', updateError);
      }
    }
  } finally {
    if(trigger){
      trigger.disabled = false;
      delete trigger.dataset.loading;
    }
  }
}

async function previewAuthorizationDossierPdf(){
  await runAuthorizationDossierPdfAction('preview');
}

async function generateAuthorizationDossierPdf(){
  await runAuthorizationDossierPdfAction('download');
}

async function saveAuthorizationDossierPdf(){
  await runAuthorizationDossierPdfAction('save');
}

function loadAuthorizationDossier(){
  renderAuthorizationDossierControls();
}

function renderAuthorizationDossierTable(dossier, company){
  const tbody = document.getElementById('auth_dossier_table_body');
  const empty = document.getElementById('auth_dossier_table_empty');
  if(!tbody){
    return;
  }
  tbody.innerHTML = '';
  const entries = Array.isArray(dossier && dossier.entries) ? dossier.entries : [];
  if(entries.length === 0){
    if(empty){
      empty.classList.remove('hidden');
    }
    return;
  }
  if(empty){
    empty.classList.add('hidden');
  }
  entries.forEach((entry, index) => {
    const tr = document.createElement('tr');
    const nameHtml = entry && entry.welder_name ? escapeHtml(entry.welder_name) : '<span class="muted">(general)</span>';
    const pansonHtml = entry && entry.panson_code ? `<div class="muted">${escapeHtml(entry.panson_code)}</div>` : '';
    const procedureLabel = resolveProcedureLabel(company, entry && entry.procedure_id);
    const processParts = [];
    if(entry && entry.process){
      processParts.push(`<div>${escapeHtml(entry.process)}</div>`);
    }
    if(procedureLabel){
      processParts.push(`<div class="muted">Procedeu: ${escapeHtml(procedureLabel)}</div>`);
    }
    const processHtml = processParts.length ? processParts.join('') : '<span class="muted">‚Äî</span>';
    const baseParts = [];
    if(entry && entry.base_quality){
      baseParts.push(`<div>${escapeHtml(entry.base_quality)}</div>`);
    }
    if(entry && entry.base_material){
      baseParts.push(`<div class="muted">Material: ${escapeHtml(entry.base_material)}</div>`);
    }
    const baseHtml = baseParts.length ? baseParts.join('') : '<span class="muted">‚Äî</span>';
    const fillerHtml = entry && entry.filler_material ? escapeHtml(entry.filler_material) : '<span class="muted">‚Äî</span>';
    const positionHtml = entry && entry.position ? escapeHtml(entry.position) : '<span class="muted">‚Äî</span>';
    const baseDimHtml = entry && entry.base_dimension ? escapeHtml(entry.base_dimension) : '<span class="muted">‚Äî</span>';
    const diameterHtml = entry && entry.diameter ? escapeHtml(entry.diameter) : '<span class="muted">‚Äî</span>';
    const domainParts = [];
    if(entry && entry.thickness_domain){
      domainParts.push(`<div>Domeniu: ${escapeHtml(entry.thickness_domain)}</div>`);
    }
    if(entry && entry.observation){
      domainParts.push(`<div class="muted">Obs: ${escapeHtml(entry.observation)}</div>`);
    }
    const domainHtml = domainParts.length ? domainParts.join('') : '<span class="muted">‚Äî</span>';
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${nameHtml}${pansonHtml}</td>
      <td>${processHtml}</td>
      <td>${baseHtml}</td>
      <td>${fillerHtml}</td>
      <td>${positionHtml}</td>
      <td>${baseDimHtml}</td>
      <td>${diameterHtml}</td>
      <td>${domainHtml}</td>
      <td><button type="button" class="btn ghost small" data-action="remove" data-id="${entry && entry.id ? entry.id : ''}">»òterge</button></td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-action="remove"]').forEach(button => {
    button.addEventListener('click', () => {
      const id = button.getAttribute('data-id');
      if(id){
        removeAuthorizationDossierRow(id);
      }
    });
  });
}

function removeAuthorizationDossierRow(entryId){
  if(!entryId){
    return;
  }
  const company = getActiveCompany();
  const dossier = getActiveAuthorizationDossier(company);
  if(!dossier){
    return;
  }
  dossier.entries = (Array.isArray(dossier.entries) ? dossier.entries : []).filter(entry => entry && entry.id !== entryId);
  persistState();
  renderAuthorizationDossierDetail(dossier);
}

function renderAuthorizationDossierProcedureDocs(dossier, company){
  const container = document.getElementById('auth_dossier_procedure_docs');
  if(!container){
    return;
  }
  container.innerHTML = '';
  const usedProcedures = new Map();
  (Array.isArray(dossier && dossier.entries) ? dossier.entries : []).forEach(entry => {
    if(entry && entry.procedure_id){
      const procedure = company.qualifications.find(q => q && q.id === entry.procedure_id);
      if(procedure){
        usedProcedures.set(entry.procedure_id, procedure);
      }
    }
  });
  if(usedProcedures.size === 0){
    container.innerHTML = '<p class="muted">Nu existƒÉ procedee asociate r√¢ndurilor din tabel.</p>';
    return;
  }
  usedProcedures.forEach(proc => {
    const item = document.createElement('div');
    item.className = 'doc-item';
    const meta = document.createElement('div');
    meta.className = 'meta';
    const label = resolveProcedureLabel(company, proc.id) || getStandardLabel(proc.standard);
    const notes = [];
    if(proc.certificate_no){
      notes.push(`Certificat: ${escapeHtml(proc.certificate_no)}`);
    }
    meta.innerHTML = `<strong>${escapeHtml(label)}</strong>${notes.length ? `<span>${notes.join(' ‚Ä¢ ')}</span>` : ''}`;
    const actions = document.createElement('div');
    actions.className = 'actions';
    const actionsNode = createAttachmentActionsNode(proc.attachment, { fallbackName: 'procedeu.pdf' });
    if(actionsNode){
      actions.appendChild(actionsNode);
    } else {
      const span = document.createElement('span');
      span.className = 'muted';
      span.textContent = 'FƒÉrƒÉ document ata»ôat';
      actions.appendChild(span);
    }
    item.appendChild(meta);
    item.appendChild(actions);
    container.appendChild(item);
  });
}

function renderAuthorizationDossierWelderDocs(dossier, company){
  const container = document.getElementById('auth_dossier_welder_docs');
  if(!container){
    return;
  }
  container.innerHTML = '';
  const seen = new Set();
  (Array.isArray(dossier && dossier.entries) ? dossier.entries : []).forEach(entry => {
    if(entry && entry.welder_id){
      seen.add(entry.welder_id);
    }
  });
  if(seen.size === 0){
    container.innerHTML = '<p class="muted">Nu sunt selecta»õi sudori √Æn tabel.</p>';
    return;
  }
  seen.forEach(id => {
    const welder = company.welders.find(w => w.id === id)
      || (company.archivedWelders.find(record => record && record.welder && record.welder.id === id)?.welder);
    if(!welder){
      return;
    }
    const item = document.createElement('div');
    item.className = 'doc-item';
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `<strong>${escapeHtml(welder.name || 'Sudor')}</strong>`;
    const actions = document.createElement('div');
    actions.className = 'actions';
    const attachments = welder.bundle && welder.bundle.data
      ? [{ label: 'Documente personale', attachment: welder.bundle }]
      : [
        { label: 'Carte identitate', attachment: welder.id_card },
        { label: 'DiplomƒÉ', attachment: welder.diploma },
        { label: 'Contract', attachment: welder.contract },
        { label: 'Fi»ôƒÉ aptitudini', attachment: welder.aptitude },
      ];
    let hasDocs = false;
    attachments.forEach(record => {
      if(record.attachment && record.attachment.data){
        hasDocs = true;
        const wrapper = document.createElement('div');
        wrapper.className = 'attachment-actions';
        const labelSpan = document.createElement('span');
        labelSpan.className = 'tag-secondary';
        labelSpan.textContent = record.label;
        wrapper.appendChild(labelSpan);
        const node = createAttachmentActionsNode(record.attachment, { fallbackName: `${record.label.toLowerCase().replace(/\s+/g, '_')}.pdf` });
        if(node){
          while(node.firstChild){
            wrapper.appendChild(node.firstChild);
          }
        }
        actions.appendChild(wrapper);
      }
    });
    if(!hasDocs){
      const span = document.createElement('span');
      span.className = 'muted';
      span.textContent = 'Nu existƒÉ documente ata»ôate';
      actions.appendChild(span);
    }
    item.appendChild(meta);
    item.appendChild(actions);
    container.appendChild(item);
  });
}

function getUniqueMaterials(entries, key){
  const set = new Set();
  (Array.isArray(entries) ? entries : []).forEach(entry => {
    const value = entry && entry[key] ? String(entry[key]).trim() : '';
    if(value){
      set.add(value);
    }
  });
  return Array.from(set);
}

function renderAuthorizationDossierMaterialSections(dossier){
  ensureDossierMaterialDocuments(dossier);
  const baseMaterials = getUniqueMaterials(dossier.entries, 'base_quality');
  const fillerMaterials = getUniqueMaterials(dossier.entries, 'filler_material');
  const baseSelect = document.getElementById('auth_dossier_base_material_select');
  if(baseSelect){
    const previous = baseSelect.value;
    baseSelect.innerHTML = '<option value="">Alege material de bazƒÉ</option>';
    baseMaterials.forEach(material => {
      const option = document.createElement('option');
      option.value = material;
      option.textContent = material;
      baseSelect.appendChild(option);
    });
    if(previous && baseMaterials.includes(previous)){
      baseSelect.value = previous;
    } else {
      baseSelect.value = '';
    }
    baseSelect.disabled = baseMaterials.length === 0;
  }
  const fillerSelect = document.getElementById('auth_dossier_filler_material_select');
  if(fillerSelect){
    const previous = fillerSelect.value;
    fillerSelect.innerHTML = '<option value="">Alege material de adaos</option>';
    fillerMaterials.forEach(material => {
      const option = document.createElement('option');
      option.value = material;
      option.textContent = material;
      fillerSelect.appendChild(option);
    });
    if(previous && fillerMaterials.includes(previous)){
      fillerSelect.value = previous;
    } else {
      fillerSelect.value = '';
    }
    fillerSelect.disabled = fillerMaterials.length === 0;
  }
  const baseDocsContainer = document.getElementById('auth_dossier_base_material_docs');
  renderAuthorizationDossierMaterialList('base', dossier.materialDocuments.base, baseDocsContainer);
  const fillerDocsContainer = document.getElementById('auth_dossier_filler_material_docs');
  renderAuthorizationDossierMaterialList('filler', dossier.materialDocuments.filler, fillerDocsContainer);
  const baseFileInput = document.getElementById('auth_dossier_base_material_file');
  if(baseFileInput){
    baseFileInput.value = '';
  }
  const fillerFileInput = document.getElementById('auth_dossier_filler_material_file');
  if(fillerFileInput){
    fillerFileInput.value = '';
  }
}

function renderAuthorizationDossierCustomSteps(dossier){
  const list = document.getElementById('auth_custom_steps_list');
  const empty = document.getElementById('auth_custom_steps_empty');
  if(!list || !empty){
    return;
  }
  list.innerHTML = '';
  const steps = ensureDossierCustomSteps(dossier);
  if(!steps || steps.length === 0){
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');
  steps.forEach(step => {
    const wrapper = document.createElement('div');
    wrapper.className = 'custom-step';
    wrapper.setAttribute('data-step-id', step.id);

    const header = document.createElement('div');
    header.className = 'custom-step-header';

    const title = document.createElement('h5');
    title.textContent = step && step.name ? step.name : 'Pas suplimentar';
    header.appendChild(title);

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = step && step.opis ? `OPIS: ${step.opis}` : 'FƒÉrƒÉ text pentru OPIS';
    header.appendChild(meta);

    const actions = document.createElement('div');
    actions.className = 'custom-step-actions';

    const uploadTrigger = document.createElement('button');
    uploadTrigger.type = 'button';
    uploadTrigger.className = 'btn ghost small';
    uploadTrigger.textContent = 'Ata»ôeazƒÉ document';
    uploadTrigger.setAttribute('data-step-upload-trigger', step.id);
    actions.appendChild(uploadTrigger);

    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'btn ghost small';
    deleteBtn.textContent = '»òterge pasul';
    deleteBtn.setAttribute('data-step-delete', step.id);
    actions.appendChild(deleteBtn);

    header.appendChild(actions);

    const uploadInput = document.createElement('input');
    uploadInput.type = 'file';
    uploadInput.accept = 'application/pdf,image/*';
    uploadInput.setAttribute('data-step-upload-input', step.id);
    uploadInput.style.display = 'none';

    const docsContainer = document.createElement('div');
    docsContainer.className = 'dossier-doc-list';
    const attachments = Array.isArray(step.attachments) ? step.attachments : [];
    if(attachments.length === 0){
      const emptyDoc = document.createElement('p');
      emptyDoc.className = 'muted';
      emptyDoc.textContent = 'Nu existƒÉ documente ata»ôate pentru acest pas.';
      docsContainer.appendChild(emptyDoc);
    } else {
      attachments.forEach(attachment => {
        if(!attachment || !attachment.data){
          return;
        }
        const item = document.createElement('div');
        item.className = 'doc-item';
        item.setAttribute('data-attachment-id', attachment.id || '');

        const metaBlock = document.createElement('div');
        metaBlock.className = 'meta';
        metaBlock.innerHTML = `<strong>${escapeHtml(attachment.name || 'Document')}</strong>`;
        item.appendChild(metaBlock);

        const actionsBlock = document.createElement('div');
        actionsBlock.className = 'actions';
        const viewNode = createAttachmentActionsNode(attachment, { fallbackName: attachment.name || 'document.pdf' });
        if(viewNode){
          actionsBlock.appendChild(viewNode);
        }
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn ghost small';
        removeBtn.textContent = 'EliminƒÉ';
        removeBtn.setAttribute('data-step-remove-attachment', attachment.id || '');
        removeBtn.setAttribute('data-step-id', step.id);
        actionsBlock.appendChild(removeBtn);
        item.appendChild(actionsBlock);
        docsContainer.appendChild(item);
      });
    }

    wrapper.appendChild(header);
    wrapper.appendChild(uploadInput);
    wrapper.appendChild(docsContainer);
    list.appendChild(wrapper);
  });
}

function handleAddCustomStep(){
  const nameInput = document.getElementById('auth_custom_step_name');
  const opisInput = document.getElementById('auth_custom_step_opis');
  const name = nameInput && typeof nameInput.value === 'string' ? nameInput.value.trim() : '';
  const opis = opisInput && typeof opisInput.value === 'string' ? opisInput.value.trim() : '';
  if(!name){
    alert('Introdu denumirea pasului personalizat.');
    return;
  }
  const company = getActiveCompany();
  const dossier = getActiveAuthorizationDossier(company);
  if(!dossier){
    alert('Nu existƒÉ un dosar activ pentru a adƒÉuga pasul.');
    return;
  }
  const steps = ensureDossierCustomSteps(dossier);
  steps.push({
    id: generateDocumentId('custep'),
    name,
    opis,
    attachments: [],
  });
  if(nameInput){
    nameInput.value = '';
  }
  if(opisInput){
    opisInput.value = '';
  }
  persistState();
  renderAuthorizationDossierDetail(dossier);
}

async function handleCustomStepFileChange(event){
  const input = event.target;
  if(!input || input.type !== 'file'){
    return;
  }
  const stepId = input.getAttribute('data-step-upload-input');
  if(!stepId || !input.files || !input.files[0]){
    return;
  }
  const file = input.files[0];
  const company = getActiveCompany();
  const dossier = getActiveAuthorizationDossier(company);
  if(!dossier){
    input.value = '';
    return;
  }
  const steps = ensureDossierCustomSteps(dossier);
  const step = steps.find(entry => entry && entry.id === stepId);
  if(!step){
    input.value = '';
    return;
  }
  try {
    const data = await readFileAsDataURL(file);
    const attachment = normalizeDossierItem({ name: file.name, data, type: file.type }, file.name || 'document_personalizat');
    step.attachments = Array.isArray(step.attachments) ? step.attachments : [];
    step.attachments.push(attachment);
    persistState();
    renderAuthorizationDossierDetail(dossier);
  } catch (error) {
    console.error('Documentul nu a putut fi ata»ôat la pasul personalizat.', error);
    alert('Documentul nu a putut fi ata»ôat. √éncearcƒÉ din nou.');
  } finally {
    input.value = '';
  }
}

function handleCustomStepClick(event){
  const uploadTrigger = event.target.closest('[data-step-upload-trigger]');
  if(uploadTrigger){
    const stepId = uploadTrigger.getAttribute('data-step-upload-trigger');
    const input = document.querySelector(`input[data-step-upload-input="${stepId}"]`);
    if(input){
      input.click();
    }
    return;
  }
  const removeAttachment = event.target.closest('[data-step-remove-attachment]');
  if(removeAttachment){
    const stepId = removeAttachment.getAttribute('data-step-id');
    const attachmentId = removeAttachment.getAttribute('data-step-remove-attachment');
    removeCustomStepAttachment(stepId, attachmentId);
    return;
  }
  const deleteStep = event.target.closest('[data-step-delete]');
  if(deleteStep){
    const stepId = deleteStep.getAttribute('data-step-delete');
    if(stepId && confirm('»òtergi acest pas personalizat?')){
      removeCustomStep(stepId);
    }
  }
}

function removeCustomStep(stepId){
  if(!stepId){
    return;
  }
  const company = getActiveCompany();
  const dossier = getActiveAuthorizationDossier(company);
  if(!dossier){
    return;
  }
  const steps = ensureDossierCustomSteps(dossier);
  const index = steps.findIndex(step => step && step.id === stepId);
  if(index === -1){
    return;
  }
  steps.splice(index, 1);
  persistState();
  renderAuthorizationDossierDetail(dossier);
}

function removeCustomStepAttachment(stepId, attachmentId){
  if(!stepId || !attachmentId){
    return;
  }
  const company = getActiveCompany();
  const dossier = getActiveAuthorizationDossier(company);
  if(!dossier){
    return;
  }
  const steps = ensureDossierCustomSteps(dossier);
  const step = steps.find(entry => entry && entry.id === stepId);
  if(!step || !Array.isArray(step.attachments)){
    return;
  }
  step.attachments = step.attachments.filter(attachment => attachment && attachment.id !== attachmentId);
  persistState();
  renderAuthorizationDossierDetail(dossier);
}

function renderAuthorizationDossierMaterialList(type, documentsMap, container){
  if(!container){
    return;
  }
  container.innerHTML = '';
  const keys = Object.keys(documentsMap || {});
  if(keys.length === 0){
    container.innerHTML = '<p class="muted">Nu existƒÉ documente ata»ôate.</p>';
    return;
  }
  keys.forEach(material => {
    const docs = documentsMap[material] || [];
    if(docs.length === 0){
      return;
    }
    const item = document.createElement('div');
    item.className = 'doc-item';
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `<strong>${escapeHtml(material)}</strong><span>${type === 'base' ? 'Material de bazƒÉ' : 'Material de adaos'}</span>`;
    const actions = document.createElement('div');
    actions.className = 'actions';
    docs.forEach(doc => {
      const row = document.createElement('div');
      row.className = 'attachment-actions';
      const labelSpan = document.createElement('span');
      labelSpan.className = 'tag-secondary';
      labelSpan.textContent = doc.name || 'document';
      row.appendChild(labelSpan);
      const node = createAttachmentActionsNode(doc, { fallbackName: doc.name || 'document.pdf' });
      if(node){
        while(node.firstChild){
          row.appendChild(node.firstChild);
        }
      } else {
        const span = document.createElement('span');
        span.className = 'muted';
        span.textContent = 'Document indisponibil';
        row.appendChild(span);
      }
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn ghost small';
      removeBtn.textContent = '»òterge';
      removeBtn.addEventListener('click', () => removeAuthorizationDossierMaterialDoc(type, material, doc.id));
      row.appendChild(removeBtn);
      actions.appendChild(row);
    });
    item.appendChild(meta);
    item.appendChild(actions);
    container.appendChild(item);
  });
}

function ensureDossierMaterialDocuments(dossier){
  if(!dossier.materialDocuments || typeof dossier.materialDocuments !== 'object'){
    dossier.materialDocuments = { base: {}, filler: {} };
  }
  if(!dossier.materialDocuments.base || typeof dossier.materialDocuments.base !== 'object'){
    dossier.materialDocuments.base = {};
  }
  if(!dossier.materialDocuments.filler || typeof dossier.materialDocuments.filler !== 'object'){
    dossier.materialDocuments.filler = {};
  }
  return dossier.materialDocuments;
}

function ensureDossierLetterStyle(dossier){
  if(!dossier.letterStyle || typeof dossier.letterStyle !== 'object'){
    dossier.letterStyle = { ...DEFAULT_LETTER_STYLE };
  } else {
    dossier.letterStyle.align = dossier.letterStyle.align === 'center' ? 'center' : 'left';
    dossier.letterStyle.bold = Boolean(dossier.letterStyle.bold);
    const sizeValue = Number(dossier.letterStyle.size);
    dossier.letterStyle.size = Number.isFinite(sizeValue)
      ? Math.min(24, Math.max(10, sizeValue))
      : DEFAULT_LETTER_STYLE.size;
  }
  return dossier.letterStyle;
}

function ensureDossierCustomSteps(dossier){
  if(!Array.isArray(dossier.customSteps)){
    dossier.customSteps = [];
  }
  return dossier.customSteps;
}

async function handleAddMaterialDoc(type){
  const validTypes = ['base', 'filler'];
  if(!validTypes.includes(type)){
    return;
  }
  const selectId = type === 'base' ? 'auth_dossier_base_material_select' : 'auth_dossier_filler_material_select';
  const fileId = type === 'base' ? 'auth_dossier_base_material_file' : 'auth_dossier_filler_material_file';
  const select = document.getElementById(selectId);
  const fileInput = document.getElementById(fileId);
  if(!select || !fileInput){
    return;
  }
  const material = select.value ? String(select.value).trim() : '';
  if(!material){
    alert('SelecteazƒÉ materialul pentru care √Æncarci documentul.');
    return;
  }
  if(!fileInput.files || !fileInput.files[0]){
    alert('SelecteazƒÉ un fi»ôier de √ÆncƒÉrcat.');
    return;
  }
  const file = fileInput.files[0];
  const isValid = !file.type || file.type === 'application/pdf' || file.type.startsWith('image/');
  if(!isValid){
    alert('Sunt acceptate doar fi»ôiere PDF sau imagini.');
    return;
  }
  try {
    const dataUrl = await readFileAsDataURL(file);
    const company = getActiveCompany();
    const dossier = getActiveAuthorizationDossier(company);
    if(!dossier){
      alert('CreeazƒÉ mai √Ænt√¢i un dosar de autorizare.');
      return;
    }
    const materials = ensureDossierMaterialDocuments(dossier);
    if(!Array.isArray(materials[type][material])){
      materials[type][material] = [];
    }
    materials[type][material].push({
      id: generateDocumentId('matdoc'),
      name: file.name || 'document.pdf',
      data: dataUrl,
      type: file.type || 'application/pdf',
      added_at: new Date().toISOString(),
    });
    persistState();
    renderAuthorizationDossierDetail(dossier);
    fileInput.value = '';
  } catch (err) {
    console.error('Nu s-a putut √ÆncƒÉrca documentul materialului.', err);
    alert('√éncƒÉrcarea documentului a e»ôuat. √éncearcƒÉ din nou.');
  }
}

function removeAuthorizationDossierMaterialDoc(type, material, docId){
  const company = getActiveCompany();
  const dossier = getActiveAuthorizationDossier(company);
  if(!dossier){
    return;
  }
  const materials = ensureDossierMaterialDocuments(dossier);
  const bucket = materials[type] && materials[type][material];
  if(!Array.isArray(bucket)){
    return;
  }
  materials[type][material] = bucket.filter(doc => doc && doc.id !== docId);
  if(materials[type][material].length === 0){
    delete materials[type][material];
  }
  persistState();
  renderAuthorizationDossierDetail(dossier);
}

function getAuthorizationArchiveEntryById(id){
  const company = getActiveCompany();
  const archive = ensureAuthorizationDossierArchive(company);
  return archive.find(entry => entry && entry.id === id) || null;
}

function saveAuthorizationDossierArchiveEntry(dossier, plan, bytes, filename){
  const company = getActiveCompany();
  const archive = ensureAuthorizationDossierArchive(company);
  const buffer = bytes instanceof Uint8Array ? bytes : (bytes && typeof bytes.length === 'number' ? new Uint8Array(bytes) : new Uint8Array());
  const base64 = uint8ArrayToBase64(buffer);
  let snapshot = null;
  try {
    snapshot = JSON.parse(JSON.stringify(dossier));
  } catch (error) {
    console.warn('Nu s-a putut salva structura dosarului pentru arhivƒÉ.', error);
  }
  const entry = {
    id: company.nextAuthorizationDossierArchiveId++,
    dossier_id: dossier && dossier.id !== undefined ? dossier.id : null,
    name: computeDossierTitle(dossier),
    standard: dossier && dossier.standard ? dossier.standard : null,
    saved_at: new Date().toISOString(),
    filename: filename || `${slugifyForFilename(computeDossierTitle(dossier) || 'dosar-autorizare', 'dosar-autorizare')}.pdf`,
    data: base64,
    page_count: plan && plan.totalPages ? plan.totalPages : null,
    details: Array.isArray(plan && plan.details)
      ? plan.details.map(detail => ({
        label: detail && detail.label ? detail.label : 'Sec»õiune',
        startPage: detail && detail.startPage !== undefined ? detail.startPage : null,
        endPage: detail && detail.endPage !== undefined ? detail.endPage : null,
        pageCount: detail && detail.pageCount !== undefined ? detail.pageCount : null,
      }))
      : [],
    snapshot,
  };
  archive.push(entry);
  persistState();
  renderAuthorizationDossierArchive();
}

function toggleAuthorizationDossierSettingsPanel(){
  const panel = document.getElementById('auth_dossier_settings_panel');
  const trigger = document.getElementById('btn_auth_dossier_settings');
  if(!panel || !trigger){
    return;
  }
  const isOpen = panel.classList.toggle('open');
  panel.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
  trigger.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
}

function handleAuthorizationDossierPageNumberToggle(event){
  const company = getActiveCompany();
  const settings = ensureAuthorizationDossierSettings(company);
  settings.pageNumbering = Boolean(event && event.target && event.target.checked);
  persistState();
}

function renderAuthorizationDossierArchive(){
  const tbody = document.getElementById('auth_dossier_archive_tbody');
  const wrap = document.getElementById('auth_dossier_archive_table_wrap');
  const empty = document.getElementById('auth_dossier_archive_empty');
  if(!tbody || !wrap || !empty){
    return;
  }
  tbody.innerHTML = '';
  const company = getActiveCompany();
  const archive = ensureAuthorizationDossierArchive(company);
  if(!archive || archive.length === 0){
    wrap.classList.add('hidden');
    empty.classList.remove('hidden');
    return;
  }
  wrap.classList.remove('hidden');
  empty.classList.add('hidden');
  const sorted = archive.slice().sort((a, b) => {
    const aTime = a && a.saved_at ? new Date(a.saved_at).getTime() : 0;
    const bTime = b && b.saved_at ? new Date(b.saved_at).getTime() : 0;
    return bTime - aTime;
  });
  sorted.forEach(entry => {
    const tr = document.createElement('tr');
    const standardLabel = entry && entry.standard ? getStandardLabel(entry.standard) : '‚Äî';
    const savedDate = entry && entry.saved_at ? new Date(entry.saved_at).toLocaleString('ro-RO') : '‚Äî';
    const pages = entry && entry.page_count ? String(entry.page_count) : '‚Äî';
    tr.innerHTML = `
      <td>${escapeHtml(entry && entry.name ? entry.name : 'Dosar PDF')}</td>
      <td>${escapeHtml(standardLabel)}</td>
      <td>${escapeHtml(savedDate)}</td>
      <td>${escapeHtml(pages)}</td>
      <td>
        <div class="dossier-actions">
          <button type="button" class="btn ghost small" data-archive-action="preview" data-archive-id="${entry.id}">PrevizualizeazƒÉ</button>
          <button type="button" class="btn secondary small" data-archive-action="download" data-archive-id="${entry.id}">DescarcƒÉ</button>
          <button type="button" class="btn small" data-archive-action="restore" data-archive-id="${entry.id}">RestaureazƒÉ</button>
          <button type="button" class="btn danger small" data-archive-action="delete" data-archive-id="${entry.id}">»òterge</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-archive-action]').forEach(button => {
    button.addEventListener('click', () => {
      const rawId = button.getAttribute('data-archive-id');
      const action = button.getAttribute('data-archive-action');
      const id = Number(rawId);
      if(Number.isNaN(id)){
        return;
      }
      const entry = getAuthorizationArchiveEntryById(id);
      if(!entry){
        alert('Documentul arhivat nu este disponibil.');
        return;
      }
      if(action === 'delete'){
        deleteAuthorizationDossierArchiveEntry(id);
        return;
      }
      if(action === 'restore'){
        restoreAuthorizationDossierFromArchive(entry);
        return;
      }
      if(!entry.data){
        alert('Documentul arhivat nu este disponibil.');
        return;
      }
      const bytes = base64ToUint8Array(entry.data);
      if(!bytes || bytes.length === 0){
        alert('Documentul arhivat nu este disponibil.');
        return;
      }
      const filename = entry.filename || `${slugifyForFilename(entry.name || 'dosar-autorizare', 'dosar-autorizare')}.pdf`;
      if(action === 'preview'){
        const previewWindow = openAuthorizationDossierPreviewWindow();
        renderAuthorizationDossierPreview(previewWindow, bytes, filename);
      } else {
        triggerPdfDownload(bytes, filename);
      }
    });
  });
}

function deleteAuthorizationDossierArchiveEntry(id){
  if(Number.isNaN(id)){
    return;
  }
  const company = getActiveCompany();
  const archive = ensureAuthorizationDossierArchive(company);
  const index = archive.findIndex(entry => entry && entry.id === id);
  if(index === -1){
    return;
  }
  if(!confirm('»òtergi acest dosar din arhivƒÉ? Opera»õia nu poate fi anulatƒÉ.')){
    return;
  }
  archive.splice(index, 1);
  persistState();
  renderAuthorizationDossierArchive();
}

function restoreAuthorizationDossierFromArchive(entry){
  const company = getActiveCompany();
  if(!company || !entry){
    return;
  }
  if(!entry.snapshot){
    alert('Acest dosar arhivat nu con»õine informa»õii pentru restaurare.');
    return;
  }
  const restored = normalizeAuthorizationDossier(entry.snapshot);
  if(!restored){
    alert('Dosarul nu a putut fi restaurat.');
    return;
  }
  restored.id = generateDocumentId('authdos');
  ensureDossierMaterialDocuments(restored);
  ensureDossierLetterStyle(restored);
  ensureDossierCustomSteps(restored);
  ensureAuthorizationDossiers(company).push(restored);
  const archive = ensureAuthorizationDossierArchive(company);
  const archiveIndex = archive.findIndex(item => item && item.id === entry.id);
  if(archiveIndex !== -1){
    archive.splice(archiveIndex, 1);
  }
  activeAuthorizationDossierId = restored.id;
  persistState();
  renderAuthorizationDossierControls();
  renderAuthorizationDossierDetail(restored);
  renderAuthorizationDossierArchive();
  alert('Dosarul a fost restaurat din arhivƒÉ »ôi este disponibil pentru editare.');
}

function loadProcedureDossier(){
  const tbody = document.getElementById('proc_dossier_tbody');
  const wrap = document.getElementById('proc_dossier_list_wrap');
  const empty = document.getElementById('proc_dossier_empty');
  if(!tbody){
    return;
  }
  tbody.innerHTML = '';
  const company = getActiveCompany();
  const docs = Array.isArray(company.procedureDossier) ? company.procedureDossier.slice() : [];
  if(docs.length === 0){
    if(wrap){
      wrap.classList.add('hidden');
    }
    if(empty){
      empty.classList.remove('hidden');
    }
    return;
  }
  if(wrap){
    wrap.classList.remove('hidden');
  }
  if(empty){
    empty.classList.add('hidden');
  }
  docs.sort((a, b) => (a.added_at || '').localeCompare(b.added_at || ''));
  docs.forEach(doc => {
    const tr = document.createElement('tr');
    const addedAt = doc.added_at ? String(doc.added_at).slice(0, 10) : '';
    const filename = doc.name || 'document';
    const nameCell = document.createElement('td');
    nameCell.textContent = filename;
    const dateCell = document.createElement('td');
    dateCell.textContent = addedAt;
    const actionsCell = document.createElement('td');
    actionsCell.className = 'attachment-actions';
    const actionsNode = createAttachmentActionsNode(doc, { fallbackName: filename || 'document.pdf' });
    if(actionsNode){
      actionsCell.appendChild(actionsNode);
    } else {
      const span = document.createElement('span');
      span.className = 'muted';
      span.textContent = 'Document indisponibil';
      actionsCell.appendChild(span);
    }
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'btn ghost small';
    deleteBtn.textContent = '»òterge';
    deleteBtn.setAttribute('data-action', 'delete');
    deleteBtn.setAttribute('data-id', doc.id);
    actionsCell.appendChild(deleteBtn);
    tr.appendChild(nameCell);
    tr.appendChild(dateCell);
    tr.appendChild(actionsCell);
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-action="delete"]').forEach(button => {
    button.addEventListener('click', () => {
      const docId = button.getAttribute('data-id');
      if(docId){
        removeProcedureDossierDocument(docId);
      }
    });
  });
}

async function addProcedureDossierDocument(){
  const input = document.getElementById('proc_dossier_file');
  if(!input || !input.files || !input.files[0]){
    alert('SelecteazƒÉ un fi»ôier de √ÆncƒÉrcat.');
    return;
  }
  const file = input.files[0];
  const allowed = file.type ? (file.type === 'application/pdf' || file.type.startsWith('image/')) : true;
  if(!allowed){
    alert('Sunt acceptate doar fi»ôiere PDF sau imagini.');
    return;
  }
  try {
    const dataUrl = await readFileAsDataURL(file);
    const record = {
      id: generateDocumentId('procdoc'),
      name: file.name || 'document_omologare.pdf',
      data: dataUrl,
      type: file.type || 'application/pdf',
      added_at: new Date().toISOString(),
    };
    const company = getActiveCompany();
    if(!Array.isArray(company.procedureDossier)){
      company.procedureDossier = [];
    }
    company.procedureDossier.push(record);
    persistState();
    loadProcedureDossier();
    input.value = '';
  } catch (err) {
    console.error('Nu s-a putut √ÆncƒÉrca documentul pentru dosarul de omologare.', err);
    alert('√éncƒÉrcarea documentului a e»ôuat. √éncearcƒÉ din nou.');
  }
}

function removeProcedureDossierDocument(documentId){
  const company = getActiveCompany();
  if(!Array.isArray(company.procedureDossier)){
    return;
  }
  company.procedureDossier = company.procedureDossier.filter(item => item && item.id !== documentId);
  persistState();
  loadProcedureDossier();
}

function populateAuthorizationWelderSelect(){
  const select = document.getElementById('auth_welder_select');
  if(!select){
    return;
  }
  const company = getActiveCompany();
  const previous = select.value;
  select.innerHTML = '<option value="">SelecteazƒÉ sudor</option>';
  const ordered = sortWelders(company.welders);
  ordered.forEach(w => {
    const option = document.createElement('option');
    option.value = String(w.id);
    option.textContent = w.name;
    select.appendChild(option);
  });
  const desired = selectedWelder ? String(selectedWelder.id) : previous;
  const exists = Array.from(select.options).some(opt => opt.value === desired);
  select.value = exists ? desired : '';
}

function populateAuthorizationProcedureSelect(){
  const select = document.getElementById('auth_procedure_select');
  if(!select){
    return;
  }
  const company = getActiveCompany();
  const previous = select.value;
  select.innerHTML = '<option value="">SelecteazƒÉ procedeu</option>';
  const list = company.qualifications.filter(q => q && q.category === 'procedee').sort((a, b) => {
    const labelA = `${getStandardLabel(a.standard)} ${a.process || ''}`;
    const labelB = `${getStandardLabel(b.standard)} ${b.process || ''}`;
    return labelA.localeCompare(labelB, 'ro', { sensitivity: 'base' });
  });
  list.forEach(proc => {
    const option = document.createElement('option');
    option.value = String(proc.id);
    const label = getStandardLabel(proc.standard);
    option.textContent = proc.process ? `${label} ¬∑ ${proc.process}` : label;
    select.appendChild(option);
  });
  const exists = Array.from(select.options).some(opt => opt.value === previous);
  select.value = exists ? previous : '';
  select.disabled = select.options.length <= 1;
}

function populateProcedureWelderSelect(){
  const select = document.getElementById('proc_welder_select');
  if(!select){
    return;
  }
  const company = getActiveCompany();
  const previous = select.value;
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = 'Procedeu general';
  select.innerHTML = '';
  select.appendChild(placeholder);
  const ordered = sortWelders(company.welders);
  ordered.forEach(w => {
    const option = document.createElement('option');
    option.value = String(w.id);
    option.textContent = w.name;
    select.appendChild(option);
  });
  const desired = selectedWelder ? String(selectedWelder.id) : previous;
  const exists = Array.from(select.options).some(opt => opt.value === desired);
  select.value = exists ? desired : '';
}

function populatePansonSelect(){
  const select = document.getElementById('w_panson');
  if(!select){
    return;
  }
  const company = getActiveCompany();
  const valueBefore = select.value;
  const manualInput = document.getElementById('w_code_manual');
  select.innerHTML = '';
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = 'SelecteazƒÉ panson';
  select.appendChild(placeholder);
  company.pansoane.filter(p => !p.archived).sort((a, b) => {
    const codeA = a.code ? String(a.code) : '';
    const codeB = b.code ? String(b.code) : '';
    return codeA.localeCompare(codeB, 'ro', { sensitivity: 'base' });
  }).forEach(panson => {
    const option = document.createElement('option');
    option.value = String(panson.id);
    const label = panson.description ? `${panson.code} ¬∑ ${panson.description}` : panson.code;
    option.textContent = label || `Panson #${panson.id}`;
    select.appendChild(option);
  });
  const desired = selectedWelder && selectedWelder.panson_id ? String(selectedWelder.panson_id) : valueBefore;
  const exists = Array.from(select.options).some(opt => opt.value === desired);
  select.value = exists ? desired : '';
  if(!exists && !desired){
    select.value = '';
  }
  if(selectedWelder && manualInput){
    manualInput.value = selectedWelder.code || '';
  }
}

function updateAuthorizationContext(){
  const label = document.getElementById('auth_current_welder');
  if(label){
    if(selectedWelder){
      const position = selectedWelderPosition || getWelderPosition(selectedWelder.id);
      selectedWelderPosition = position;
      label.textContent = position ? `${selectedWelder.name} #${position}` : selectedWelder.name;
    } else {
      label.textContent = '(selecteazƒÉ un sudor)';
    }
  }
  const select = document.getElementById('auth_welder_select');
  if(select){
    const targetValue = selectedWelder ? String(selectedWelder.id) : '';
    if(select.value !== targetValue){
      select.value = targetValue;
    }
  }
  const pansonField = document.getElementById('auth_welder_panson');
  if(pansonField){
    if(selectedWelder){
      const code = selectedWelder.code || getPansonCodeById(selectedWelder.panson_id) || '';
      pansonField.value = code ? code : '‚Äî';
    } else {
      pansonField.value = '';
      pansonField.placeholder = '‚Äî';
    }
  }
}

function handleAuthorizationProcedureChange(){
  const select = document.getElementById('auth_procedure_select');
  if(!select){
    return;
  }
  const value = select.value;
  const processField = document.getElementById('auth_process');
  const positionField = document.getElementById('auth_position');
  const materialField = document.getElementById('auth_base_material');
  const domainField = document.getElementById('auth_thickness_domain');
  if(!value){
    return;
  }
  const id = Number(value);
  if(Number.isNaN(id)){
    return;
  }
  const company = getActiveCompany();
  const procedure = company.qualifications.find(entry => entry && entry.id === id && entry.category === 'procedee');
  if(!procedure){
    return;
  }
  if(processField && procedure.process){
    processField.value = procedure.process;
  }
  if(positionField && procedure.position){
    const desired = procedure.position;
    const options = Array.from(positionField.options || []);
    if(options.some(option => option.value === desired || option.textContent === desired)){
      positionField.value = desired;
    } else {
      positionField.value = desired;
    }
  }
  if(materialField && procedure.product){
    materialField.value = procedure.product;
  }
  if(domainField && procedure.thickness_range){
    domainField.value = procedure.thickness_range;
  }
}

function updateAttachmentPreview(containerId, attachment, options){
  const container = document.getElementById(containerId);
  if(!container){
    return;
  }
  container.innerHTML = '';
  if(!attachment || !attachment.data){
    return;
  }
  const viewLabel = options && options.label ? options.label : 'VizualizeazƒÉ fi»ôier';
  const fallbackName = options && options.fallbackName ? options.fallbackName : 'document';
  const attachmentId = registerAttachment(attachment);
  if(attachmentId){
    const viewButton = document.createElement('button');
    viewButton.type = 'button';
    viewButton.className = 'link-button';
    viewButton.dataset.attachmentView = attachmentId;
    viewButton.dataset.attachmentName = attachment.name || fallbackName;
    viewButton.textContent = viewLabel;
    container.appendChild(viewButton);
  }
  const download = document.createElement('a');
  download.href = attachment.data;
  download.download = attachment.name || fallbackName;
  download.textContent = 'DescarcƒÉ';
  download.className = 'link-button';
  container.appendChild(download);
  const type = attachment.type || '';
  if(type.startsWith('image/') || attachment.data.startsWith('data:image')){
    const preview = document.createElement('img');
    preview.src = attachment.data;
    preview.alt = viewLabel;
    container.appendChild(preview);
  }
}

function updatePansonArchiveToggle(){
  const toggle = document.getElementById('toggle_panson_archive');
  if(!toggle){
    return;
  }
  const company = getActiveCompany();
  const total = Array.isArray(company.archivedPansoane) ? company.archivedPansoane.length : 0;
  const baseLabel = pansonArchiveVisible ? 'Ascunde arhiva pansoane' : 'ArhivƒÉ pansoane';
  toggle.textContent = `${baseLabel} (${total})`;
  toggle.disabled = total === 0 && !pansonArchiveVisible;
}

function updatePansonArchiveVisibility(){
  const panel = document.getElementById('panson_archive_panel');
  if(panel){
    panel.classList.toggle('hidden', !pansonArchiveVisible);
    panel.setAttribute('aria-hidden', pansonArchiveVisible ? 'false' : 'true');
  }
  const toggle = document.getElementById('toggle_panson_archive');
  if(toggle){
    toggle.setAttribute('aria-expanded', pansonArchiveVisible ? 'true' : 'false');
  }
  updatePansonArchiveToggle();
}

function renderPansonArchiveList(){
  const tbody = document.getElementById('panson_archive_tbody');
  const wrap = document.getElementById('panson_archive_table_wrap');
  const emptyState = document.getElementById('panson_archive_empty');
  if(!tbody){
    return;
  }
  tbody.innerHTML = '';
  const company = getActiveCompany();
  const list = Array.isArray(company.archivedPansoane) ? company.archivedPansoane.slice() : [];
  const shouldCollapse = list.length === 0 && pansonArchiveVisible;
  if(list.length === 0){
    if(wrap){
      wrap.classList.add('hidden');
    }
    if(emptyState){
      emptyState.classList.remove('hidden');
    }
    if(shouldCollapse){
      pansonArchiveVisible = false;
    }
  } else {
    if(wrap){
      wrap.classList.remove('hidden');
    }
    if(emptyState){
      emptyState.classList.add('hidden');
    }
    list.sort((a, b) => {
      const codeA = a && a.code ? String(a.code) : '';
      const codeB = b && b.code ? String(b.code) : '';
      return codeA.localeCompare(codeB, 'ro', { sensitivity: 'base' });
    }).forEach(entry => {
      const tr = document.createElement('tr');
      const archivedAt = entry && entry.archived_at ? String(entry.archived_at).slice(0, 10) : '';
      tr.innerHTML = `
        <td>${escapeHtml(entry && entry.code ? entry.code : '')}</td>
        <td>${escapeHtml(entry && entry.description ? entry.description : '')}</td>
        <td>${escapeHtml(archivedAt)}</td>
        <td><button class="btn ghost" data-action="restore" data-id="${entry && entry.id !== undefined ? entry.id : ''}">RestaureazƒÉ</button></td>
      `;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('button[data-action="restore"]').forEach(button => {
      button.addEventListener('click', () => {
        const id = Number(button.getAttribute('data-id'));
        if(Number.isNaN(id)){
          return;
        }
        restorePanson(id);
      });
    });
  }
  updatePansonArchiveToggle();
  if(shouldCollapse){
    updatePansonArchiveVisibility();
  }
}

function loadPansoane(){
  const tbody = document.getElementById('pansoane_tbody');
  const emptyState = document.getElementById('pansoane_empty');
  const countLabel = document.getElementById('panson_count');
  if(!tbody){
    return;
  }
  tbody.innerHTML = '';
  const company = getActiveCompany();
  const activeList = Array.isArray(company.pansoane)
    ? company.pansoane.filter(p => !p.archived)
    : [];
  if(countLabel){
    countLabel.textContent = activeList.length;
  }
  if(activeList.length === 0){
    if(emptyState){
      emptyState.classList.remove('hidden');
    }
  } else {
    if(emptyState){
      emptyState.classList.add('hidden');
    }
    activeList.sort((a, b) => {
      const codeA = a && a.code ? String(a.code) : '';
      const codeB = b && b.code ? String(b.code) : '';
      return codeA.localeCompare(codeB, 'ro', { sensitivity: 'base' });
    }).forEach(panson => {
      const tr = document.createElement('tr');
      const usageCount = company.welders.filter(w => w && w.panson_id === panson.id).length;
      tr.innerHTML = `
        <td>${escapeHtml(panson && panson.code ? panson.code : '')}</td>
        <td>${escapeHtml(panson && panson.description ? panson.description : '')}</td>
        <td>${escapeHtml(usageCount)}</td>
        <td><button class="btn ghost" data-action="archive" data-id="${panson && panson.id !== undefined ? panson.id : ''}">ArhiveazƒÉ</button></td>
      `;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('button[data-action="archive"]').forEach(button => {
      button.addEventListener('click', () => {
        const id = Number(button.getAttribute('data-id'));
        if(Number.isNaN(id)){
          return;
        }
        archivePanson(id);
      });
    });
  }
  renderPansonArchiveList();
  updatePansonArchiveVisibility();
}

function addPanson(){
  const codeInput = document.getElementById('panson_code');
  const descriptionInput = document.getElementById('panson_description');
  if(!codeInput){
    return;
  }
  const codeValue = codeInput.value ? codeInput.value.trim() : '';
  if(!codeValue){
    alert('CompleteazƒÉ codul pansonului.');
    return;
  }
  const descriptionValue = descriptionInput && descriptionInput.value ? descriptionInput.value.trim() : '';
  const company = getActiveCompany();
  const normalizedCode = codeValue.toLowerCase();
  const duplicate = company.pansoane.some(p => p && p.code && p.code.toLowerCase() === normalizedCode)
    || company.archivedPansoane.some(p => p && p.code && p.code.toLowerCase() === normalizedCode);
  if(duplicate){
    alert('ExistƒÉ deja un panson cu acest cod.');
    return;
  }
  const newPanson = {
    id: company.nextPansonId++,
    code: codeValue,
    description: descriptionValue,
    archived: false,
    archived_at: null,
  };
  company.pansoane.push(newPanson);
  persistState();
  loadPansoane();
  populatePansonSelect();
  if(codeInput){
    codeInput.value = '';
  }
  if(descriptionInput){
    descriptionInput.value = '';
  }
}

function archivePanson(id){
  const company = getActiveCompany();
  const index = company.pansoane.findIndex(p => p && p.id === id);
  if(index === -1){
    return;
  }
  const usageCount = company.welders.filter(w => w && w.panson_id === id).length;
  if(usageCount > 0){
    const confirmArchive = confirm('ExistƒÉ sudori care utilizeazƒÉ acest panson. Codul rƒÉm√¢ne salvat la sudorii existen»õi, dar nu va mai putea fi selectat pentru al»õii. Continui?');
    if(!confirmArchive){
      return;
    }
  }
  const [panson] = company.pansoane.splice(index, 1);
  company.archivedPansoane.push({
    id: panson.id,
    code: panson.code,
    description: panson.description,
    archived: true,
    archived_at: new Date().toISOString(),
  });
  persistState();
  loadPansoane();
  populatePansonSelect();
  loadWelders();
}

function restorePanson(id){
  const company = getActiveCompany();
  const index = company.archivedPansoane.findIndex(p => p && p.id === id);
  if(index === -1){
    return;
  }
  const entry = company.archivedPansoane[index];
  let pansonId = entry && entry.id ? entry.id : 0;
  if(pansonId <= 0 || company.pansoane.some(p => p && p.id === pansonId)){
    pansonId = company.nextPansonId++;
  } else if(pansonId >= company.nextPansonId){
    company.nextPansonId = pansonId + 1;
  }
  company.pansoane.push({
    id: pansonId,
    code: entry && entry.code ? entry.code : `P-${pansonId}`,
    description: entry && entry.description ? entry.description : '',
    archived: false,
    archived_at: null,
  });
  company.archivedPansoane.splice(index, 1);
  persistState();
  loadPansoane();
  populatePansonSelect();
  loadWelders();
}


function normalizeWelder(raw){
  if(!raw || typeof raw !== 'object'){
    return null;
  }
  const name = typeof raw.name === 'string' ? normalizeNameInput(raw.name) : '';
  if(!name){
    return null;
  }
  const idValue = Number(raw.id);
  const id = Number.isInteger(idValue) && idValue > 0 ? idValue : 0;
  const code = raw && raw.code !== undefined && raw.code !== null ? raw.code : null;
  const hireDate = raw && raw.hire_date ? raw.hire_date : null;
  const phone = typeof raw.phone === 'string' ? raw.phone.trim() : '';
  let pansonId = null;
  if(raw && raw.panson_id !== undefined && raw.panson_id !== null){
    const numeric = Number(raw.panson_id);
    pansonId = Number.isNaN(numeric) ? null : numeric;
  }
  return {
    id,
    name,
    code,
    phone,
    panson_id: pansonId,
    hire_date: hireDate,
    photo: normalizeWelderAttachment(raw && raw.photo ? raw.photo : null, 'fotografie'),
    id_card: normalizeWelderAttachment(raw && raw.id_card ? raw.id_card : null, 'carte_identitate'),
    diploma: normalizeWelderAttachment(raw && raw.diploma ? raw.diploma : null, 'diploma'),
    contract: normalizeWelderAttachment(raw && raw.contract ? raw.contract : null, 'contract'),
    aptitude: normalizeWelderAttachment(raw && raw.aptitude ? raw.aptitude : null, 'fisa_aptitudini'),
    bundle: normalizeWelderAttachment(raw && raw.bundle ? raw.bundle : null, 'documente_personale'),
    authorization_dossier: Array.isArray(raw && raw.authorization_dossier)
      ? raw.authorization_dossier.map(item => normalizeDossierItem(item, 'document_autorizare')).filter(Boolean)
      : [],
  };
}

function normalizeQualification(raw){
  if(!raw || typeof raw !== 'object'){
    return null;
  }
  const categoryRaw = typeof raw.category === 'string' ? raw.category : '';
  const category = QUALIFICATION_CATEGORIES.includes(categoryRaw)
    ? categoryRaw
    : DEFAULT_QUALIFICATION_CATEGORY;
  const idValue = Number(raw.id);
  const id = Number.isInteger(idValue) && idValue > 0 ? idValue : 0;
  let welderId = null;
  if(raw && raw.welder_id !== undefined && raw.welder_id !== null){
    const numeric = Number(raw.welder_id);
    welderId = Number.isNaN(numeric) ? null : numeric;
  }
  let procedureId = null;
  if(raw && raw.procedure_id !== undefined && raw.procedure_id !== null){
    const numeric = Number(raw.procedure_id);
    procedureId = Number.isNaN(numeric) ? null : numeric;
  }
  const defaultStandard = category === 'procedee' ? DEFAULT_PROCEDURE_STANDARD : DEFAULT_AUTH_STANDARD;
  const standardValue = raw && raw.standard ? raw.standard : defaultStandard;
  const standard = typeof standardValue === 'string' && standardValue.trim()
    ? standardValue.trim()
    : defaultStandard;
  const attachment = raw && raw.attachment
    ? normalizeAttachment(raw.attachment, category === 'procedee' ? 'procedeu.pdf' : 'autorizatie.pdf')
    : null;
  return {
    id,
    welder_id: welderId,
    category,
    standard,
    process: raw && raw.process ? raw.process : '',
    position: raw && raw.position ? raw.position : '',
    base_quality: raw && raw.base_quality ? raw.base_quality : '',
    base_material: raw && raw.base_material ? raw.base_material : '',
    filler_material: raw && raw.filler_material ? raw.filler_material : '',
    base_dimension: raw && raw.base_dimension ? raw.base_dimension : '',
    diameter: raw && raw.diameter ? raw.diameter : '',
    thickness_domain: raw && raw.thickness_domain ? raw.thickness_domain : '',
    observation: raw && raw.observation ? raw.observation : '',
    p_number: raw && raw.p_number ? raw.p_number : null,
    thickness_range: raw && raw.thickness_range ? raw.thickness_range : null,
    product: raw && raw.product ? raw.product : '',
    certificate_no: raw && raw.certificate_no ? raw.certificate_no : null,
    issuer: raw && raw.issuer ? raw.issuer : null,
    expiry_date: category === 'autorizatii' && raw && raw.expiry_date ? raw.expiry_date : null,
    procedure_id: procedureId,
    attachment,
  };
}

function normalizePanson(raw, options){
  if(!raw || typeof raw !== 'object'){
    return null;
  }
  const code = raw.code !== undefined && raw.code !== null ? String(raw.code).trim() : '';
  if(!code){
    return null;
  }
  const idValue = Number(raw.id);
  const id = Number.isInteger(idValue) && idValue > 0 ? idValue : 0;
  const description = typeof raw.description === 'string' ? raw.description.trim() : '';
  const archivedFlag = options && options.archived ? true : Boolean(raw.archived);
  const archivedAt = raw.archived_at || null;
  return {
    id,
    code,
    description,
    archived: archivedFlag,
    archived_at: archivedFlag ? archivedAt : null,
  };
}

function normalizeArchivedEntry(raw){
  if(!raw || typeof raw !== 'object'){
    return null;
  }
  const welderSource = raw.welder && typeof raw.welder === 'object' ? raw.welder : raw;
  const welder = normalizeWelder(welderSource);
  if(!welder){
    return null;
  }
  const qualifications = Array.isArray(raw.qualifications)
    ? raw.qualifications.map(normalizeQualification).filter(Boolean)
    : [];
  return {
    welder,
    archived_at: raw.archived_at || null,
    qualifications,
    reason: typeof raw.reason === 'string' ? raw.reason : '',
  };
}

function createEmptyCompany(id, name){
  const numericId = Number.isInteger(id) && id > 0 ? id : 1;
  return {
    id: numericId,
    name: typeof name === 'string' && name.trim() ? name.trim() : `Companie ${numericId}`,
    welders: [],
    qualifications: [],
    archivedWelders: [],
    pansoane: [],
    archivedPansoane: [],
    logo: null,
    procedureDossier: [],
    authorizationDossiers: [],
    authorizationDossierArchive: [],
    authorizationDossierSettings: { pageNumbering: true },
    reportBranding: { header: [], footer: [] },
    reportBrandingSpacing: 16,
    nextWelderId: 1,
    nextQualificationId: 1,
    nextPansonId: 1,
    nextAuthorizationDossierArchiveId: 1,
  };
}

function ensureCompanyShape(raw, fallbackId, fallbackName){
  const baseId = Number(raw && raw.id);
  const id = Number.isInteger(baseId) && baseId > 0
    ? baseId
    : (Number.isInteger(fallbackId) && fallbackId > 0 ? fallbackId : 1);
  const name = raw && typeof raw.name === 'string' && raw.name.trim()
    ? raw.name.trim()
    : (typeof fallbackName === 'string' && fallbackName.trim() ? fallbackName.trim() : `Companie ${id}`);

  const welders = [];
  let maxWelderId = 0;
  (Array.isArray(raw && raw.welders) ? raw.welders : []).forEach(item => {
    const normalized = normalizeWelder(item);
    if(!normalized){
      return;
    }
    if(normalized.id > 0 && !welders.some(existing => existing.id === normalized.id)){
      maxWelderId = Math.max(maxWelderId, normalized.id);
    } else {
      normalized.id = 0;
    }
    welders.push(normalized);
  });
  welders.forEach(w => {
    if(w.id <= 0){
      w.id = ++maxWelderId;
    }
  });

  const qualifications = [];
  let maxQualificationId = 0;
  const seenQualIds = new Set();
  (Array.isArray(raw && raw.qualifications) ? raw.qualifications : []).forEach(item => {
    const normalized = normalizeQualification(item);
    if(!normalized){
      return;
    }
    if(normalized.id > 0 && !seenQualIds.has(normalized.id)){
      seenQualIds.add(normalized.id);
      maxQualificationId = Math.max(maxQualificationId, normalized.id);
    } else {
      normalized.id = 0;
    }
    qualifications.push(normalized);
  });
  qualifications.forEach(q => {
    if(q.id <= 0){
      q.id = ++maxQualificationId;
      seenQualIds.add(q.id);
    }
  });

  const archivedWelders = (Array.isArray(raw && raw.archivedWelders) ? raw.archivedWelders : [])
    .map(normalizeArchivedEntry)
    .filter(Boolean);

  const pansoane = [];
  let maxPansonId = 0;
  (Array.isArray(raw && raw.pansoane) ? raw.pansoane : []).forEach(item => {
    const normalized = normalizePanson(item, { archived: false });
    if(!normalized){
      return;
    }
    normalized.archived = false;
    normalized.archived_at = null;
    if(normalized.id > 0 && !pansoane.some(existing => existing.id === normalized.id)){
      maxPansonId = Math.max(maxPansonId, normalized.id);
    } else {
      normalized.id = 0;
    }
    pansoane.push(normalized);
  });
  pansoane.forEach(p => {
    if(p.id <= 0){
      p.id = ++maxPansonId;
    }
  });

  const archivedPansoane = (Array.isArray(raw && raw.archivedPansoane) ? raw.archivedPansoane : [])
    .map(item => {
      const normalized = normalizePanson(item, { archived: true });
      if(!normalized){
        return null;
      }
      normalized.archived = true;
      return normalized;
    })
    .filter(Boolean);

  const nextWelderId = Number.isInteger(raw && raw.nextWelderId) && raw.nextWelderId > maxWelderId
    ? raw.nextWelderId
    : maxWelderId + 1;

  const nextQualificationId = Number.isInteger(raw && raw.nextQualificationId) && raw.nextQualificationId > maxQualificationId
    ? raw.nextQualificationId
    : maxQualificationId + 1;

  const nextPansonId = Number.isInteger(raw && raw.nextPansonId) && raw.nextPansonId > maxPansonId
    ? raw.nextPansonId
    : maxPansonId + 1;

  const logo = raw && raw.logo ? normalizeAttachment(raw.logo, 'logo') : null;
  const procedureDossier = Array.isArray(raw && raw.procedureDossier)
    ? raw.procedureDossier.map(item => normalizeDossierItem(item, 'document_omologare')).filter(Boolean)
    : [];
  const authorizationDossiers = Array.isArray(raw && raw.authorizationDossiers)
    ? raw.authorizationDossiers.map(normalizeAuthorizationDossier).filter(Boolean)
    : [];
  const authorizationArchiveRaw = Array.isArray(raw && raw.authorizationDossierArchive)
    ? raw.authorizationDossierArchive
    : [];
  const authorizationDossierArchive = authorizationArchiveRaw
    .map(normalizeAuthorizationArchiveEntry)
    .filter(Boolean);
  const rawSettings = raw && raw.authorizationDossierSettings && typeof raw.authorizationDossierSettings === 'object'
    ? raw.authorizationDossierSettings
    : null;
  const authorizationDossierSettings = {
    pageNumbering: !(rawSettings && rawSettings.pageNumbering === false),
  };
  let maxArchiveId = 0;
  authorizationDossierArchive.forEach(entry => {
    if(entry && entry.id && entry.id > maxArchiveId){
      maxArchiveId = entry.id;
    }
  });
  const reportBranding = normalizeReportBranding(raw && raw.reportBranding);
  const reportBrandingSpacing = clampBrandingSpacing(raw && raw.reportBrandingSpacing);
  const nextArchiveId = Number.isInteger(raw && raw.nextAuthorizationDossierArchiveId)
    && raw.nextAuthorizationDossierArchiveId > maxArchiveId
      ? raw.nextAuthorizationDossierArchiveId
      : maxArchiveId + 1;

  return {
    id,
    name,
    welders,
    qualifications,
    archivedWelders,
    pansoane,
    archivedPansoane,
    logo,
    procedureDossier,
    authorizationDossiers,
    authorizationDossierArchive,
    authorizationDossierSettings,
    reportBranding,
    reportBrandingSpacing,
    nextWelderId,
    nextQualificationId,
    nextPansonId,
    nextAuthorizationDossierArchiveId: nextArchiveId,
  };
}

function createDefaultState(){
  const company = createEmptyCompany(1, 'Companie implicitƒÉ');
  return {
    companies: [company],
    activeCompanyId: company.id,
    nextCompanyId: company.id + 1,
    standards: cloneBaseStandards(),
    generalSettings: normalizeGeneralSettings(),
  };
}

function deserializeStateFromObject(parsed){
  if(!parsed || typeof parsed !== 'object'){
    return null;
  }
  if(Array.isArray(parsed.companies)){
    const companies = parsed.companies.map((company, index) => ensureCompanyShape(
      company,
      Number(company && company.id) || index + 1,
      company && company.name ? company.name : `Companie ${index + 1}`
    )).filter(Boolean);
    if(companies.length === 0){
      const fallback = createEmptyCompany(1, 'Companie implicitƒÉ');
      companies.push(fallback);
    }
    const maxId = companies.reduce((max, company) => Math.max(max, company.id), 0);
    const parsedNextCompany = Number(parsed.nextCompanyId);
    const nextCompanyId = Number.isInteger(parsedNextCompany) && parsedNextCompany > maxId
      ? parsedNextCompany
      : maxId + 1;
    let activeCompanyId = Number(parsed.activeCompanyId) || (companies[0] ? companies[0].id : 1);
    if(!companies.some(company => company.id === activeCompanyId)){
      activeCompanyId = companies[0].id;
    }
    const standards = ensureStandards(parsed && parsed.standards);
    return {
      companies,
      activeCompanyId,
      nextCompanyId,
      standards,
      generalSettings: normalizeGeneralSettings(parsed.generalSettings),
    };
  }
  if(Array.isArray(parsed.welders) || Array.isArray(parsed.qualifications)){
    const legacyCompany = ensureCompanyShape({
      id: 1,
      name: parsed && typeof parsed.companyName === 'string' ? parsed.companyName : 'Companie implicitƒÉ',
      welders: parsed && parsed.welders,
      qualifications: parsed && parsed.qualifications,
      archivedWelders: parsed && parsed.archivedWelders,
      nextWelderId: parsed && parsed.nextWelderId,
      nextQualificationId: parsed && parsed.nextQualificationId,
    }, 1, 'Companie implicitƒÉ');
    return {
      companies: [legacyCompany],
      activeCompanyId: legacyCompany.id,
      nextCompanyId: legacyCompany.id + 1,
      standards: cloneBaseStandards(),
      generalSettings: normalizeGeneralSettings(parsed.generalSettings),
    };
  }
  return null;
}

function loadState(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      return createDefaultState();
    }
    const parsed = JSON.parse(raw);
    const normalized = deserializeStateFromObject(parsed);
    if(normalized){
      return normalized;
    }
  } catch (err) {
    console.warn('Nu se pot √ÆncƒÉrca datele din localStorage.', err);
  }
  return createDefaultState();
}

function getActiveCompany(){
  if(!state || !Array.isArray(state.companies)){
    state = createDefaultState();
  }
  let company = state.companies.find(entry => entry.id === state.activeCompanyId);
  if(!company){
    if(state.companies.length === 0){
      const fallback = createEmptyCompany(state.nextCompanyId || 1, 'Companie implicitƒÉ');
      state.companies.push(fallback);
      state.activeCompanyId = fallback.id;
      if(!state.nextCompanyId || state.nextCompanyId <= fallback.id){
        state.nextCompanyId = fallback.id + 1;
      }
      persistState();
      return fallback;
    }
    company = state.companies[0];
    state.activeCompanyId = company.id;
    persistState();
  }
  return company;
}

function getCompanyById(id){
  if(!state || !Array.isArray(state.companies)){
    return null;
  }
  const numeric = Number(id);
  if(Number.isNaN(numeric)){
    return null;
  }
  return state.companies.find(entry => entry.id === numeric) || null;
}

function persistState(){
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (err) {
    console.error('Nu pot salva datele √Æn localStorage.', err);
    alert('Nu s-au putut salva datele √Æn browser. VerificƒÉ spa»õiul disponibil sau permisiunile.');
  }
}

function exportState(){
  try {
    persistState();
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const stamp = new Date().toISOString().replace(/[:.]/g, '-');
    const a = document.createElement('a');
    a.href = url;
    a.download = `gestiune_sudori_${stamp}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    console.error('Exportul a e»ôuat.', err);
    alert('Nu s-a putut genera fi»ôierul. √éncearcƒÉ din nou.');
  }
}

function importStatePayload(payload){
  const normalized = deserializeStateFromObject(payload);
  if(!normalized){
    throw new Error('StructurƒÉ de date invalidƒÉ.');
  }
  state = normalized;
  ensureStateStandards();
  syncStandardsFromState();
  ensureGeneralSettings();
  selectedWelder = null;
  selectedWelderPosition = null;
  activeAuthorizationDossierId = null;
  persistState();
  refreshAllFromStorage();
}

function handleImportStateFile(event){
  const input = event.target;
  if(!input || !input.files || !input.files[0]){
    return;
  }
  if(!confirm('Importul bazei de date va √Ænlocui toate datele existente. Continui?')){
    input.value = '';
    return;
  }
  const file = input.files[0];
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const text = typeof reader.result === 'string'
        ? reader.result
        : String(reader.result || '');
      const parsed = JSON.parse(text);
      importStatePayload(parsed);
      alert('Baza de date a fost importatƒÉ cu succes.');
    } catch (err) {
      console.error('Importul bazei de date a e»ôuat.', err);
      alert('Fi»ôierul selectat nu a putut fi importat. VerificƒÉ formatul JSON.');
    } finally {
      input.value = '';
    }
  };
  reader.onerror = () => {
    console.error('Nu s-a putut citi fi»ôierul selectat pentru import.');
    alert('Citirea fi»ôierului a e»ôuat. √éncearcƒÉ din nou.');
    input.value = '';
  };
  reader.readAsText(file);
}

function escapeHtml(value){
  var safeValue = value === undefined || value === null ? '' : value;
  return String(safeValue).replace(/[&<>"']/g, function(ch){
    return ESCAPE_MAP[ch];
  });
}

function createAttachmentActionsHtml(attachment, options){
  if(!attachment || !attachment.data){
    return '';
  }
  const attachmentId = registerAttachment(attachment);
  const viewLabel = options && options.viewLabel ? options.viewLabel : 'VizualizeazƒÉ';
  const downloadLabel = options && options.downloadLabel ? options.downloadLabel : 'DescarcƒÉ';
  const fallbackName = options && options.fallbackName ? options.fallbackName : 'document.pdf';
  const name = attachment.name || fallbackName;
  const safeName = escapeHtml(name);
  const href = escapeHtml(attachment.data);
  return `<div class="attachment-actions"><button type="button" class="link-button" data-attachment-view="${attachmentId}" data-attachment-name="${safeName}">${viewLabel}</button><a class="attachment-link" href="${href}" download="${safeName}">${downloadLabel}</a></div>`;
}

function createAttachmentActionsNode(attachment, options){
  const html = createAttachmentActionsHtml(attachment, options);
  if(!html){
    return null;
  }
  const wrapper = document.createElement('div');
  wrapper.innerHTML = html.trim();
  return wrapper.firstElementChild;
}

function openDocumentViewer(attachment, title){
  const safeTitle = title || (attachment && attachment.name) || 'Document';
  if(!attachment || !attachment.data){
    alert('Documentul nu este disponibil pentru vizualizare.');
    return;
  }
  let objectUrl = null;
  try {
    objectUrl = dataUrlToObjectUrl(attachment.data);
  } catch (err) {
    console.warn('Nu s-a putut crea URL-ul temporar pentru document.', err);
  }
  const viewerUrl = objectUrl || attachment.data;
  let viewerWindow = null;
  try {
    viewerWindow = window.open('', '_blank');
  } catch (err) {
    console.warn('Nu s-a putut deschide fereastra de previzualizare.', err);
  }
  if(viewerWindow){
    try {
      viewerWindow.document.title = safeTitle;
      viewerWindow.document.body.style.margin = '0';
      viewerWindow.document.body.style.height = '100vh';
      const isImage = (attachment.type && attachment.type.startsWith('image/')) || attachment.data.startsWith('data:image');
      if(isImage){
        viewerWindow.document.body.innerHTML = `<img src="${viewerUrl}" alt="${escapeHtml(safeTitle)}" style="display:block;width:100%;height:auto;object-fit:contain;" />`;
      } else {
        const mime = escapeHtml(attachment.type || 'application/pdf');
        viewerWindow.document.body.innerHTML = `<embed src="${viewerUrl}#toolbar=1&view=Fit" type="${mime}" style="width:100%;height:100%;" />`;
      }
      if(objectUrl && objectUrl.startsWith('blob:')){
        viewerWindow.addEventListener('beforeunload', () => {
          try { URL.revokeObjectURL(objectUrl); } catch (err) { console.warn('Nu s-a putut elibera URL-ul previzualizƒÉrii.', err); }
        }, { once: true });
      }
      return;
    } catch (err) {
      console.error('Previzualizarea √Æntr-o fereastrƒÉ nouƒÉ a e»ôuat. Se folose»ôte varianta fallback.', err);
    }
  }
  const modal = document.getElementById('document_viewer');
  const body = document.getElementById('document_viewer_body');
  const headerTitle = document.getElementById('document_viewer_title');
  if(!modal || !body){
    return;
  }
  if(activeViewerUrl){
    try { URL.revokeObjectURL(activeViewerUrl); } catch (err) { console.warn('Nu s-a putut revoca URL-ul temporar.', err); }
    activeViewerUrl = null;
  }
  body.innerHTML = '';
  if(headerTitle){
    headerTitle.textContent = safeTitle;
  }
  const type = attachment.type || '';
  let node = null;
  if(type.startsWith('image/') || attachment.data.startsWith('data:image')){
    const img = document.createElement('img');
    img.src = attachment.data;
    img.alt = safeTitle;
    node = img;
  } else {
    const fallbackUrl = objectUrl || attachment.data;
    if(fallbackUrl && fallbackUrl.startsWith('blob:')){
      activeViewerUrl = fallbackUrl;
    }
    const frame = document.createElement('iframe');
    frame.src = fallbackUrl;
    frame.title = safeTitle;
    node = frame;
  }
  if(!node){
    const fallback = document.createElement('p');
    fallback.className = 'section-text';
    fallback.textContent = 'Documentul nu a putut fi afi»ôat.';
    node = fallback;
  }
  body.appendChild(node);
  modal.classList.add('open');
  modal.setAttribute('aria-hidden', 'false');
  document.body.dataset.viewerOpen = 'true';
  document.body.style.overflow = 'hidden';
}

function closeDocumentViewer(){
  const modal = document.getElementById('document_viewer');
  const body = document.getElementById('document_viewer_body');
  if(activeViewerUrl){
    try { URL.revokeObjectURL(activeViewerUrl); } catch (err) { console.warn('Nu s-a putut revoca URL-ul temporar.', err); }
    activeViewerUrl = null;
  }
  if(body){
    body.innerHTML = '';
  }
  if(modal){
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden', 'true');
  }
  if(document.body.dataset.viewerOpen){
    delete document.body.dataset.viewerOpen;
  }
  if(!document.body.dataset.welderModalOpen && !document.body.dataset.brandingModalOpen){
    document.body.style.overflow = '';
  }
}

function statusBadge(expiry){
  if(!expiry){
    return '<span class="status warn">n/a</span>';
  }
  const d = new Date(expiry);
  if(Number.isNaN(d.getTime())){
    return '<span class="status warn">n/a</span>';
  }
  const today = new Date();
  today.setHours(0,0,0,0);
  d.setHours(0,0,0,0);
  const diff = Math.ceil((d - today) / (1000*60*60*24));
  if(diff < 0) return '<span class="status bad">expirat</span>';
  if(diff <= 30) return '<span class="status warn">aproape expirat</span>';
  return '<span class="status ok">activ</span>';
}

function getExpiryStatus(expiry){
  if(!expiry){
    return 'ok';
  }
  const d = new Date(expiry);
  if(Number.isNaN(d.getTime())){
    return 'warn';
  }
  const today = new Date();
  today.setHours(0,0,0,0);
  d.setHours(0,0,0,0);
  const diff = Math.ceil((d - today) / (1000*60*60*24));
  if(diff < 0){
    return 'bad';
  }
  if(diff <= 30){
    return 'warn';
  }
  return 'ok';
}

function buildWelderQualificationSummaries(welderId, company){
  const context = company || getActiveCompany();
  if(!context || !welderId){
    return {
      statusHtml: '<span class="muted">FƒÉrƒÉ autorizƒÉri</span>',
      processHtml: '<span class="muted">‚Äî</span>',
    };
  }
  const entries = context.qualifications.filter(q => q.welder_id === welderId && q.category === 'autorizatii');
  if(entries.length === 0){
    return {
      statusHtml: '<span class="muted">FƒÉrƒÉ autorizƒÉri</span>',
      processHtml: '<span class="muted">‚Äî</span>',
    };
  }
  const sorted = entries.slice().sort((a, b) => {
    const aDate = a && a.expiry_date ? a.expiry_date : '';
    const bDate = b && b.expiry_date ? b.expiry_date : '';
    return aDate.localeCompare(bDate);
  });
  const statusHtml = sorted.map(q => {
    const status = getExpiryStatus(q && q.expiry_date ? q.expiry_date : null);
    const standardLabel = escapeHtml(getStandardLabel(q && q.standard ? q.standard : ''));
    const expiryText = q && q.expiry_date ? ` ¬∑ ${escapeHtml(q.expiry_date)}` : ' ¬∑ fƒÉrƒÉ termen';
    return `<span class="status-chip ${status}"><span class="dot"></span>${standardLabel}${expiryText}</span>`;
  }).join('');
  const processHtml = sorted.map(q => {
    const status = getExpiryStatus(q && q.expiry_date ? q.expiry_date : null);
    const processParts = [];
    if(q && q.process){
      processParts.push(escapeHtml(q.process));
    }
    const procedureLabel = resolveProcedureLabel(context, q && q.procedure_id ? q.procedure_id : null);
    if(procedureLabel){
      processParts.push(escapeHtml(procedureLabel));
    }
    const label = processParts.length ? processParts.join(' ¬∑ ') : '‚Äî';
    return `<span class="status-chip ${status}"><span class="dot"></span>${label}</span>`;
  }).join('');
  return {
    statusHtml,
    processHtml,
  };
}

function computeWelderStats(welderId){
  const company = getActiveCompany();
  const list = company.qualifications.filter(q => q.welder_id === welderId && q.category === 'autorizatii');
  const today = new Date();
  today.setHours(0,0,0,0);
  let activeCount = 0;
  let nextExpiring = null;

  list.forEach(q => {
    if(!q.expiry_date){
      activeCount += 1;
      return;
    }
    const exp = new Date(q.expiry_date);
    if(Number.isNaN(exp.getTime())){
      return;
    }
    exp.setHours(0,0,0,0);
    if(exp >= today){
      activeCount += 1;
    }
    if(!nextExpiring || exp < nextExpiring){
      nextExpiring = exp;
    }
  });

  return {
    activeCount,
    nextExpiring: nextExpiring ? nextExpiring.toISOString().slice(0,10) : '',
  };
}

function sortWelders(list){
  return [].concat(list).sort(function(a, b){
    const nameA = a && a.name ? a.name : '';
    const nameB = b && b.name ? b.name : '';
    return nameA.localeCompare(nameB, 'ro', { sensitivity: 'base' });
  });
}

function getWelderPosition(welderId){
  const company = getActiveCompany();
  const ordered = sortWelders(company.welders);
  const index = ordered.findIndex(w => w.id === welderId);
  return index === -1 ? null : index + 1;
}

function findWelderNameById(welderId){
  if(welderId === null || welderId === undefined){
    return '';
  }
  if(!state || !Array.isArray(state.companies)){
    return '';
  }
  for(const company of state.companies){
    if(!company){
      continue;
    }
    const activeMatch = Array.isArray(company.welders)
      ? company.welders.find(w => w && w.id === welderId)
      : null;
    if(activeMatch){
      return activeMatch.name || '';
    }
    const archivedMatch = Array.isArray(company.archivedWelders)
      ? company.archivedWelders.find(entry => entry && entry.welder && entry.welder.id === welderId)
      : null;
    if(archivedMatch && archivedMatch.welder){
      return archivedMatch.welder.name || '';
    }
  }
  return '';
}

function getPansonCodeById(pansonId){
  if(!pansonId){
    return '';
  }
  const company = getActiveCompany();
  if(!company){
    return '';
  }
  const active = Array.isArray(company.pansoane)
    ? company.pansoane.find(p => p && p.id === pansonId)
    : null;
  if(active && active.code){
    return active.code;
  }
  const archived = Array.isArray(company.archivedPansoane)
    ? company.archivedPansoane.find(p => p && p.id === pansonId)
    : null;
  return archived && archived.code ? archived.code : '';
}

function updateArchiveToggleLabel(shownCount, totalCount){
  const toggle = document.getElementById('toggle_archive');
  if(!toggle){
    return;
  }
  const company = getActiveCompany();
  const total = typeof totalCount === 'number' ? totalCount : company.archivedWelders.length;
  const shown = typeof shownCount === 'number' ? shownCount : total;
  const baseLabel = archiveVisible ? 'Ascunde arhiva' : 'ArhivƒÉ sudori';
  const countLabel = total === 0
    ? '0'
    : (shown === total ? `${total}` : `${shown}/${total}`);
  toggle.textContent = `${baseLabel} (${countLabel})`;
  toggle.disabled = total === 0 && !archiveVisible;
}

function updateArchiveVisibility(shownCount, totalCount){
  const panel = document.getElementById('archive_panel');
  if(panel){
    panel.classList.toggle('hidden', !archiveVisible);
    panel.setAttribute('aria-hidden', archiveVisible ? 'false' : 'true');
  }
  const toggle = document.getElementById('toggle_archive');
  if(toggle){
    toggle.setAttribute('aria-expanded', archiveVisible ? 'true' : 'false');
  }
  const company = getActiveCompany();
  if(typeof shownCount === 'number' && typeof totalCount === 'number'){
    updateArchiveToggleLabel(shownCount, totalCount);
  } else {
    const total = company.archivedWelders.filter(entry => entry && entry.welder).length;
    if(total === 0){
      updateArchiveToggleLabel(0, 0);
    } else {
      const search = archiveSearchTerm.trim().toLowerCase();
      if(!search){
        updateArchiveToggleLabel(total, total);
      } else {
        const shown = company.archivedWelders.filter(entry => {
          if(!entry || !entry.welder){
            return false;
          }
          const name = entry.welder.name ? entry.welder.name.toLowerCase() : '';
          const code = entry.welder.code !== undefined && entry.welder.code !== null
            ? String(entry.welder.code).toLowerCase()
            : '';
          const reason = entry && typeof entry.reason === 'string' ? entry.reason.toLowerCase() : '';
          return `${name} ${code} ${reason}`.includes(search);
        }).length;
        updateArchiveToggleLabel(shown, total);
      }
    }
  }
}

function renderArchiveList(){
  const tbody = document.getElementById('archive_tbody');
  const wrap = document.getElementById('archive_table_wrap');
  const emptyState = document.getElementById('archive_empty');
  const noResults = document.getElementById('archive_no_results');
  const searchInput = document.getElementById('archive_search');
  const company = getActiveCompany();
  if(tbody){
    tbody.innerHTML = '';
  }
  const archivedEntries = company.archivedWelders.filter(entry => entry && entry.welder);
  const totalEntries = archivedEntries.length;
  const search = archiveSearchTerm.trim().toLowerCase();
  const filtered = !search
    ? archivedEntries
    : archivedEntries.filter(entry => {
        const welder = entry && entry.welder ? entry.welder : {};
        const name = welder && welder.name ? welder.name.toLowerCase() : '';
        const code = welder && welder.code !== undefined && welder.code !== null
          ? String(welder.code).toLowerCase()
          : '';
        const reason = entry && typeof entry.reason === 'string' ? entry.reason.toLowerCase() : '';
        return `${name} ${code} ${reason}`.includes(search);
      });
  const sorted = filtered.slice().sort((a, b) => {
    const nameA = a && a.welder && a.welder.name ? a.welder.name : '';
    const nameB = b && b.welder && b.welder.name ? b.welder.name : '';
    if(nameA && nameB){
      return nameA.localeCompare(nameB, 'ro', { sensitivity: 'base' });
    }
    return nameA.localeCompare(nameB);
  });

  if(tbody){
    sorted.forEach(entry => {
      const welder = entry.welder || {};
      let archiveIndex = company.archivedWelders.indexOf(entry);
      if(archiveIndex === -1 && welder && welder.id !== undefined){
        archiveIndex = company.archivedWelders.findIndex(item => item && item.welder && item.welder.id === welder.id);
      }
      const archivedAt = entry && entry.archived_at ? String(entry.archived_at).slice(0, 10) : '';
      const qualifications = Array.isArray(entry.qualifications) ? entry.qualifications.length : 0;
      const reasonText = entry && typeof entry.reason === 'string' ? entry.reason : '';
      const reasonCell = reasonText ? escapeHtml(reasonText) : '<span class="muted">‚Äî</span>';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(welder && welder.name ? welder.name : '(fƒÉrƒÉ nume)')}</td>
        <td>${escapeHtml(welder && welder.code !== undefined && welder.code !== null ? welder.code : '')}</td>
        <td>${escapeHtml(archivedAt)}</td>
        <td>${reasonCell}</td>
        <td>${qualifications}</td>
        <td><button type="button" class="btn secondary" data-action="restore" data-id="${welder && welder.id !== undefined ? welder.id : ''}" data-index="${archiveIndex >= 0 ? archiveIndex : ''}">RestaureazƒÉ</button></td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('button[data-action="restore"]').forEach(button => {
      button.addEventListener('click', () => {
        const rawId = button.getAttribute('data-id');
        const hasId = rawId !== null && rawId !== '';
        const id = hasId ? Number(rawId) : NaN;
        const rawIndex = button.getAttribute('data-index');
        const hasIndex = rawIndex !== null && rawIndex !== '';
        const archiveIndex = hasIndex ? Number(rawIndex) : NaN;
        if(Number.isNaN(id) && Number.isNaN(archiveIndex)){
          return;
        }
        const archivedEntry = !Number.isNaN(id)
          ? company.archivedWelders.find(item => item && item.welder && item.welder.id === id)
          : company.archivedWelders[archiveIndex];
        const displayName = archivedEntry && archivedEntry.welder && archivedEntry.welder.name
          ? archivedEntry.welder.name
          : 'acest sudor';
        if(!confirm(`Reactivezi sudorul ${displayName} »ôi autoriza»õiile sale?`)){
          return;
        }
        restoreArchivedWelder(id, Number.isNaN(archiveIndex) ? null : archiveIndex);
      });
    });
  }

  if(searchInput){
    if(totalEntries === 0){
      archiveSearchTerm = '';
    }
    if(searchInput.value !== archiveSearchTerm){
      searchInput.value = archiveSearchTerm;
    }
    searchInput.disabled = totalEntries === 0;
  }
  if(wrap){
    wrap.classList.toggle('hidden', sorted.length === 0);
  }
  if(emptyState){
    emptyState.classList.toggle('hidden', totalEntries !== 0);
  }
  if(noResults){
    noResults.classList.toggle('hidden', !(totalEntries > 0 && sorted.length === 0));
  }
  if(totalEntries === 0 && archiveVisible){
    archiveVisible = false;
  }
  updateArchiveVisibility(sorted.length, totalEntries);
}

function populateCompanySelector(){
  const select = document.getElementById('company_selector');
  if(!select){
    return;
  }
  select.innerHTML = '';
  if(!state || !Array.isArray(state.companies) || state.companies.length === 0){
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'FƒÉrƒÉ companii';
    select.appendChild(option);
    select.disabled = true;
    return;
  }
  select.disabled = false;
  state.companies.forEach(company => {
    const option = document.createElement('option');
    option.value = String(company.id);
    option.textContent = company.name || `Companie ${company.id}`;
    select.appendChild(option);
  });
  const desiredValue = String(state.activeCompanyId);
  if(select.value !== desiredValue){
    select.value = desiredValue;
  }
}

function updateTopbarCompanyLogo(){
  const logoImg = document.getElementById('active_company_logo');
  if(!logoImg){
    return;
  }
  const company = getActiveCompany();
  if(company && company.logo && company.logo.data){
    logoImg.src = company.logo.data;
    logoImg.alt = `Logo ${company.name || 'companie'}`;
    logoImg.classList.add('visible');
  } else {
    logoImg.removeAttribute('src');
    logoImg.alt = 'Logo companie';
    logoImg.classList.remove('visible');
  }
}

function renameCompany(id, newName){
  const company = getCompanyById(id);
  if(!company){
    return;
  }
  const trimmed = typeof newName === 'string' ? newName.trim() : '';
  if(!trimmed){
    alert('Numele companiei nu poate fi gol.');
    return;
  }
  if(company.name === trimmed){
    return;
  }
  company.name = trimmed;
  persistState();
  populateCompanySelector();
  renderCompanySettings();
  updateHomeDashboard();
}

function renderCompanySettings(){
  const container = document.getElementById('company_list');
  if(!container){
    return;
  }
  container.innerHTML = '';
  if(!state || !Array.isArray(state.companies) || state.companies.length === 0){
    const empty = document.createElement('p');
    empty.className = 'muted';
    empty.textContent = 'AdaugƒÉ o companie pentru a √Æncepe eviden»õa.';
    container.appendChild(empty);
    return;
  }
  state.companies.forEach(company => {
    const row = document.createElement('div');
    row.className = 'company-item';

    const nameWrapper = document.createElement('div');
    nameWrapper.style.flex = '1 1 220px';
    const nameLabel = document.createElement('label');
    nameLabel.className = 'muted';
    nameLabel.textContent = 'Nume companie';
    nameLabel.style.display = 'block';
    nameLabel.style.marginBottom = '4px';
    const nameInput = document.createElement('input');
    nameInput.value = company.name || '';
    nameInput.setAttribute('data-id', String(company.id));
    nameInput.addEventListener('keydown', event => {
      if(event.key === 'Enter'){
        event.preventDefault();
        renameCompany(company.id, nameInput.value);
      }
    });
    nameWrapper.appendChild(nameLabel);
    nameWrapper.appendChild(nameInput);
    row.appendChild(nameWrapper);

    const logoWrapper = document.createElement('div');
    logoWrapper.style.display = 'flex';
    logoWrapper.style.flexDirection = 'column';
    logoWrapper.style.gap = '8px';
    logoWrapper.style.alignItems = 'flex-start';
    const logoPreview = document.createElement('div');
    logoPreview.className = 'logo-preview';
    if(company.logo && company.logo.data){
      const img = document.createElement('img');
      img.src = company.logo.data;
      img.alt = `Logo ${company.name || ''}`;
      logoPreview.appendChild(img);
    } else {
      logoPreview.textContent = 'FƒÉrƒÉ logo';
    }
    logoWrapper.appendChild(logoPreview);
    const logoInput = document.createElement('input');
    logoInput.type = 'file';
    logoInput.accept = 'image/*';
    logoInput.addEventListener('change', async event => {
      const file = event.target.files && event.target.files[0];
      if(file){
        await handleCompanyLogoChange(company.id, file);
      }
    });
    logoWrapper.appendChild(logoInput);
    const removeLogoButton = document.createElement('button');
    removeLogoButton.type = 'button';
    removeLogoButton.className = 'btn ghost';
    removeLogoButton.textContent = 'EliminƒÉ logo';
    removeLogoButton.disabled = !(company.logo && company.logo.data);
    removeLogoButton.addEventListener('click', () => removeCompanyLogo(company.id));
    logoWrapper.appendChild(removeLogoButton);
    row.appendChild(logoWrapper);

    const totalAuthorizations = company.qualifications.filter(q => q && q.category === 'autorizatii').length;
    const totalProcedures = company.qualifications.filter(q => q && q.category === 'procedee').length;
    const statsTag = document.createElement('span');
    statsTag.className = 'tag';
    statsTag.style.marginLeft = 'auto';
    statsTag.textContent = `Sudori: ${company.welders.length} ¬∑ Autoriza»õii: ${totalAuthorizations} ¬∑ Procedee: ${totalProcedures}`;
    row.appendChild(statsTag);

    const saveButton = document.createElement('button');
    saveButton.type = 'button';
    saveButton.className = 'btn ghost';
    saveButton.textContent = 'SalveazƒÉ numele';
    saveButton.addEventListener('click', () => renameCompany(company.id, nameInput.value));

    const activateButton = document.createElement('button');
    activateButton.type = 'button';
    activateButton.className = company.id === state.activeCompanyId ? 'btn secondary' : 'btn';
    activateButton.textContent = company.id === state.activeCompanyId ? 'ActivƒÉ' : 'SeteazƒÉ activƒÉ';
    activateButton.disabled = company.id === state.activeCompanyId;
    activateButton.addEventListener('click', () => setActiveCompany(company.id));

    const actionsWrapper = document.createElement('div');
    actionsWrapper.style.display = 'flex';
    actionsWrapper.style.flexWrap = 'wrap';
    actionsWrapper.style.alignItems = 'center';
    actionsWrapper.style.gap = '8px';
    actionsWrapper.appendChild(saveButton);

    const brandingButton = document.createElement('button');
    brandingButton.type = 'button';
    brandingButton.className = 'btn ghost';
    brandingButton.textContent = '‚öôÔ∏è';
    brandingButton.title = 'SetƒÉri antet & subsol rapoarte';
    brandingButton.setAttribute('aria-label', `SetƒÉri antet »ôi subsol pentru ${company.name || 'companie'}`);
    brandingButton.addEventListener('click', () => openBrandingModal(company.id));
    actionsWrapper.appendChild(brandingButton);

    const deleteButton = document.createElement('button');
    deleteButton.type = 'button';
    deleteButton.className = 'btn danger';
    deleteButton.textContent = '»òterge compania';
    deleteButton.disabled = state.companies.length <= 1;
    deleteButton.addEventListener('click', () => deleteCompany(company.id));
    actionsWrapper.appendChild(deleteButton);

    actionsWrapper.appendChild(activateButton);
    row.appendChild(actionsWrapper);

    container.appendChild(row);
  });
  updateTopbarCompanyLogo();
  refreshBrandingEditors();
}

function deleteCompany(companyId){
  if(!state || !Array.isArray(state.companies)){
    return;
  }
  if(state.companies.length <= 1){
    alert('Nu po»õi »ôterge ultima companie disponibilƒÉ.');
    return;
  }
  const company = getCompanyById(companyId);
  if(!company){
    alert('Compania nu a fost gƒÉsitƒÉ.');
    return;
  }
  if(!confirm(`»òtergi compania ‚Äû${company.name}‚Äù? Datele asociate vor fi eliminate.`)){
    return;
  }
  const password = prompt('Introdu parola pentru confirmarea »ôtergerii:');
  if(password === null){
    return;
  }
  if(password !== AUTH_PASSWORD){
    alert('Parola introdusƒÉ nu este corectƒÉ.');
    return;
  }
  state.companies = state.companies.filter(entry => entry.id !== company.id);
  if(state.companies.length === 0){
    const fallback = createEmptyCompany(state.nextCompanyId || 1, 'Companie implicitƒÉ');
    state.companies.push(fallback);
  }
  if(state.activeCompanyId === company.id){
    state.activeCompanyId = state.companies[0].id;
  }
  if(brandingModalCompanyId === company.id){
    closeBrandingModal();
  }
  activeAuthorizationDossierId = null;
  selectedWelder = null;
  selectedWelderPosition = null;
  archiveVisible = false;
  pansonArchiveVisible = false;
  persistState();
  populateCompanySelector();
  renderCompanySettings();
  updateHomeDashboard();
  resetWelderForm();
  closeWelderModal();
  loadWelders();
  populateAuthorizationWelderSelect();
  populateAuthorizationProcedureSelect();
  populateProcedureWelderSelect();
  populatePansonSelect();
  updateAuthorizationContext();
  loadPansoane();
  loadAuthorizations();
  loadProcedures();
  renderArchiveList();
  updateTopbarCompanyLogo();
  renderAuthStandardTabs();
  renderStandardManagerList();
  loadAuthorizationDossier();
  loadProcedureDossier();
  refreshBrandingEditors();
}

function renderBrandingEditorForCompany(container, company){
  if(!container){
    return;
  }
  if(!company){
    container.innerHTML = '<p class="muted">SelecteazƒÉ o companie activƒÉ pentru a personaliza rapoartele.</p>';
    return;
  }
  const branding = ensureReportBranding(company);
  container.innerHTML = '';
  ['header', 'footer'].forEach(section => {
    const sectionWrapper = document.createElement('div');
    sectionWrapper.className = 'branding-section';
    const title = document.createElement('h3');
    title.textContent = section === 'header' ? 'Antet PDF' : 'Footer PDF';
    sectionWrapper.appendChild(title);
    const hint = document.createElement('p');
    hint.className = 'muted';
    hint.textContent = section === 'header'
      ? 'Elementele de mai jos apar √Æn partea superioarƒÉ a fiecƒÉrei pagini.'
      : 'Elementele de mai jos apar √Æn partea inferioarƒÉ a fiecƒÉrei pagini.';
    sectionWrapper.appendChild(hint);
    const list = document.createElement('div');
    list.className = 'branding-list';
    const items = Array.isArray(branding[section]) ? branding[section] : [];
    if(items.length === 0){
      const empty = document.createElement('p');
      empty.className = 'muted';
      empty.textContent = 'Nu existƒÉ elemente definite.';
      list.appendChild(empty);
    } else {
      items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'branding-item';
        const meta = document.createElement('div');
        meta.className = 'meta';
        const label = document.createElement('span');
        label.className = 'label';
        label.textContent = item.type === 'image' ? 'Imagine' : 'Text';
        meta.appendChild(label);
        if(item.type === 'image' && item.data){
          const img = document.createElement('img');
          img.src = item.data;
          img.alt = item.name || 'Imagine branding';
          img.className = 'branding-preview';
          meta.appendChild(img);
        } else if(item.type === 'text'){
          const preview = document.createElement('div');
          preview.textContent = item.content;
          preview.style.fontSize = `${clampBrandingTextSize(item.size)}px`;
          meta.appendChild(preview);
        }
        const details = document.createElement('div');
        details.className = 'muted';
        const alignLabel = item.align === 'center'
          ? 'Centru'
          : item.align === 'right'
            ? 'Dreapta'
            : 'St√¢nga';
        const sizeLabel = item.type === 'text' ? ` ¬∑ ${clampBrandingTextSize(item.size)} pt` : '';
        const rowLabel = ` ¬∑ Linie: ${item.row && item.row > 0 ? item.row : 1}`;
        details.textContent = `Aliniere: ${alignLabel}${sizeLabel}${rowLabel}`;
        meta.appendChild(details);
        row.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'actions';
        if(item.type === 'text'){
          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'btn ghost small';
          editBtn.textContent = 'EditeazƒÉ text';
          editBtn.addEventListener('click', () => editBrandingText(section, item.id));
          actions.appendChild(editBtn);

          const sizeInput = document.createElement('input');
          sizeInput.type = 'number';
          sizeInput.min = '5';
          sizeInput.max = '28';
          sizeInput.value = clampBrandingTextSize(item.size);
          sizeInput.title = 'MƒÉrime text (pt)';
          sizeInput.addEventListener('change', () => updateBrandingTextSize(section, item.id, Number(sizeInput.value)));
          actions.appendChild(sizeInput);
        }

        const rowInput = document.createElement('input');
        rowInput.type = 'number';
        rowInput.min = '1';
        rowInput.value = item.row && item.row > 0 ? item.row : 1;
        rowInput.className = 'row-select';
        rowInput.title = 'Linia pe paginƒÉ';
        rowInput.addEventListener('change', () => updateBrandingRow(section, item.id, Number(rowInput.value)));
        actions.appendChild(rowInput);

        const alignSelect = document.createElement('select');
        [
          { value: 'left', label: 'St√¢nga' },
          { value: 'center', label: 'Centru' },
          { value: 'right', label: 'Dreapta' },
        ].forEach(optionData => {
          const option = document.createElement('option');
          option.value = optionData.value;
          option.textContent = optionData.label;
          alignSelect.appendChild(option);
        });
        alignSelect.value = item.align === 'center' || item.align === 'right' ? item.align : 'left';
        alignSelect.addEventListener('change', () => updateBrandingAlign(section, item.id, alignSelect.value));
        actions.appendChild(alignSelect);

        if(item.type === 'image'){
          const replaceInput = document.createElement('input');
          replaceInput.type = 'file';
          replaceInput.accept = 'image/*';
          replaceInput.style.display = 'none';
          replaceInput.addEventListener('change', event => {
            const file = event.target.files && event.target.files[0];
            if(file){
              replaceBrandingImage(section, item.id, file);
            }
          });
          const replaceBtn = document.createElement('button');
          replaceBtn.type = 'button';
          replaceBtn.className = 'btn ghost small';
          replaceBtn.textContent = '√énlocuie»ôte imagine';
          replaceBtn.addEventListener('click', () => replaceInput.click());
          actions.appendChild(replaceBtn);
          actions.appendChild(replaceInput);
        }

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'btn ghost small';
        deleteBtn.textContent = '»òterge';
        deleteBtn.addEventListener('click', () => deleteBrandingItem(section, item.id));
        actions.appendChild(deleteBtn);

        row.appendChild(actions);
        list.appendChild(row);
      });
    }
    sectionWrapper.appendChild(list);

    const controls = document.createElement('div');
    controls.className = 'branding-controls';
    const addTextBtn = document.createElement('button');
    addTextBtn.type = 'button';
    addTextBtn.className = 'btn secondary';
    addTextBtn.textContent = 'AdaugƒÉ text';
    addTextBtn.addEventListener('click', () => addBrandingText(section));
    controls.appendChild(addTextBtn);

    const addImageInput = document.createElement('input');
    addImageInput.type = 'file';
    addImageInput.accept = 'image/*';
    addImageInput.style.display = 'none';
    addImageInput.addEventListener('change', event => {
      const file = event.target.files && event.target.files[0];
      if(file){
        handleBrandingImageUpload(section, file);
      }
    });
    const addImageBtn = document.createElement('button');
    addImageBtn.type = 'button';
    addImageBtn.className = 'btn ghost';
    addImageBtn.textContent = 'AdaugƒÉ imagine';
    addImageBtn.addEventListener('click', () => addImageInput.click());
    controls.appendChild(addImageBtn);
    controls.appendChild(addImageInput);

    sectionWrapper.appendChild(controls);
    container.appendChild(sectionWrapper);
  });

  const spacingControl = document.createElement('div');
  spacingControl.className = 'branding-spacing-control';
  const spacingInput = document.createElement('input');
  spacingInput.type = 'number';
  spacingInput.min = '0';
  spacingInput.max = '120';
  spacingInput.value = getCompanyBrandingSpacing(company);
  spacingInput.id = `branding_spacing_${company.id}`;
  spacingInput.addEventListener('change', () => {
    const applied = updateCompanyBrandingSpacing(company.id, Number(spacingInput.value));
    spacingInput.value = applied;
  });
  const spacingLabel = document.createElement('label');
  spacingLabel.setAttribute('for', spacingInput.id);
  spacingLabel.textContent = 'Spa»õiere √Æntre elemente (px):';
  const spacingHint = document.createElement('span');
  spacingHint.textContent = 'AjusteazƒÉ distan»õa pentru a pƒÉstra toate elementele pe aceea»ôi linie.';
  spacingControl.appendChild(spacingLabel);
  spacingControl.appendChild(spacingInput);
  spacingControl.appendChild(spacingHint);
  container.appendChild(spacingControl);
}

function openBrandingModal(companyId){
  const modal = document.getElementById('branding_modal');
  const content = document.getElementById('branding_modal_content');
  if(!modal || !content){
    return;
  }
  const company = getCompanyById(companyId);
  if(!company){
    alert('Compania nu a fost gƒÉsitƒÉ.');
    return;
  }
  brandingModalCompanyId = company.id;
  const title = document.getElementById('branding_modal_title');
  if(title){
    title.textContent = `SetƒÉri antet & subsol ‚Äì ${company.name || 'Companie'}`;
  }
  renderBrandingEditorForCompany(content, company);
  modal.classList.add('open');
  modal.setAttribute('aria-hidden', 'false');
  document.body.dataset.brandingModalOpen = 'true';
  document.body.style.overflow = 'hidden';
}

function closeBrandingModal(){
  const modal = document.getElementById('branding_modal');
  if(!modal){
    return;
  }
  modal.classList.remove('open');
  modal.setAttribute('aria-hidden', 'true');
  delete document.body.dataset.brandingModalOpen;
  if(!document.body.dataset.welderModalOpen && !document.body.dataset.viewerOpen){
    document.body.style.overflow = '';
  }
  brandingModalCompanyId = null;
}

function renderReportBrandingEditor(){
  const container = document.getElementById('report_branding_editor');
  const company = getActiveCompany();
  renderBrandingEditorForCompany(container, company);
}

function refreshBrandingEditors(){
  renderReportBrandingEditor();
  if(brandingModalCompanyId){
    const modalContent = document.getElementById('branding_modal_content');
    const title = document.getElementById('branding_modal_title');
    const targetCompany = getCompanyById(brandingModalCompanyId);
    if(!targetCompany){
      closeBrandingModal();
      return;
    }
    if(title){
      title.textContent = `SetƒÉri antet & subsol ‚Äì ${targetCompany.name || 'Companie'}`;
    }
    if(modalContent){
      renderBrandingEditorForCompany(modalContent, targetCompany);
    }
  }
}

function findBrandingItem(section, itemId){
  const company = getActiveCompany();
  const branding = ensureReportBranding(company);
  const items = Array.isArray(branding[section]) ? branding[section] : [];
  const index = items.findIndex(item => item && item.id === itemId);
  return { items, index };
}

function addBrandingText(section){
  const contentPrompt = prompt('Introdu textul care va fi afi»ôat √Æn raport:');
  if(contentPrompt === null){
    return;
  }
  const content = contentPrompt.trim();
  if(!content){
    alert('Textul nu poate fi gol.');
    return;
  }
  const align = prompt('Aliniere (st√¢nga / centru / dreapta):', 'centru');
  const normalizedAlign = align && align.toLowerCase().includes('dreap')
    ? 'right'
    : (align && align.toLowerCase().includes('st') ? 'left' : 'center');
  const sizePrompt = prompt('MƒÉrime text (puncte, 5-28):', '11');
  const size = clampBrandingTextSize(sizePrompt);
  const company = getActiveCompany();
  const branding = ensureReportBranding(company);
  branding[section].push({
    id: generateDocumentId('branding'),
    type: 'text',
    content,
    align: normalizedAlign,
    size,
  });
  persistState();
  refreshBrandingEditors();
}

async function handleBrandingImageUpload(section, file){
  if(!file){
    return;
  }
  if(file.type && !file.type.startsWith('image/')){
    alert('Se pot √ÆncƒÉrca doar fi»ôiere imagine.');
    return;
  }
  try {
    const dataUrl = await readFileAsDataURL(file);
    const company = getActiveCompany();
    const branding = ensureReportBranding(company);
    branding[section].push({
      id: generateDocumentId('branding'),
      type: 'image',
      name: file.name || 'imagine.png',
      data: dataUrl,
      mime: file.type || 'image/png',
      align: 'center',
    });
    persistState();
    refreshBrandingEditors();
  } catch (err) {
    console.error('Nu s-a putut √ÆncƒÉrca imaginea pentru branding.', err);
    alert('√éncƒÉrcarea imaginii a e»ôuat. √éncearcƒÉ din nou.');
  }
}

function updateBrandingRow(section, itemId, row){
  const { items, index } = findBrandingItem(section, itemId);
  if(index === -1){
    return;
  }
  const numeric = Number(row);
  items[index].row = Number.isInteger(numeric) && numeric > 0 ? numeric : 1;
  persistState();
  refreshBrandingEditors();
}

function updateBrandingAlign(section, itemId, align){
  const { items, index } = findBrandingItem(section, itemId);
  if(index === -1){
    return;
  }
  const normalized = align === 'center' || align === 'right' ? align : 'left';
  items[index].align = normalized;
  persistState();
  refreshBrandingEditors();
}

function updateBrandingTextSize(section, itemId, size){
  const { items, index } = findBrandingItem(section, itemId);
  if(index === -1){
    return;
  }
  const item = items[index];
  if(item.type !== 'text'){
    return;
  }
  const clamped = clampBrandingTextSize(size);
  item.size = clamped;
  persistState();
  refreshBrandingEditors();
}

function editBrandingText(section, itemId){
  const { items, index } = findBrandingItem(section, itemId);
  if(index === -1){
    return;
  }
  const item = items[index];
  if(item.type !== 'text'){
    return;
  }
  const promptValue = prompt('ActualizeazƒÉ con»õinutul textului:', item.content || '');
  if(promptValue === null){
    return;
  }
  const content = promptValue.trim();
  if(!content){
    alert('Textul nu poate fi gol.');
    return;
  }
  item.content = content;
  persistState();
  refreshBrandingEditors();
}

async function replaceBrandingImage(section, itemId, file){
  if(!file){
    return;
  }
  if(file.type && !file.type.startsWith('image/')){
    alert('Se pot √ÆncƒÉrca doar fi»ôiere imagine.');
    return;
  }
  const { items, index } = findBrandingItem(section, itemId);
  if(index === -1){
    return;
  }
  try {
    const dataUrl = await readFileAsDataURL(file);
    items[index].data = dataUrl;
    items[index].name = file.name || items[index].name || 'imagine.png';
    items[index].mime = file.type || 'image/png';
    persistState();
    refreshBrandingEditors();
  } catch (err) {
    console.error('Nu s-a putut √Ænlocui imaginea.', err);
    alert('√énlocuirea imaginii a e»ôuat. √éncearcƒÉ din nou.');
  }
}

function deleteBrandingItem(section, itemId){
  const company = getActiveCompany();
  const branding = ensureReportBranding(company);
  branding[section] = (Array.isArray(branding[section]) ? branding[section] : []).filter(item => item && item.id !== itemId);
  persistState();
  refreshBrandingEditors();
}

async function handleCompanyLogoChange(companyId, file){
  const company = getCompanyById(companyId);
  if(!company || !file){
    return;
  }
  const extension = file.name ? file.name.toLowerCase() : '';
  const matchesExtension = extension.endsWith('.png') || extension.endsWith('.jpg') || extension.endsWith('.jpeg') || extension.endsWith('.gif') || extension.endsWith('.webp');
  const isImage = file.type ? file.type.startsWith('image/') : matchesExtension;
  if(!isImage){
    alert('Fi»ôierul logo trebuie sƒÉ fie o imagine.');
    return;
  }
  try {
    const dataUrl = await readFileAsDataURL(file);
    company.logo = {
      name: file.name || 'logo.png',
      data: dataUrl,
      type: file.type || 'image/png',
    };
    persistState();
    renderCompanySettings();
    updateTopbarCompanyLogo();
  } catch (err) {
    console.error('Nu s-a putut citi fi»ôierul de logo.', err);
    alert('Nu s-a putut √ÆncƒÉrca fi»ôierul. √éncearcƒÉ din nou.');
  }
}

function removeCompanyLogo(companyId){
  const company = getCompanyById(companyId);
  if(!company || !company.logo){
    return;
  }
  company.logo = null;
  persistState();
  renderCompanySettings();
  updateTopbarCompanyLogo();
}

function ensureReportBranding(company){
  if(!company.reportBranding || typeof company.reportBranding !== 'object'){
    company.reportBranding = { header: [], footer: [] };
  }
  ['header', 'footer'].forEach(section => {
    if(!Array.isArray(company.reportBranding[section])){
      company.reportBranding[section] = [];
    }
  });
  if(typeof company.reportBrandingSpacing !== 'number'){
    company.reportBrandingSpacing = 16;
  } else {
    company.reportBrandingSpacing = clampBrandingSpacing(company.reportBrandingSpacing);
  }
  return company.reportBranding;
}

function getCompanyBrandingSpacing(company){
  if(!company){
    return 16;
  }
  company.reportBrandingSpacing = clampBrandingSpacing(company.reportBrandingSpacing);
  return company.reportBrandingSpacing;
}

function updateCompanyBrandingSpacing(companyId, value){
  const company = getCompanyById(companyId);
  if(!company){
    return 16;
  }
  const applied = clampBrandingSpacing(value);
  if(company.reportBrandingSpacing !== applied){
    company.reportBrandingSpacing = applied;
    persistState();
    refreshBrandingEditors();
  }
  return applied;
}

function generatePdfReport(type){
  const company = getActiveCompany();
  if(!company){
    alert('SelecteazƒÉ o companie activƒÉ.');
    return;
  }
  const titleMap = {
    welders: 'Raport sudori',
    authorizations: 'Raport autoriza»õii',
    procedures: 'Raport omologƒÉri',
  };
  const heading = `${titleMap[type] || 'Raport'} ‚Äì ${company.name || ''}`;
  const generatedAt = `Generat la: ${new Date().toLocaleString('ro-RO')}`;
  const rows = [];
  let headers = [];
  if(type === 'welders'){
    headers = ['Sudor', 'Cod', 'Telefon', 'Angajare'];
    (company.welders || []).forEach(w => {
      rows.push([
        w.name || '',
        w.code || '',
        w.phone || '',
        w.hire_date || '',
      ]);
    });
  } else if(type === 'authorizations'){
    headers = ['Sudor', 'Standard', 'Proces', 'Pozi»õie', 'Certificat', 'ExpirƒÉ'];
    (company.qualifications || []).filter(q => q && q.category === 'autorizatii').forEach(q => {
      rows.push([
        findWelderNameById(q.welder_id) || '',
        getStandardLabel(q.standard),
        q.process || '',
        q.position || '',
        q.certificate_no || '',
        q.expiry_date || '',
      ]);
    });
  } else if(type === 'procedures'){
    headers = ['Sudor', 'Standard', 'Procedeu', 'Pozi»õie', 'Certificat'];
    (company.qualifications || []).filter(q => q && q.category === 'procedee').forEach(q => {
      rows.push([
        findWelderNameById(q.welder_id) || 'general',
        getStandardLabel(q.standard),
        q.process || '',
        q.position || '',
        q.certificate_no || '',
      ]);
    });
  }
  if(rows.length === 0){
    headers = headers.length ? headers : ['Informa»õii'];
    rows.push(['Nu existƒÉ date pentru raport.']);
  }
  const tableHeader = `<tr>${headers.map(header => `<th>${escapeHtml(header)}</th>`).join('')}</tr>`;
  const tableBody = rows.map(row => `<tr>${row.map(cell => `<td>${escapeHtml(cell || '')}</td>`).join('')}</tr>`).join('');
  const content = `
    <table class="print-table">
      <thead>${tableHeader}</thead>
      <tbody>${tableBody}</tbody>
    </table>
  `;
  const page = renderPrintPage({
    company,
    orientation: type === 'welders' ? 'portrait' : 'landscape',
    heading: escapeHtml(heading),
    subheading: escapeHtml(generatedAt),
    content,
  });
  openPrintPreview({
    title: heading,
    pages: [page],
  });
}

function setActiveCompany(id){
  const company = getCompanyById(id);
  if(!company){
    return;
  }
  if(state.activeCompanyId === company.id){
    return;
  }
  state.activeCompanyId = company.id;
  selectedWelder = null;
  selectedWelderPosition = null;
  archiveVisible = false;
  persistState();
  populateCompanySelector();
  renderCompanySettings();
  updateHomeDashboard();
  resetWelderForm();
  closeWelderModal();
  loadWelders();
  populateAuthorizationWelderSelect();
  populateAuthorizationProcedureSelect();
  populateProcedureWelderSelect();
  populatePansonSelect();
  updateAuthorizationContext();
  loadPansoane();
  loadAuthorizations();
  loadProcedures();
  renderArchiveList();
  updateTopbarCompanyLogo();
  renderAuthStandardTabs();
  renderStandardManagerList();
  loadAuthorizationDossier();
  loadProcedureDossier();
}

function handleAddCompany(){
  const name = prompt('Introdu numele noii companii:');
  if(name === null){
    return;
  }
  const trimmed = name.trim();
  if(!trimmed){
    alert('Numele companiei este obligatoriu.');
    return;
  }
  const newId = state.nextCompanyId++;
  const newCompany = createEmptyCompany(newId, trimmed);
  state.companies.push(newCompany);
  state.activeCompanyId = newCompany.id;
  selectedWelder = null;
  selectedWelderPosition = null;
  archiveVisible = false;
  persistState();
  populateCompanySelector();
  renderCompanySettings();
  updateHomeDashboard();
  resetWelderForm();
  closeWelderModal();
  loadWelders();
  populateAuthorizationWelderSelect();
  populateAuthorizationProcedureSelect();
  populateProcedureWelderSelect();
  populatePansonSelect();
  updateAuthorizationContext();
  loadPansoane();
  loadAuthorizations();
  loadProcedures();
  renderArchiveList();
  updateTopbarCompanyLogo();
  renderAuthStandardTabs();
  renderStandardManagerList();
  loadAuthorizationDossier();
  loadProcedureDossier();
}

function updateHomeDashboard(){
  const totalWeldersEl = document.getElementById('home_total_welders');
  const totalAuthEl = document.getElementById('home_total_authorizations');
  const totalProcEl = document.getElementById('home_total_procedures');
  const expiringSoonEl = document.getElementById('home_expiring_soon');
  const expiredEl = document.getElementById('home_expired');
  const tableBody = document.getElementById('home_expiring_table');
  const emptyMessage = document.getElementById('home_no_expiring');
  const companyTable = document.getElementById('home_company_table');
  const companyEmptyMessage = document.getElementById('home_companies_empty');
  if(!totalWeldersEl || !totalAuthEl || !totalProcEl || !expiringSoonEl || !expiredEl || !tableBody || !emptyMessage || !companyTable || !companyEmptyMessage){
    return;
  }
  let totalWelders = 0;
  let totalAuthorizations = 0;
  let totalProcedures = 0;
  let expiringSoon = 0;
  let expired = 0;
  const upcoming = [];
  const companyRows = [];
  const today = new Date();
  today.setHours(0,0,0,0);

  if(state && Array.isArray(state.companies)){
    state.companies.forEach(company => {
      if(!company){
        return;
      }
      const welderCount = Array.isArray(company.welders) ? company.welders.length : 0;
      totalWelders += welderCount;
      const qualifications = Array.isArray(company.qualifications) ? company.qualifications : [];
      let companyExpiring = 0;
      let companyExpired = 0;
      let companyAuthCount = 0;
      let companyProcCount = 0;
      qualifications.forEach(q => {
        if(!q){
          return;
        }
        if(q.category === 'procedee'){
          companyProcCount += 1;
          totalProcedures += 1;
          return;
        }
        if(q.category !== 'autorizatii'){
          return;
        }
        companyAuthCount += 1;
        totalAuthorizations += 1;
        if(!q.expiry_date){
          return;
        }
        const expiry = new Date(q.expiry_date);
        if(Number.isNaN(expiry.getTime())){
          return;
        }
        expiry.setHours(0,0,0,0);
        const diffDays = Math.ceil((expiry - today) / (1000*60*60*24));
        if(diffDays < 0){
          expired += 1;
          companyExpired += 1;
        } else if(diffDays <= 30){
          expiringSoon += 1;
          companyExpiring += 1;
        }
        if(diffDays >= 0 && diffDays <= 60){
          const welderName = company.welders.find(w => w.id === q.welder_id)?.name || findWelderNameById(q.welder_id) || '';
          upcoming.push({
            companyName: company.name || `Companie ${company.id}`,
            welderName: welderName || '‚Äî',
            standard: q.standard,
            process: q.process,
            position: q.position,
            expiry: expiry.toISOString().slice(0, 10),
          });
        }
      });
      companyRows.push({
        id: company.id,
        name: company.name || `Companie ${company.id}`,
        welderCount,
        authCount: companyAuthCount,
        procedureCount: companyProcCount,
        expiring: companyExpiring,
        expired: companyExpired,
      });
    });
  }

  totalWeldersEl.textContent = totalWelders;
  totalAuthEl.textContent = totalAuthorizations;
  totalProcEl.textContent = totalProcedures;
  expiringSoonEl.textContent = expiringSoon;
  expiredEl.textContent = expired;

  companyTable.innerHTML = '';
  if(companyRows.length === 0){
    companyEmptyMessage.classList.remove('hidden');
  } else {
    companyEmptyMessage.classList.add('hidden');
    companyRows.sort((a, b) => a.name.localeCompare(b.name, 'ro', { sensitivity: 'base' }));
    companyRows.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(row.name)}</td>
        <td>${escapeHtml(row.welderCount)}</td>
        <td>${escapeHtml(row.authCount)}</td>
        <td>${escapeHtml(row.procedureCount)}</td>
        <td>${escapeHtml(row.expiring)}</td>
        <td>${escapeHtml(row.expired)}</td>
      `;
      companyTable.appendChild(tr);
    });
  }

  tableBody.innerHTML = '';
  if(upcoming.length === 0){
    emptyMessage.classList.remove('hidden');
  } else {
    emptyMessage.classList.add('hidden');
    upcoming.sort((a, b) => a.expiry.localeCompare(b.expiry));
    upcoming.slice(0, 8).forEach(entry => {
      const tr = document.createElement('tr');
      const standardLabel = getStandardLabel(entry.standard);
      const processParts = [];
      if(entry.process){
        processParts.push(entry.process);
      }
      if(entry.position){
        processParts.push(entry.position);
      }
      const processDisplay = processParts.length ? processParts.join(' / ') : '‚Äî';
      tr.innerHTML = `
        <td>${escapeHtml(entry.companyName)}</td>
        <td>${escapeHtml(entry.welderName)}</td>
        <td>${escapeHtml(standardLabel)}</td>
        <td>${escapeHtml(processDisplay)}</td>
        <td>${escapeHtml(entry.expiry)}</td>
      `;
      tableBody.appendChild(tr);
    });
  }
}

let activeWeldersSubview = 'menu';
let activeView = 'home';

function openWelderModal(mode){
  const modal = document.getElementById('welder_modal');
  if(!modal){
    return;
  }
  welderModalMode = mode === 'edit' ? 'edit' : 'create';
  modal.dataset.mode = welderModalMode;
  const title = document.getElementById('welder_modal_title');
  if(title){
    title.textContent = welderModalMode === 'edit' ? 'EditeazƒÉ sudor' : 'Sudor nou';
  }
  const saveButton = document.getElementById('btn_save_welder');
  if(saveButton){
    saveButton.textContent = 'SalveazƒÉ';
  }
  modal.classList.add('open');
  modal.setAttribute('aria-hidden', 'false');
  document.body.dataset.welderModalOpen = 'true';
  document.body.style.overflow = 'hidden';
  const focusTarget = document.getElementById('w_name');
  if(focusTarget && typeof focusTarget.focus === 'function'){
    setTimeout(() => {
      try {
        focusTarget.focus();
      } catch (err) {
        console.warn('Nu s-a putut focaliza c√¢mpul de nume al sudorului.', err);
      }
    }, 0);
  }
}

function closeWelderModal(){
  const modal = document.getElementById('welder_modal');
  if(!modal){
    return;
  }
  modal.classList.remove('open');
  modal.setAttribute('aria-hidden', 'true');
  if(document.body.dataset.welderModalOpen){
    delete document.body.dataset.welderModalOpen;
  }
  if(!document.body.dataset.viewerOpen && !document.body.dataset.brandingModalOpen){
    document.body.style.overflow = '';
  }
}

function setWeldersSubview(mode){
  const valid = ['menu', 'welders', 'pansoane'];
  const target = valid.includes(mode) ? mode : 'menu';
  activeWeldersSubview = target;
  const menu = document.getElementById('welders_menu');
  const welders = document.getElementById('welders_overview');
  const pansoane = document.getElementById('pansoane_overview');
  if(menu){
    menu.classList.toggle('hidden', target !== 'menu');
  }
  if(welders){
    welders.classList.toggle('hidden', target !== 'welders');
  }
  if(pansoane){
    pansoane.classList.toggle('hidden', target !== 'pansoane');
  }
  if(target !== 'welders'){
    closeWelderModal();
  }
  if(target === 'welders'){
    loadWelders();
    renderArchiveList();
  }
  if(target === 'pansoane'){
    loadPansoane();
  }
}

function setActiveView(view, options){
  activeView = view;
  if(view !== 'welders'){
    closeWelderModal();
  }
  const targetId = `view_${view}`;
  document.querySelectorAll('.view').forEach(section => {
    const isActive = section.id === targetId;
    section.classList.toggle('active', isActive);
  });
  document.querySelectorAll('.nav-button').forEach(button => {
    const target = button.getAttribute('data-view');
    button.classList.toggle('active', target === view);
  });
  if(view === 'home'){
    updateHomeDashboard();
  }
  if(view === 'authorizations'){
    if(options && options.group){
      setActiveAuthGroup(options.group);
    } else {
      setActiveAuthGroup(activeAuthGroup);
    }
    populateAuthorizationWelderSelect();
    populateAuthorizationProcedureSelect();
    populateProcedureWelderSelect();
    updateAuthorizationContext();
    loadAuthorizations();
    loadAuthorizationDossier();
  }
  if(view === 'procedures'){
    populateProcedureWelderSelect();
    loadProcedures();
    loadProcedureDossier();
  }
  if(view === 'welders'){
    const subview = options && options.subview ? options.subview : (activeWeldersSubview || 'menu');
    setWeldersSubview(subview);
  }
  if(view === 'settings'){
    renderCompanySettings();
  }
}

function loadWelders(){
  const tbody = document.getElementById('welders_tbody');
  if(!tbody){
    return;
  }
  if(activeWeldersSubview !== 'welders'){
    return;
  }
  const company = getActiveCompany();
  if(selectedWelder && !company.welders.some(w => w.id === selectedWelder.id)){
    selectedWelder = null;
    selectedWelderPosition = null;
  }
  tbody.innerHTML = '';
  const ordered = sortWelders(company.welders);
  const search = welderSearchTerm.trim().toLowerCase();
  const filtered = ordered.filter(function(w){
    if(!search){
      return true;
    }
    const code = w && w.code !== undefined && w.code !== null ? String(w.code) : '';
    const haystack = `${w && w.name ? w.name : ''} ${code}`.toLowerCase();
    return haystack.includes(search);
  });

  const countLabel = document.getElementById('welder_count');
  if(countLabel){
    countLabel.textContent = filtered.length;
  }

  filtered.forEach(w => {
    const position = ordered.findIndex(item => item.id === w.id) + 1;
    const tr = document.createElement('tr');
    tr.dataset.id = String(w.id);
    tr.dataset.position = String(position);
    if(selectedWelder && selectedWelder.id === w.id){
      tr.classList.add('selected');
    }
    const pansonCode = (w && w.panson_id ? getPansonCodeById(w.panson_id) : null) || (w && w.code !== undefined && w.code !== null ? String(w.code) : '');
    const pansonDisplay = pansonCode ? escapeHtml(pansonCode) : '<span class="muted">‚Äî</span>';
    const safeName = escapeHtml(w && w.name ? w.name : '');
    const summaries = buildWelderQualificationSummaries(w && w.id ? w.id : null, company);
    const nameLabel = safeName || '‚Äî';
    tr.innerHTML = `
      <td>${pansonDisplay}</td>
      <td><a href="#" data-id="${w.id}" class="welder-name-link">${nameLabel}</a></td>
      <td><div class="qualifications-summary">${summaries.statusHtml}</div></td>
      <td><div class="process-summary">${summaries.processHtml}</div></td>
      <td><button type="button" class="icon-button delete-welder" data-id="${w.id}" title="ArhiveazƒÉ ${nameLabel}" aria-label="ArhiveazƒÉ ${nameLabel}">üóëÔ∏è</button></td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('.welder-name-link').forEach(link => {
    link.addEventListener('click', event => {
      event.preventDefault();
      const id = Number(link.getAttribute('data-id'));
      if(Number.isNaN(id)){
        return;
      }
      const row = link.closest('tr');
      if(row){
        const position = Number(row.getAttribute('data-position'));
        if(!Number.isNaN(position)){
          selectedWelderPosition = position;
        }
      }
      selectWelder(id);
    });
  });

  tbody.querySelectorAll('.delete-welder').forEach(button => {
    button.addEventListener('click', event => {
      event.preventDefault();
      event.stopPropagation();
      const id = Number(button.getAttribute('data-id'));
      if(Number.isNaN(id)){
        return;
      }
      const welder = company.welders.find(w => w.id === id);
      const displayName = welder && welder.name ? welder.name : 'acest sudor';
      if(!confirm(`Sudorul ${displayName} va fi mutat √Æn arhivƒÉ. Continui?`)){
        return;
      }
      const reasonInput = prompt(`Introduce motivul arhivƒÉrii pentru ${displayName}.`);
      if(reasonInput === null){
        return;
      }
      const reason = reasonInput.trim();
      if(!reason){
        alert('Motivul arhivƒÉrii este obligatoriu.');
        return;
      }
      archiveWelder(id, reason);
    });
  });

  if(selectedWelder){
    const updated = company.welders.find(w => w.id === selectedWelder.id);
    if(updated){
      selectedWelder = updated;
      fillWelderForm(updated);
      selectedWelderPosition = getWelderPosition(updated.id);
      updateAuthorizationContext();
    } else {
      resetWelderForm();
    }
  }
  populateAuthorizationWelderSelect();
  populateAuthorizationProcedureSelect();
  populateProcedureWelderSelect();
  populatePansonSelect();
  updateAuthorizationContext();
}

function archiveWelder(id, reason){
  const company = getActiveCompany();
  const index = company.welders.findIndex(w => w.id === id);
  if(index === -1){
    return;
  }
  const welder = company.welders[index];
  const relatedQualifications = company.qualifications.filter(q => q.welder_id === id);
  company.welders.splice(index, 1);
  company.qualifications = company.qualifications.filter(q => q.welder_id !== id);
  company.archivedWelders.push({
    welder: { ...welder },
    archived_at: new Date().toISOString(),
    qualifications: relatedQualifications,
    reason: reason || '',
  });
  persistState();
  renderCompanySettings();
  updateHomeDashboard();
  if(selectedWelder && selectedWelder.id === id){
    resetWelderForm();
    closeWelderModal();
  }
  populateAuthorizationWelderSelect();
  populateAuthorizationProcedureSelect();
  populateProcedureWelderSelect();
  populatePansonSelect();
  updateAuthorizationContext();
  loadAuthorizations();
  loadProcedures();
  loadWelders();
  renderArchiveList();
}

function restoreArchivedWelder(id, fallbackIndex){
  const company = getActiveCompany();
  let index = company.archivedWelders.findIndex(entry => entry && entry.welder && entry.welder.id === id);
  if(index === -1 && typeof fallbackIndex === 'number' && fallbackIndex >= 0 && fallbackIndex < company.archivedWelders.length){
    index = fallbackIndex;
  }
  if(index === -1){
    return;
  }
  const entry = company.archivedWelders[index];
  const welderSource = entry && entry.welder ? entry.welder : null;
  if(!welderSource){
    company.archivedWelders.splice(index, 1);
    persistState();
    renderArchiveList();
    return;
  }

  const archivedWelderId = Number(welderSource.id) || 0;
  let welderId = archivedWelderId;
  const idConflict = welderId > 0 && company.welders.some(w => w.id === welderId);
  if(welderId <= 0 || idConflict){
    welderId = company.nextWelderId++;
  } else if(welderId >= company.nextWelderId){
    company.nextWelderId = welderId + 1;
  }

  const restoredWelder = {
    id: welderId,
    name: welderSource && typeof welderSource.name === 'string' ? welderSource.name : '',
    code: welderSource && welderSource.code !== undefined && welderSource.code !== null ? welderSource.code : null,
    hire_date: welderSource && welderSource.hire_date ? welderSource.hire_date : null,
    phone: welderSource && welderSource.phone ? welderSource.phone : '',
    panson_id: welderSource && welderSource.panson_id ? welderSource.panson_id : null,
    photo: normalizeWelderAttachment(welderSource && welderSource.photo ? welderSource.photo : null, 'fotografie'),
    id_card: normalizeWelderAttachment(welderSource && welderSource.id_card ? welderSource.id_card : null, 'carte_identitate'),
    diploma: normalizeWelderAttachment(welderSource && welderSource.diploma ? welderSource.diploma : null, 'diploma'),
    contract: normalizeWelderAttachment(welderSource && welderSource.contract ? welderSource.contract : null, 'contract'),
    authorization_dossier: Array.isArray(welderSource && welderSource.authorization_dossier)
      ? welderSource.authorization_dossier.map(item => normalizeDossierItem(item, 'document_autorizare')).filter(Boolean)
      : [],
  };
  company.welders.push(restoredWelder);

  const existingQualificationIds = new Set(company.qualifications.map(q => q.id));
  const restoredQualifications = Array.isArray(entry.qualifications)
    ? entry.qualifications.map(q => ({ ...q }))
    : [];

  restoredQualifications.forEach(q => {
    const originalCategory = q && typeof q.category === 'string' ? q.category : DEFAULT_QUALIFICATION_CATEGORY;
    const category = QUALIFICATION_CATEGORIES.includes(originalCategory)
      ? originalCategory
      : DEFAULT_QUALIFICATION_CATEGORY;
    let qualificationId = Number(q && q.id) || 0;
    if(qualificationId <= 0 || existingQualificationIds.has(qualificationId)){
      qualificationId = company.nextQualificationId++;
    } else if(qualificationId >= company.nextQualificationId){
      company.nextQualificationId = qualificationId + 1;
    }
    existingQualificationIds.add(qualificationId);

    const originalWelderId = q && q.welder_id !== undefined && q.welder_id !== null
      ? Number(q.welder_id)
      : null;
    const targetWelderId = originalWelderId === archivedWelderId ? welderId : originalWelderId;

    const defaultStandard = category === 'procedee' ? DEFAULT_PROCEDURE_STANDARD : DEFAULT_AUTH_STANDARD;
    const standard = q && q.standard ? q.standard : defaultStandard;
    const attachment = category === 'autorizatii' && q && q.attachment
      ? normalizeAttachment(q.attachment, 'autorizatie.pdf')
      : null;
    company.qualifications.push({
      id: qualificationId,
      welder_id: targetWelderId,
      category,
      standard,
      process: q && q.process ? q.process : '',
      position: q && q.position ? q.position : '',
      p_number: q && q.p_number ? q.p_number : null,
      thickness_range: q && q.thickness_range ? q.thickness_range : null,
      product: q && q.product ? q.product : '',
      certificate_no: q && q.certificate_no ? q.certificate_no : null,
      issuer: q && q.issuer ? q.issuer : null,
      expiry_date: category === 'autorizatii' ? (q && q.expiry_date ? q.expiry_date : null) : null,
      attachment,
    });
  });

  company.archivedWelders.splice(index, 1);
  persistState();
  renderCompanySettings();
  updateHomeDashboard();
  syncStandardsFromState();
  renderAuthStandardTabs();
  renderStandardManagerList();
  populateAuthorizationWelderSelect();
  populateAuthorizationProcedureSelect();
  populateProcedureWelderSelect();
  populatePansonSelect();
  selectWelder(restoredWelder.id);
  renderArchiveList();
}

function fillWelderForm(w){
  const nameInput = document.getElementById('w_name');
  if(nameInput){
    nameInput.value = w && typeof w.name === 'string' ? w.name : '';
  }
  const phoneInput = document.getElementById('w_phone');
  if(phoneInput){
    phoneInput.value = w && typeof w.phone === 'string' ? w.phone : '';
  }
  const hireInput = document.getElementById('w_hire');
  if(hireInput){
    hireInput.value = w && w.hire_date ? w.hire_date : '';
  }
  populatePansonSelect();
  const pansonSelect = document.getElementById('w_panson');
  if(pansonSelect){
    const value = w && w.panson_id ? String(w.panson_id) : '';
    pansonSelect.value = Array.from(pansonSelect.options).some(opt => opt.value === value) ? value : '';
  }
  const manualInput = document.getElementById('w_code_manual');
  if(manualInput){
    manualInput.value = w && w.code !== undefined && w.code !== null ? w.code : '';
  }
  updateAttachmentPreview('w_photo_preview', w && w.photo ? w.photo : null, { label: 'DescarcƒÉ fotografie', fallbackName: 'foto' });
  updateAttachmentPreview('w_id_card_preview', w && w.id_card ? w.id_card : null, { label: 'Carte identitate', fallbackName: 'ci' });
  updateAttachmentPreview('w_diploma_preview', w && w.diploma ? w.diploma : null, { label: 'DiplomƒÉ', fallbackName: 'diploma' });
  updateAttachmentPreview('w_contract_preview', w && w.contract ? w.contract : null, { label: 'Contract', fallbackName: 'contract' });
  updateAttachmentPreview('w_aptitude_preview', w && w.aptitude ? w.aptitude : null, { label: 'Fi»ôƒÉ aptitudini', fallbackName: 'fisa_aptitudini' });
  updateAttachmentPreview('w_bundle_preview', w && w.bundle ? w.bundle : null, { label: 'Documente personale', fallbackName: 'documente_personale' });
  ['w_photo','w_id_card','w_diploma','w_contract','w_aptitude','w_bundle'].forEach(id => {
    const input = document.getElementById(id);
    if(input){
      input.value = '';
    }
  });
  loadAuthorizationDossier();
}

function resetWelderForm(){
  selectedWelder = null;
  selectedWelderPosition = null;
  const nameInput = document.getElementById('w_name');
  if(nameInput){
    nameInput.value = '';
  }
  const phoneInput = document.getElementById('w_phone');
  if(phoneInput){
    phoneInput.value = '';
  }
  const hireInput = document.getElementById('w_hire');
  if(hireInput){
    hireInput.value = '';
  }
  const manualInput = document.getElementById('w_code_manual');
  if(manualInput){
    manualInput.value = '';
  }
  populatePansonSelect();
  const pansonSelect = document.getElementById('w_panson');
  if(pansonSelect){
    pansonSelect.value = '';
  }
  ['w_photo_preview','w_id_card_preview','w_diploma_preview','w_contract_preview','w_aptitude_preview','w_bundle_preview'].forEach(id => {
    const container = document.getElementById(id);
    if(container){
      container.innerHTML = '';
    }
  });
  ['w_photo','w_id_card','w_diploma','w_contract','w_aptitude','w_bundle'].forEach(id => {
    const input = document.getElementById(id);
    if(input){
      input.value = '';
    }
  });
  updateAuthorizationContext();
  loadAuthorizationDossier();
}

function findDuplicateWelder(payload, excludeId){
  const targetParts = getNameParts(payload.name);
  const codeToCheck = payload.code ? String(payload.code).trim().toLowerCase() : '';
  if(!targetParts.full && !codeToCheck){
    return null;
  }
  const company = getActiveCompany();
  return company.welders.find(function(w){
    if(excludeId && w.id === excludeId){
      return false;
    }
    const existingParts = getNameParts(w && w.name ? w.name : '');
    const welderCode = w && w.code !== undefined && w.code !== null
      ? String(w.code).trim().toLowerCase()
      : '';
    const sameName = targetParts.full && existingParts.full
      ? targetParts.family === existingParts.family && targetParts.given === existingParts.given
      : false;
    if(sameName){
      return true;
    }
    if(codeToCheck && welderCode && welderCode === codeToCheck){
      return true;
    }
    return false;
  }) || null;
}

async function saveWelder(){
  const nameInput = document.getElementById('w_name');
  const phoneInput = document.getElementById('w_phone');
  const hireInput = document.getElementById('w_hire');
  const pansonSelect = document.getElementById('w_panson');
  const manualCodeInput = document.getElementById('w_code_manual');
  const name = normalizeNameInput(nameInput ? nameInput.value : '');
  if(!name){
    alert('CompleteazƒÉ numele.');
    return;
  }
  const phone = phoneInput && phoneInput.value ? phoneInput.value.trim() : '';
  const hireDate = hireInput && hireInput.value ? hireInput.value : null;
  const company = getActiveCompany();

  let pansonId = null;
  let code = null;
  if(pansonSelect && pansonSelect.value){
    const numeric = Number(pansonSelect.value);
    if(!Number.isNaN(numeric)){
      const panson = company.pansoane.find(entry => entry && entry.id === numeric);
      if(panson){
        pansonId = panson.id;
        code = panson.code || null;
      }
    }
  }
  if(!code && manualCodeInput && manualCodeInput.value){
    const manual = manualCodeInput.value.trim();
    code = manual ? manual : null;
  }

  const payload = {
    name,
    code,
    phone,
    hire_date: hireDate,
    panson_id: pansonId,
  };

  const excludeId = selectedWelder ? selectedWelder.id : null;
  const duplicate = findDuplicateWelder(payload, excludeId);
  if(duplicate){
    alert('Sudorul existƒÉ deja √Æn listƒÉ. VerificƒÉ numele sau codul de identificare.');
    return;
  }

  const attachmentSources = {
    photo: selectedWelder && selectedWelder.photo ? { ...selectedWelder.photo } : null,
    id_card: selectedWelder && selectedWelder.id_card ? { ...selectedWelder.id_card } : null,
    diploma: selectedWelder && selectedWelder.diploma ? { ...selectedWelder.diploma } : null,
    contract: selectedWelder && selectedWelder.contract ? { ...selectedWelder.contract } : null,
    aptitude: selectedWelder && selectedWelder.aptitude ? { ...selectedWelder.aptitude } : null,
    bundle: selectedWelder && selectedWelder.bundle ? { ...selectedWelder.bundle } : null,
  };

  const fileDescriptors = [
    { id: 'w_photo', key: 'photo', label: 'fotografie' },
    { id: 'w_id_card', key: 'id_card', label: 'carte_identitate' },
    { id: 'w_diploma', key: 'diploma', label: 'diploma' },
    { id: 'w_contract', key: 'contract', label: 'contract' },
    { id: 'w_aptitude', key: 'aptitude', label: 'fisa_aptitudini' },
    { id: 'w_bundle', key: 'bundle', label: 'documente_personale' },
  ];

  for(const descriptor of fileDescriptors){
    const input = document.getElementById(descriptor.id);
    if(input && input.files && input.files[0]){
      const file = input.files[0];
      try {
        const dataUrl = await readFileAsDataURL(file);
        attachmentSources[descriptor.key] = {
          name: file.name || descriptor.label,
          data: dataUrl,
          type: file.type || '',
        };
      } catch (err) {
        console.error('Nu s-a putut citi fi»ôierul ata»ôat pentru', descriptor.key, err);
        alert('Nu s-a putut citi unul dintre fi»ôierele ata»ôate. √éncearcƒÉ din nou.');
        return;
      }
    }
  }

  if(selectedWelder){
    const idx = company.welders.findIndex(w => w.id === selectedWelder.id);
    if(idx !== -1){
      company.welders[idx] = {
        ...company.welders[idx],
        ...payload,
        photo: attachmentSources.photo,
        id_card: attachmentSources.id_card,
        diploma: attachmentSources.diploma,
        contract: attachmentSources.contract,
        aptitude: attachmentSources.aptitude,
        bundle: attachmentSources.bundle,
      };
    }
  } else {
    const newWelder = {
      id: company.nextWelderId++,
      ...payload,
      photo: attachmentSources.photo,
      id_card: attachmentSources.id_card,
      diploma: attachmentSources.diploma,
      contract: attachmentSources.contract,
      aptitude: attachmentSources.aptitude,
      bundle: attachmentSources.bundle,
      authorization_dossier: [],
    };
    company.welders.push(newWelder);
  }

  persistState();
  renderCompanySettings();
  updateHomeDashboard();
  populateAuthorizationWelderSelect();
  populateAuthorizationProcedureSelect();
  populateProcedureWelderSelect();
  loadWelders();
  closeWelderModal();
  selectedWelder = null;
  selectedWelderPosition = null;
  resetWelderForm();
  updateAuthorizationContext();
  loadAuthorizations();
  loadProcedures();
}

function collectAuthorizationPayload(){
  return {
    standard: document.getElementById('auth_standard').value,
    process: document.getElementById('auth_process').value,
    position: document.getElementById('auth_position').value,
    base_quality: document.getElementById('auth_base_quality').value.trim(),
    base_material: document.getElementById('auth_base_material').value.trim(),
    filler_material: document.getElementById('auth_filler_material').value.trim(),
    base_dimension: document.getElementById('auth_base_dimension').value.trim(),
    diameter: document.getElementById('auth_diameter').value.trim(),
    thickness_domain: document.getElementById('auth_thickness_domain').value.trim(),
    certificate_no: document.getElementById('auth_cert').value.trim() || null,
    issuer: document.getElementById('auth_issuer').value.trim() || null,
    expiry_date: document.getElementById('auth_expiry').value || null,
    observation: document.getElementById('auth_observation').value.trim(),
  };
}

function collectProcedurePayload(){
  return {
    standard: document.getElementById('proc_standard').value,
    process: document.getElementById('proc_process').value,
    position: document.getElementById('proc_position').value,
    p_number: document.getElementById('proc_pno').value.trim() || null,
    thickness_range: document.getElementById('proc_thk').value.trim() || null,
    product: document.getElementById('proc_product').value,
    certificate_no: document.getElementById('proc_cert').value.trim() || null,
    issuer: document.getElementById('proc_issuer').value.trim() || null,
  };
}

async function addAuthorization(){
  const company = getActiveCompany();
  const welderSelect = document.getElementById('auth_welder_select');
  const attachmentInput = document.getElementById('auth_attachment');
  const welderId = welderSelect && welderSelect.value ? Number(welderSelect.value) : NaN;
  if(Number.isNaN(welderId) || welderId <= 0){
    alert('SelecteazƒÉ un sudor pentru autoriza»õie.');
    return;
  }
  const welder = company.welders.find(w => w.id === welderId);
  if(!welder){
    alert('Sudorul selectat nu mai existƒÉ √Æn companie.');
    populateAuthorizationWelderSelect();
    populateAuthorizationProcedureSelect();
    return;
  }
  const payload = collectAuthorizationPayload();
  if(!payload.standard){
    alert('Alege standardul autoriza»õiei.');
    return;
  }
  const procedureSelect = document.getElementById('auth_procedure_select');
  const procedureIdValue = procedureSelect && procedureSelect.value ? Number(procedureSelect.value) : NaN;
  const procedureId = Number.isNaN(procedureIdValue) ? null : procedureIdValue;
  if(procedureSelect && procedureSelect.options.length <= 1){
    alert('AdaugƒÉ mai √Ænt√¢i un procedeu omologat pentru a putea √Ænregistra autoriza»õia.');
    return;
  }
  if(!procedureId){
    alert('SelecteazƒÉ procedeul omologat corespunzƒÉtor acestei autoriza»õii.');
    return;
  }
  let attachment = null;
  if(attachmentInput && attachmentInput.files && attachmentInput.files[0]){
    const file = attachmentInput.files[0];
    const isPdf = file.type ? file.type === 'application/pdf' : file.name.toLowerCase().endsWith('.pdf');
    if(!isPdf){
      alert('Fi»ôierul ata»ôat trebuie sƒÉ fie √Æn format PDF.');
      return;
    }
    try {
      const dataUrl = await readFileAsDataURL(file);
      attachment = {
        name: file.name || 'autorizatie.pdf',
        data: dataUrl,
        type: file.type || 'application/pdf',
      };
    } catch (err) {
      console.error('Nu s-a putut citi fi»ôierul PDF ata»ôat.', err);
      alert('Nu s-a putut citi fi»ôierul PDF ata»ôat. √éncearcƒÉ din nou.');
      return;
    }
  }

  const qualification = {
    id: company.nextQualificationId++,
    welder_id: welder.id,
    category: 'autorizatii',
    ...payload,
    procedure_id: procedureId,
    attachment,
  };
  company.qualifications.push(qualification);
  persistState();
  renderCompanySettings();
  updateHomeDashboard();
  if(attachmentInput){
    attachmentInput.value = '';
  }
  if(!selectedWelder || selectedWelder.id !== welder.id){
    selectWelder(welder.id);
  } else {
    loadAuthorizations();
    loadWelders();
  }
}

async function addProcedure(){
  const company = getActiveCompany();
  const payload = collectProcedurePayload();
  if(!payload.standard){
    alert('SelecteazƒÉ standardul procedurii.');
    return;
  }
  const welderSelect = document.getElementById('proc_welder_select');
  const welderIdValue = welderSelect && welderSelect.value ? Number(welderSelect.value) : NaN;
  const welderId = Number.isNaN(welderIdValue) || welderIdValue <= 0 ? null : welderIdValue;
  const attachmentInput = document.getElementById('proc_attachment');
  let attachment = null;
  if(attachmentInput && attachmentInput.files && attachmentInput.files[0]){
    const file = attachmentInput.files[0];
    const isPdf = file.type ? file.type === 'application/pdf' : file.name.toLowerCase().endsWith('.pdf');
    if(!isPdf){
      alert('Fi»ôierul procedurii trebuie sƒÉ fie √Æn format PDF.');
      return;
    }
    try {
      const dataUrl = await readFileAsDataURL(file);
      attachment = {
        name: file.name || 'procedeu.pdf',
        data: dataUrl,
        type: file.type || 'application/pdf',
      };
    } catch (err) {
      console.error('Nu s-a putut citi fi»ôierul de procedeu.', err);
      alert('√éncƒÉrcarea fi»ôierului de procedeu a e»ôuat.');
      return;
    }
  }
  const qualification = {
    id: company.nextQualificationId++,
    welder_id: welderId,
    category: 'procedee',
    ...payload,
    attachment,
    expiry_date: null,
  };
  company.qualifications.push(qualification);
  persistState();
  renderCompanySettings();
  updateHomeDashboard();
  loadProcedures();
  populateAuthorizationProcedureSelect();
  loadWelders();
  if(attachmentInput){
    attachmentInput.value = '';
  }
}

function removeQualification(id){
  const company = getActiveCompany();
  const idx = company.qualifications.findIndex(q => q.id === id);
  if(idx === -1) return;
  company.qualifications.splice(idx, 1);
  persistState();
  renderCompanySettings();
  updateHomeDashboard();
  loadAuthorizations();
  loadProcedures();
  populateAuthorizationProcedureSelect();
  loadWelders();
}
function loadAuthorizations(){
  const container = document.getElementById('auth_existing_tables');
  const emptyState = document.getElementById('auth_empty_state');
  const tabsContainer = document.getElementById('auth_existing_tabs');
  const hint = document.getElementById('auth_existing_hint');
  if(!container || !tabsContainer){
    return;
  }
  container.innerHTML = '';
  tabsContainer.innerHTML = '';
  const company = getActiveCompany();
  const authorizations = company.qualifications.filter(q => q && q.category === 'autorizatii');
  if(authorizations.length === 0){
    if(emptyState){
      emptyState.textContent = 'Nu existƒÉ autoriza»õii salvate.';
      emptyState.classList.remove('hidden');
    }
    if(hint){
      hint.textContent = 'nu existƒÉ autoriza»õii salvate';
    }
    tabsContainer.classList.add('hidden');
    return;
  }
  if(emptyState){
    emptyState.classList.add('hidden');
  }
  const groupsMap = new Map();
  authorizations.forEach(q => {
    const standardEntry = getStandardById(q.standard);
    const groupKey = standardEntry && standardEntry.group ? standardEntry.group : 'ALTE';
    if(!groupsMap.has(groupKey)){
      groupsMap.set(groupKey, []);
    }
    groupsMap.get(groupKey).push(q);
  });
  const orderedGroups = Array.from(groupsMap.keys()).sort((a, b) => a.localeCompare(b, 'ro', { sensitivity: 'base' }));
  if(!activeAuthorizationExistingGroup || !groupsMap.has(activeAuthorizationExistingGroup)){
    activeAuthorizationExistingGroup = orderedGroups[0];
  }
  tabsContainer.classList.toggle('hidden', orderedGroups.length <= 1);
  orderedGroups.forEach(group => {
    const button = document.createElement('button');
    button.type = 'button';
    button.textContent = `${group} (${groupsMap.get(group).length})`;
    button.dataset.group = group;
    const isActive = group === activeAuthorizationExistingGroup;
    button.classList.toggle('active', isActive);
    button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    button.addEventListener('click', () => {
      activeAuthorizationExistingGroup = group;
      loadAuthorizations();
    });
    tabsContainer.appendChild(button);
  });

  const activeList = groupsMap.get(activeAuthorizationExistingGroup) || [];
  activeList.sort((a, b) => {
    const welderA = findWelderNameById(a.welder_id) || '';
    const welderB = findWelderNameById(b.welder_id) || '';
    const compareNames = welderA.localeCompare(welderB, 'ro', { sensitivity: 'base' });
    if(compareNames !== 0){
      return compareNames;
    }
    const dateA = a && a.expiry_date ? a.expiry_date : '';
    const dateB = b && b.expiry_date ? b.expiry_date : '';
    return dateA.localeCompare(dateB);
  });

  const table = document.createElement('table');
  table.innerHTML = `
    <thead>
      <tr>
        <th>Nr. crt.</th>
        <th>Nume / panson</th>
        <th>Procedeu de sudare</th>
        <th>Calitate mat. de bazƒÉ</th>
        <th>Materiale de bazƒÉ</th>
        <th>Material de adaos</th>
        <th>Pozi»õie de sudare</th>
        <th>Dim. mat. de bazƒÉ</th>
        <th>Diametru / grosime</th>
        <th>Domeniu grosime</th>
        <th>Obs</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector('tbody');

  activeList.forEach((q, index) => {
    const tr = document.createElement('tr');
    const welderName = q.welder_id ? findWelderNameById(q.welder_id) : '';
    let pansonCode = '';
    if(q.welder_id){
      const welderRecord = company.welders.find(w => w.id === q.welder_id);
      if(welderRecord){
        pansonCode = welderRecord.code || getPansonCodeById(welderRecord.panson_id) || '';
      } else {
        const archivedRecord = company.archivedWelders.find(entry => entry && entry.welder && entry.welder.id === q.welder_id);
        if(archivedRecord && archivedRecord.welder){
          pansonCode = archivedRecord.welder.code || getPansonCodeById(archivedRecord.welder.panson_id) || '';
        }
      }
    }
    const nameHtml = welderName ? escapeHtml(welderName) : '<span class="muted">(fƒÉrƒÉ sudor)</span>';
    const pansonHtml = pansonCode ? `<div class="muted">${escapeHtml(pansonCode)}</div>` : '';
    const formatValue = value => value ? escapeHtml(value) : '<span class="muted">‚Äî</span>';
    const certificateLinks = q && q.attachment && q.attachment.data
      ? createAttachmentActionsHtml(q.attachment, { fallbackName: 'autorizatie.pdf' })
      : '';
    const procedureLabel = resolveProcedureLabel(company, q && q.procedure_id);
    const processParts = [];
    if(q && q.process){
      processParts.push(`<div>${escapeHtml(q.process)}</div>`);
    }
    if(procedureLabel){
      processParts.push(`<div class="muted">Procedeu: ${escapeHtml(procedureLabel)}</div>`);
    }
    const processCell = processParts.length ? processParts.join('') : '<span class="muted">‚Äî</span>';
    const observationParts = [];
    if(q && q.observation){
      observationParts.push(escapeHtml(q.observation));
    }
    if(q && q.expiry_date){
      const status = statusBadge(q.expiry_date);
      observationParts.push(`${status} <span class="muted">ExpirƒÉ: ${escapeHtml(q.expiry_date)}</span>`);
    }
    if(certificateLinks){
      observationParts.push(certificateLinks);
    }
    const observationCell = observationParts.length ? observationParts.join('<br>') : '<span class="muted">‚Äî</span>';
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${nameHtml}${pansonHtml}</td>
      <td>${processCell}</td>
      <td>${formatValue(q && q.base_quality)}</td>
      <td>${formatValue(q && q.base_material)}</td>
      <td>${formatValue(q && q.filler_material)}</td>
      <td>${formatValue(q && q.position)}</td>
      <td>${formatValue(q && q.base_dimension)}</td>
      <td>${formatValue(q && q.diameter)}</td>
      <td>${formatValue(q && q.thickness_domain)}</td>
      <td>${observationCell}</td>
      <td>
        <div class="attachment-actions">
          <button type="button" class="btn ghost small" data-action="renew" data-id="${q.id}">Reautorizare</button>
          <button type="button" class="btn ghost small" data-action="extend" data-id="${q.id}">Prelungire</button>
          <button type="button" class="btn ghost small" data-action="delete" data-id="${q.id}">»òterge</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('button[data-action="delete"]').forEach(button => {
    button.addEventListener('click', () => {
      const id = Number(button.getAttribute('data-id'));
      if(Number.isNaN(id)){
        return;
      }
      if(confirm('»òtergi aceastƒÉ autoriza»õie?')){
        removeQualification(id);
      }
    });
  });

  tbody.querySelectorAll('button[data-action="renew"]').forEach(button => {
    button.addEventListener('click', () => {
      const id = Number(button.getAttribute('data-id'));
      if(Number.isNaN(id)){
        return;
      }
      pushAuthorizationToDossier(id, 'autorizare');
    });
  });

  tbody.querySelectorAll('button[data-action="extend"]').forEach(button => {
    button.addEventListener('click', () => {
      const id = Number(button.getAttribute('data-id'));
      if(Number.isNaN(id)){
        return;
      }
      pushAuthorizationToDossier(id, 'prelungire');
    });
  });

  container.appendChild(table);
  if(hint){
    hint.textContent = `total autoriza»õii: ${authorizations.length}`;
  }
}

function loadProcedures(){
  const tbody = document.getElementById('procedures_tbody');
  const wrap = document.getElementById('procedures_list_wrap');
  const emptyState = document.getElementById('procedures_empty_state');
  if(!tbody){
    return;
  }
  tbody.innerHTML = '';
  const company = getActiveCompany();
  const list = company.qualifications.filter(q => q && q.category === 'procedee')
    .sort((a, b) => {
      const keyA = `${getStandardLabel(a.standard)} ${a.process || ''} ${a.certificate_no || ''}`;
      const keyB = `${getStandardLabel(b.standard)} ${b.process || ''} ${b.certificate_no || ''}`;
      return keyA.localeCompare(keyB, 'ro', { sensitivity: 'base' });
    });
  if(list.length === 0){
    if(wrap){
      wrap.classList.add('hidden');
    }
    if(emptyState){
      emptyState.classList.remove('hidden');
    }
    return;
  }
  if(wrap){
    wrap.classList.remove('hidden');
  }
  if(emptyState){
    emptyState.classList.add('hidden');
  }
  list.forEach(q => {
    const tr = document.createElement('tr');
    const standardLabel = getStandardLabel(q.standard);
    const ownerName = q && q.welder_id ? findWelderNameById(q.welder_id) : '';
    const certificateValue = q && q.certificate_no ? q.certificate_no : '';
    let certificateCell = certificateValue ? escapeHtml(certificateValue) : '<span class="muted">‚Äî</span>';
    if(q && q.attachment && q.attachment.data){
      certificateCell += createAttachmentActionsHtml(q.attachment, { fallbackName: 'procedeu.pdf' });
    }
    tr.innerHTML = `
      <td>${escapeHtml(standardLabel)}</td>
      <td>${escapeHtml(q && q.process ? q.process : '')}</td>
      <td>${escapeHtml(q && q.position ? q.position : '')}</td>
      <td>${escapeHtml(q && q.p_number ? q.p_number : '')}</td>
      <td>${escapeHtml(q && q.thickness_range ? q.thickness_range : '')}</td>
      <td>${escapeHtml(q && q.product ? q.product : '')}</td>
      <td>${certificateCell}</td>
      <td>${ownerName ? escapeHtml(ownerName) : '<span class="muted">general</span>'}</td>
      <td><button class="btn ghost" data-id="${q.id}" data-action="del">»òterge</button></td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('button[data-action="del"]').forEach(button => {
    button.addEventListener('click', () => {
      const id = Number(button.getAttribute('data-id'));
      if(Number.isNaN(id)){
        return;
      }
      if(confirm('»òtergi acest procedeu omologat?')){
        removeQualification(id);
      }
    });
  });
  populateAuthorizationProcedureSelect();
}

function selectWelder(id){
  const company = getActiveCompany();
  const welder = company.welders.find(w => w.id === id);
  if(!welder){
    resetWelderForm();
    populateAuthorizationWelderSelect();
    populateProcedureWelderSelect();
    updateAuthorizationContext();
    loadAuthorizations();
    loadProcedures();
    loadWelders();
    closeWelderModal();
    return;
  }
  if(activeView !== 'welders'){
    setActiveView('welders', { subview: 'welders' });
  } else if(activeWeldersSubview !== 'welders'){
    setWeldersSubview('welders');
  }
  selectedWelder = welder;
  selectedWelderPosition = getWelderPosition(welder.id);
  fillWelderForm(welder);
  openWelderModal('edit');
  updateAuthorizationContext();
  loadAuthorizations();
  loadProcedures();
  loadWelders();
  loadAuthorizationDossier();
}

function refreshAllFromStorage(){
  const selectedId = selectedWelder ? selectedWelder.id : null;
  const previousCompanyId = state.activeCompanyId;
  state = loadState();
  ensureStateStandards();
  syncStandardsFromState();
  ensureGeneralSettings();
  renderGeneralSettings();
  restartInactivityTimer();
  if(state.companies.length === 0){
    const fallback = createEmptyCompany(state.nextCompanyId || 1, 'Companie implicitƒÉ');
    state.companies.push(fallback);
    state.activeCompanyId = fallback.id;
    state.nextCompanyId = fallback.id + 1;
  }
  archiveVisible = false;
  if(!state.companies.some(company => company.id === previousCompanyId)){
    state.activeCompanyId = state.companies[0].id;
  } else {
    state.activeCompanyId = previousCompanyId;
  }
  populateCompanySelector();
  renderCompanySettings();
  updateHomeDashboard();
  renderAuthStandardTabs();
  renderStandardManagerList();
  const company = getActiveCompany();
  if(selectedId && company.welders.some(w => w.id === selectedId)){
    selectWelder(selectedId);
  } else {
    resetWelderForm();
    closeWelderModal();
  }
  loadWelders();
  populateAuthorizationWelderSelect();
  populateAuthorizationProcedureSelect();
  populateProcedureWelderSelect();
  populatePansonSelect();
  updateAuthorizationContext();
  loadAuthorizations();
  loadProcedures();
  renderArchiveList();
  updateTopbarCompanyLogo();
  loadAuthorizationDossier();
  loadProcedureDossier();
}

window.addEventListener('DOMContentLoaded', () => {
  initAuthentication();
  renderGeneralSettings();
  document.body.addEventListener('click', event => {
    const closeModalTrigger = event.target.closest('[data-action="close-welder-modal"]');
    if(closeModalTrigger){
      event.preventDefault();
      closeWelderModal();
      return;
    }
    const closeBrandingTrigger = event.target.closest('[data-action="close-branding-modal"]');
    if(closeBrandingTrigger){
      event.preventDefault();
      closeBrandingModal();
      return;
    }
    const trigger = event.target.closest('[data-attachment-view]');
    if(trigger){
      const attachmentId = trigger.getAttribute('data-attachment-view');
      const attachment = getAttachmentById(attachmentId);
      if(!attachment){
        alert('Documentul nu a putut fi gƒÉsit.');
      } else {
        const name = trigger.getAttribute('data-attachment-name') || attachment.name || 'Document';
        openDocumentViewer(attachment, name);
      }
      event.preventDefault();
      return;
    }
    if(event.target.matches('[data-action="close-viewer"]')){
      closeDocumentViewer();
    }
  });
  const viewer = document.getElementById('document_viewer');
  if(viewer){
    viewer.addEventListener('click', event => {
      if(event.target === viewer){
        closeDocumentViewer();
      }
    });
  }
  const inactivityInput = document.getElementById('general_inactivity_minutes');
  if(inactivityInput){
    inactivityInput.addEventListener('change', () => {
      const applied = setGeneralInactivityMinutes(inactivityInput.value);
      inactivityInput.value = applied;
    });
  }
  const welderModal = document.getElementById('welder_modal');
  if(welderModal){
    welderModal.addEventListener('click', event => {
      if(event.target === welderModal){
        closeWelderModal();
      }
    });
  }
  const brandingModal = document.getElementById('branding_modal');
  if(brandingModal){
    brandingModal.addEventListener('click', event => {
      if(event.target === brandingModal){
        closeBrandingModal();
      }
    });
  }
  document.addEventListener('keydown', event => {
    if(event.key !== 'Escape'){
      return;
    }
    if(document.body.dataset.viewerOpen){
      closeDocumentViewer();
      event.preventDefault();
      return;
    }
    if(document.body.dataset.brandingModalOpen){
      closeBrandingModal();
      event.preventDefault();
      return;
    }
    if(document.body.dataset.welderModalOpen){
      closeWelderModal();
      event.preventDefault();
    }
  });
  populateCompanySelector();
  renderCompanySettings();
  updateHomeDashboard();
  const newWelderBtn = document.getElementById('btn_new_welder');
  if(newWelderBtn){
    newWelderBtn.addEventListener('click', () => {
      resetWelderForm();
      openWelderModal('create');
    });
  }
  document.getElementById('btn_save_welder').addEventListener('click', saveWelder);
  const addAuthorizationBtn = document.getElementById('btn_add_authorization');
  if(addAuthorizationBtn){
    addAuthorizationBtn.addEventListener('click', addAuthorization);
  }
  const refreshAuthorizationBtn = document.getElementById('btn_refresh_authorizations');
  if(refreshAuthorizationBtn){
    refreshAuthorizationBtn.addEventListener('click', refreshAllFromStorage);
  }
  const addProcedureBtn = document.getElementById('btn_add_procedure');
  if(addProcedureBtn){
    addProcedureBtn.addEventListener('click', addProcedure);
  }
  const refreshProcedureBtn = document.getElementById('btn_refresh_procedures');
  if(refreshProcedureBtn){
    refreshProcedureBtn.addEventListener('click', refreshAllFromStorage);
  }
  const reportWeldersBtn = document.getElementById('btn_report_welders');
  if(reportWeldersBtn){
    reportWeldersBtn.addEventListener('click', () => generatePdfReport('welders'));
  }
  const reportAuthBtn = document.getElementById('btn_report_authorizations');
  if(reportAuthBtn){
    reportAuthBtn.addEventListener('click', () => generatePdfReport('authorizations'));
  }
  const reportProceduresBtn = document.getElementById('btn_report_procedures');
  if(reportProceduresBtn){
    reportProceduresBtn.addEventListener('click', () => generatePdfReport('procedures'));
  }
  document.getElementById('btn_export_state').addEventListener('click', exportState);
  const importInput = document.getElementById('input_import_state');
  if(importInput){
    importInput.addEventListener('change', handleImportStateFile);
  }
  const importBtn = document.getElementById('btn_import_state');
  if(importBtn){
    importBtn.addEventListener('click', () => {
      if(importInput){
        importInput.click();
      }
    });
  }
  const addCompanyBtn = document.getElementById('btn_add_company');
  if(addCompanyBtn){
    addCompanyBtn.addEventListener('click', handleAddCompany);
  }
  const companySelect = document.getElementById('company_selector');
  if(companySelect){
    companySelect.addEventListener('change', event => {
      const value = event.target.value;
      if(!value){
        return;
      }
      const numeric = Number(value);
      if(Number.isNaN(numeric)){
        return;
      }
      setActiveCompany(numeric);
    });
  }
  const searchInput = document.getElementById('welder_search');
  if(searchInput){
    searchInput.addEventListener('input', event => {
      welderSearchTerm = event.target.value || '';
      loadWelders();
    });
  }
  document.querySelectorAll('.nav-button').forEach(button => {
    button.addEventListener('click', () => {
      const view = button.getAttribute('data-view');
      if(view){
        setActiveView(view);
      }
    });
  });
  const weldersMenuButton = document.getElementById('welders_menu_welders');
  if(weldersMenuButton){
    weldersMenuButton.addEventListener('click', () => setWeldersSubview('welders'));
  }
  const pansoaneMenuButton = document.getElementById('welders_menu_pansoane');
  if(pansoaneMenuButton){
    pansoaneMenuButton.addEventListener('click', () => setWeldersSubview('pansoane'));
  }
  document.querySelectorAll('[data-subview-back]').forEach(button => {
    button.addEventListener('click', () => {
      const target = button.getAttribute('data-subview-back') || 'menu';
      setWeldersSubview(target);
    });
  });
  const manageStandardsBtn = document.getElementById('btn_manage_standards');
  if(manageStandardsBtn){
    manageStandardsBtn.addEventListener('click', () => toggleStandardManager());
  }
  const addStandardBtn = document.getElementById('btn_add_standard');
  if(addStandardBtn){
    addStandardBtn.addEventListener('click', addAuthorizationStandard);
  }
  const closeStandardManagerBtn = document.getElementById('btn_close_standard_manager');
  if(closeStandardManagerBtn){
    closeStandardManagerBtn.addEventListener('click', () => toggleStandardManager(false));
  }
  const authStandardSelect = document.getElementById('auth_standard');
  if(authStandardSelect){
    authStandardSelect.addEventListener('change', updateAuthorizationFieldLabels);
  }
  const authWelderSelect = document.getElementById('auth_welder_select');
  if(authWelderSelect){
    authWelderSelect.addEventListener('change', event => {
      const value = event.target.value;
      if(!value){
        selectedWelder = null;
        selectedWelderPosition = null;
        resetWelderForm();
        updateAuthorizationContext();
        loadAuthorizations();
        return;
      }
      const id = Number(value);
      if(Number.isNaN(id)){
        return;
      }
      selectWelder(id);
    });
  }
  const authProcedureSelect = document.getElementById('auth_procedure_select');
  if(authProcedureSelect){
    authProcedureSelect.addEventListener('change', handleAuthorizationProcedureChange);
  }
  const archiveSearch = document.getElementById('archive_search');
  if(archiveSearch){
    archiveSearch.addEventListener('input', event => {
      archiveSearchTerm = event.target.value || '';
      renderArchiveList();
    });
  }
  const archiveToggle = document.getElementById('toggle_archive');
  if(archiveToggle){
    archiveToggle.addEventListener('click', () => {
      if(archiveToggle.disabled){
        return;
      }
      archiveVisible = !archiveVisible;
      updateArchiveVisibility();
    });
  }
  const pansonToggle = document.getElementById('toggle_panson_archive');
  if(pansonToggle){
    pansonToggle.addEventListener('click', () => {
      if(pansonToggle.disabled){
        return;
      }
      pansonArchiveVisible = !pansonArchiveVisible;
      updatePansonArchiveVisibility();
    });
  }
  const addPansonBtn = document.getElementById('btn_add_panson');
  if(addPansonBtn){
    addPansonBtn.addEventListener('click', addPanson);
  }
  const newAuthDossierBtn = document.getElementById('btn_new_auth_dossier');
  if(newAuthDossierBtn){
    newAuthDossierBtn.addEventListener('click', handleCreateAuthorizationDossier);
  }
  const dossierSettingsBtn = document.getElementById('btn_auth_dossier_settings');
  if(dossierSettingsBtn){
    dossierSettingsBtn.addEventListener('click', toggleAuthorizationDossierSettingsPanel);
  }
  const addDossierRowBtn = document.getElementById('btn_add_dossier_row');
  if(addDossierRowBtn){
    addDossierRowBtn.addEventListener('click', handleAddAuthorizationDossierRow);
  }
  const deleteDossierBtn = document.getElementById('btn_delete_auth_dossier');
  if(deleteDossierBtn){
    deleteDossierBtn.addEventListener('click', handleDeleteAuthorizationDossier);
  }
  const previewDossierBtn = document.getElementById('btn_preview_auth_dossier_pdf');
  if(previewDossierBtn){
    previewDossierBtn.addEventListener('click', previewAuthorizationDossierPdf);
  }
  const saveDossierBtn = document.getElementById('btn_save_auth_dossier_pdf');
  if(saveDossierBtn){
    saveDossierBtn.addEventListener('click', saveAuthorizationDossierPdf);
  }
  const generateDossierBtn = document.getElementById('btn_generate_auth_dossier_pdf');
  if(generateDossierBtn){
    generateDossierBtn.addEventListener('click', generateAuthorizationDossierPdf);
  }
  const numberingCheckbox = document.getElementById('auth_dossier_page_numbers');
  if(numberingCheckbox){
    numberingCheckbox.addEventListener('change', handleAuthorizationDossierPageNumberToggle);
  }
  const dossierLetterField = document.getElementById('auth_dossier_letter');
  if(dossierLetterField){
    dossierLetterField.addEventListener('input', event => updateAuthorizationDossierLetter(event.target.value));
  }
  document.querySelectorAll('[data-letter-align]').forEach(button => {
    button.addEventListener('click', () => {
      const align = button.getAttribute('data-letter-align');
      updateAuthorizationDossierLetterStyle({ align });
    });
  });
  const letterBoldBtn = document.getElementById('btn_letter_bold');
  if(letterBoldBtn){
    letterBoldBtn.addEventListener('click', () => {
      const company = getActiveCompany();
      const dossier = getActiveAuthorizationDossier(company);
      if(!dossier){
        return;
      }
      const style = ensureDossierLetterStyle(dossier);
      updateAuthorizationDossierLetterStyle({ bold: !style.bold });
    });
  }
  const letterSizeInput = document.getElementById('auth_letter_size');
  if(letterSizeInput){
    letterSizeInput.addEventListener('change', event => {
      updateAuthorizationDossierLetterStyle({ size: event.target.value });
    });
  }
  const addCustomStepBtn = document.getElementById('btn_add_custom_step');
  if(addCustomStepBtn){
    addCustomStepBtn.addEventListener('click', handleAddCustomStep);
  }
  const customStepsList = document.getElementById('auth_custom_steps_list');
  if(customStepsList){
    customStepsList.addEventListener('click', handleCustomStepClick);
    customStepsList.addEventListener('change', handleCustomStepFileChange);
  }
  const addBaseMaterialBtn = document.getElementById('btn_add_base_material_doc');
  if(addBaseMaterialBtn){
    addBaseMaterialBtn.addEventListener('click', () => handleAddMaterialDoc('base'));
  }
  const addFillerMaterialBtn = document.getElementById('btn_add_filler_material_doc');
  if(addFillerMaterialBtn){
    addFillerMaterialBtn.addEventListener('click', () => handleAddMaterialDoc('filler'));
  }
  const addProcDocBtn = document.getElementById('btn_add_proc_dossier');
  if(addProcDocBtn){
    addProcDocBtn.addEventListener('click', addProcedureDossierDocument);
  }
  const refreshProcDocBtn = document.getElementById('btn_refresh_proc_dossier');
  if(refreshProcDocBtn){
    refreshProcDocBtn.addEventListener('click', () => loadProcedureDossier());
  }
  const pansonSelect = document.getElementById('w_panson');
  if(pansonSelect){
    pansonSelect.addEventListener('change', event => {
      const value = event.target.value;
      const manualInput = document.getElementById('w_code_manual');
      if(!manualInput){
        return;
      }
      if(!value){
        return;
      }
      const company = getActiveCompany();
      const panson = company.pansoane.find(entry => entry && String(entry.id) === String(value));
      if(panson && panson.code){
        manualInput.value = panson.code;
      }
    });
  }
  renderAuthStandardTabs();
  renderStandardManagerList();
  initSubTabs('auth_tabs');
  initSubTabs('proc_tabs');
  resetWelderForm();
  loadWelders();
  loadProcedures();
  loadPansoane();
  populateAuthorizationWelderSelect();
  populateAuthorizationProcedureSelect();
  populateProcedureWelderSelect();
  populatePansonSelect();
  updateAuthorizationContext();
  renderArchiveList();
  updatePansonArchiveVisibility();
  setActiveView('home');
  updateTopbarCompanyLogo();
  loadAuthorizationDossier();
  loadProcedureDossier();
});

window.addEventListener('storage', event => {
  if(event.key === STORAGE_KEY){
    refreshAllFromStorage();
  }
});
</script>
</body>
</html>
